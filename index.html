<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حرقاسة HARGASA GAME</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for audio effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* Base font and direction for Arabic */
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            text-align: right;
        }
        /* Custom animation for list items */
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInFromBottom 0.5s ease-out forwards;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4a90e2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for the copy button */
        .copy-button {
            background-color: #4CAF50; color: white; padding: 10px 15px;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 0.9em; margin-top: 10px; transition: background-color 0.3s ease;
        }
        .copy-button:hover { background-color: #45a049; }
        /* Style for the QR code container */
        #qrcode {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 1rem; min-height: 128px;
        }
        /* Multiselect styles */
        .multiselect-container { position: relative; width: 100%; }
        .multiselect-dropdown {
            border: 2px solid #e2e8f0; border-radius: 0.5rem; background-color: #f9fafb;
            max-height: 150px; overflow-y: auto; position: absolute;
            width: 100%; z-index: 10; margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .multiselect-dropdown label {
            display: block; padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s;
        }
        .multiselect-dropdown label:hover { background-color: #e2e8f0; }
        .multiselect-selected-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .tag {
            background-color: #a78bfa; color: white; padding: 0.25rem 0.75rem;
            border-radius: 9999px; font-size: 0.875rem; display: flex;
            align-items: center; gap: 0.25rem;
        }
        .tag-remove { cursor: pointer; font-weight: bold; opacity: 0.7; transition: opacity 0.2s; }
        .tag-remove:hover { opacity: 1; }
        /* Points buttons styles */
        .points-button-group {
            display: flex; flex-wrap: wrap; gap: 8px;
            justify-content: center; align-items: center;
        }
        .points-button {
            padding: 8px 12px; border-radius: 8px; border: 2px solid #cbd5e0;
            background-color: #f8fafc; color: #4a5568; font-weight: bold;
            cursor: pointer; transition: all 0.2s ease;
        }
        .points-button.selected {
            background-color: #6366f1; color: white; border-color: #6366f1;
            transform: scale(1.05); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .points-button.used {
            background-color: #e2e8f0; color: #94a3b8; border-color: #cbd5e0;
            cursor: not-allowed; opacity: 0.8; text-decoration: line-through;
        }
        .points-button:not(.selected):hover { background-color: #e2e8f0; border-color: #a0aec0; }
        .points-button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 min-h-screen flex flex-col items-center justify-center p-4 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center text-white text-xl">
            <div class="loading-spinner mb-4"></div>
            جاري التحميل...
        </div>
    </div>

    <div id="game-countdown-screen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center text-yellow-400 text-9xl font-extrabold z-50 hidden">
        <span id="countdown-timer-display">5</span>
    </div>

    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full flex flex-col items-center relative overflow-hidden">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 text-center leading-tight">لعبة حرقاسة HARGASA GAME <i class="fas fa-users text-blue-500"></i></h1>
        <p class="text-lg text-gray-600 mb-8 text-center" id="game-description">اختر دورك: إما مضيف لإنشاء غرفة، أو لاعب للانضمام إلى غرفة موجودة.</p>

        <div id="role-selection-screen" class="w-full flex flex-col items-center space-y-6">
            <button id="create-host-button" class="w-full md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-crown"></i> إنشاء غرفة (مضيف)
            </button>
            <button id="join-player-button" class="w-full md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-gamepad"></i> الانضمام إلى غرفة (لاعب)
            </button>
        </div>

        <div id="host-setup-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">إعداد غرفة اللعب</h2>
            <div class="w-full mb-6">
                <label for="host-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2">اسمك المستعار (المضيف):</label>
                <input type="text" id="host-nickname-input" placeholder="اسم المضيف" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
            </div>
            <div class="w-full mb-6">
                <label for="quiz-category-input" class="block text-xl font-semibold text-gray-700 mb-2">اختر فئات الأسئلة:</label>
                <div class="multiselect-container">
                    <input type="text" id="quiz-category-input" readonly placeholder="انقر هنا لاختيار الفئات..." class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 cursor-pointer">
                    <div id="quiz-category-dropdown" class="multiselect-dropdown hidden"></div>
                </div>
                <div id="selected-categories-tags" class="multiselect-selected-tags"></div>
            </div>
            <div class="w-full mb-6">
                <label for="total-questions-per-game-select" class="block text-xl font-semibold text-gray-700 mb-2">عدد الأسئلة:</label>
                <select id="total-questions-per-game-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="5">5 أسئلة</option> <option value="10">10 أسئلة</option> <option value="15">15 سؤال</option>
                    <option value="20">20 سؤال</option> <option value="30">30 سؤال</option>
                </select>
            </div>
            <div class="w-full mb-6">
                <label for="time-limit-select" class="block text-xl font-semibold text-gray-700 mb-2">الوقت لكل سؤال (بالثواني):</label>
                <select id="time-limit-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="15">15 ثانية</option> <option value="20">20 ثانية</option> <option value="30">30 ثانية</option>
                    <option value="45">45 ثانية</option> <option value="60">60 ثانية</option>
                </select>
            </div>
            <button id="create-game-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3">
                <i class="fas fa-plus-circle"></i> إنشاء اللعبة
            </button>
        </div>

        <div id="waiting-room-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4" id="waiting-room-title">انتظر انضمام اللاعبين...</h2>
            <p class="text-xl text-gray-700 mb-6">شارك هذا الرابط مع أصدقائك للانضمام:</p>
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 flex flex-col items-center">
                <span id="game-link-display" class="text-md md:text-xl font-medium text-blue-600 break-all text-center"></span>
                <div id="qrcode" class="mb-2 p-2 bg-white rounded-lg shadow-md flex justify-center items-center">
                    <div id="qrcode-fallback-message" class="text-gray-500 text-sm text-center"></div>
                </div>
                <button id="copy-link-button" class="copy-button mt-4">انسخ الرابط</button>
            </div>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">اللاعبون المنضمون:</h3>
            <ul id="joined-players-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 h-40 overflow-y-auto shadow-inner text-lg"></ul>
            <button id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 hidden">
                <i class="fas fa-play"></i> بدء اللعب!
            </button>
        </div>

        <div id="join-game-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">الانضمام إلى غرفة اللعب</h2>
            <div class="w-full mb-6">
                <label for="game-code-input" class="block text-xl font-semibold text-gray-700 mb-2">أدخل رمز الغرفة:</label>
                <input type="text" id="game-code-input" placeholder="مثال: 123" class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 uppercase text-center tracking-widest">
            </div>
             <div class="w-full mb-6">
                <label for="player-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2">أدخل اسمك المستعار:</label>
                <input type="text" id="player-nickname-input" placeholder="اسمك" class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-center">
            </div>
            <button id="join-room-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3">
                <i class="fas fa-door-open"></i> الانضمام
            </button>
        </div>

        <div id="game-play-screen" class="w-full hidden">
            <p class="text-2xl font-bold text-gray-800 mb-4 text-center">الفئة: <span id="game-category" class="text-indigo-600"></span></p>
            <div class="bg-blue-100 p-4 rounded-lg shadow-md mb-6 w-full text-center">
                <p class="text-2xl font-extrabold text-gray-900" id="game-question"></p>
            </div>
            <div class="flex flex-col md:flex-row justify-around items-center w-full mb-8 space-y-4 md:space-y-0 md:space-x-4 rtl:md:space-x-reverse">
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-hourglass-half text-blue-500"></i>
                    <span>الوقت: <span id="game-timer" class="text-blue-600">--</span></span>
                </div>
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span>نقاطك: <span id="player-score" class="text-yellow-600">0</span></span>
                </div>
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-question-circle text-purple-500"></i>
                    <span>السؤال: <span id="question-counter" class="text-purple-600">-- / --</span></span>
                </div>
            </div>
            <div class="flex items-center flex-wrap gap-2 w-full mb-4">
                <input type="text" id="game-guess-input" placeholder="اكتب إجابتك هنا..." class="flex-grow p-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                <button id="submit-answer-button" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 flex-shrink-0">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
            </div>
            <div class="w-full mb-6">
                <label class="block text-xl font-semibold text-gray-700 mb-2 text-center">راهن بالنقاط:</label>
                <div id="points-button-group" class="points-button-group"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">إجاباتك الصحيحة (لهذا السؤال):</h3>
                    <ul id="player-correct-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2"></ul>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3">الإجابات المشتركة (لهذا السؤال):</h3>
                    <ul id="shared-round-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2"></ul>
                </div>
            </div>
            <div id="host-gameplay-controls" class="w-full flex flex-col items-center gap-4 mt-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">حالة إجابة اللاعبين:</h3>
                <ul id="host-submission-status-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 mb-4 shadow-inner text-base max-h-32 overflow-y-auto"></ul>
                <button id="end-question-early-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all">
                    <i class="fas fa-flag-checkered"></i> إنهاء السؤال الآن
                </button>
            </div>
            <button id="player-exit-button-gameplay" class="w-full bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all mt-6 hidden">
                <i class="fas fa-sign-out-alt"></i> الخروج من اللعبة
            </button>
        </div>

        <div id="question-results-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">نتائج السؤال!</h2>
            <p class="text-xl text-gray-700 mb-6 text-center">الفئة: <span id="results-category" class="font-bold text-indigo-600"></span></p>
            <p class="text-2xl font-semibold text-gray-800 mb-4 text-center">السؤال: <span id="results-question" class="font-bold text-gray-900"></span></p>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الإجابة الصحيحة:</h3>
            <ul id="round-correct-answers-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 max-h-64 overflow-y-auto shadow-inner text-lg list-disc pr-6"></ul>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">أداء اللاعبين:</h3>
            <ul id="question-player-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto"></ul>
            <div id="question-results-host-controls" class="w-full flex flex-col items-center gap-4 hidden">
                <button id="next-question-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-forward"></i> السؤال التالي
                </button>
                <button id="end-game-final-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-times-circle"></i> إنهاء اللعبة
                </button>
            </div>
            <button id="player-exit-button-results" class="w-full bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all mt-6 hidden">
                <i class="fas fa-sign-out-alt"></i> الخروج من اللعبة
            </button>
        </div>

        <div id="game-end-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center" id="end-title">النتائج النهائية!</h2>
            <p class="text-xl text-gray-600 mb-6 text-center" id="end-message"></p>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الترتيب النهائي:</h3>
            <ul id="final-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto"></ul>
            <button id="start-new-round-same-room-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3 mb-4 hidden">
                <i class="fas fa-sync-alt"></i> بدء جولة جديدة بنفس الغرفة
            </button>
            <button id="play-again-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                <i class="fas fa-redo"></i> العب مرة أخرى (غرفة جديدة)
            </button>
        </div>

        <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-40 hidden transition-opacity duration-300 ease-out opacity-0">
            <div class="bg-white rounded-xl p-8 text-center shadow-xl transform scale-90 transition-transform duration-300 ease-out">
                <h2 id="custom-message-title" class="text-3xl font-bold text-gray-900 mb-4"></h2>
                <p id="custom-message-content" class="text-xl text-gray-700 mb-6"></p>
                <div id="custom-message-buttons" class="flex justify-center gap-4"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // Global variables
        let app, db, auth, userId, userNickname, appId;
        let gameId = null;
        let isHost = false;
        let gameSnapshotUnsubscribe = null;
        let playersSnapshotUnsubscribe = null;
        let timerInterval = null;
        let selectedPointsBet = 1;
        let userUsedPointsBets = [];
        let currentQuestionSoundInterval = null;
        let soundStarted = false;

        // ALL QUIZ CATEGORIES RESTORED
        const quizzes = [
            {
                category: "عواصم الدول العربية",
                questions: [
                    { questionText: "ما هي عاصمة تونس؟", displayAnswer: "تونس", correctAnswers: ["تونس", "tunis"] },
                    { questionText: "ما هي عاصمة مصر؟", displayAnswer: "القاهرة", correctAnswers: ["القاهرة", "cairo"] },
                    { questionText: "ما هي عاصمة السعودية؟", displayAnswer: "الرياض", correctAnswers: ["الرياض", "riyadh"] },
                    { questionText: "ما هي عاصمة العراق؟", displayAnswer: "بغداد", correctAnswers: ["بغداد", "baghdad"] },
                    { questionText: "ما هي عاصمة سوريا؟", displayAnswer: "دمشق", correctAnswers: ["دمشق", "damascus"] },
                    { questionText: "ما هي عاصمة الأردن؟", displayAnswer: "عمان", correctAnswers: ["عمان", "amman"] },
                    { questionText: "ما هي عاصمة لبنان؟", displayAnswer: "بيروت", correctAnswers: ["بيروت", "beirut"] },
                    { questionText: "ما هي عاصمة المغرب؟", displayAnswer: "الرباط", correctAnswers: ["الرباط", "rabat"] },
                    { questionText: "ما هي عاصمة الجزائر؟", displayAnswer: "الجزائر", correctAnswers: ["الجزائر", "algiers"] },
                    { questionText: "ما هي عاصمة السودان؟", displayAnswer: "الخرطوم", correctAnswers: ["الخرطوم", "khartoum"] },
                    { questionText: "ما هي عاصمة اليمن؟", displayAnswer: "صنعاء", correctAnswers: ["صنعاء", "sanaa"] },
                    { questionText: "ما هي عاصمة الإمارات؟", displayAnswer: "أبو ظبي", correctAnswers: ["ابوظبي", "أبو ظبي", "abu dhabi"] },
                    { questionText: "ما هي عاصمة قطر؟", displayAnswer: "الدوحة", correctAnswers: ["الدوحة", "doha"] },
                    { questionText: "ما هي عاصمة الكويت؟", displayAnswer: "الكويت", correctAnswers: ["الكويت", "kuwait"] },
                    { questionText: "ما هي عاصمة البحرين؟", displayAnswer: "المنامة", correctAnswers: ["المنامة", "manama"] },
                    { questionText: "ما هي عاصمة الصومال؟", displayAnswer: "مقديشو", correctAnswers: ["مقديشو", "mogadishu"] },
                    { questionText: "ما هي عاصمة جيبوتي؟", displayAnswer: "جيبوتي", correctAnswers: ["جيبوتي", "djibouti"] },
                    { questionText: "ما هي عاصمة جزر القمر؟", displayAnswer: "موروني", correctAnswers: ["موروني", "moroni"] },
                    { questionText: "ما هي عاصمة ليبيا؟", displayAnswer: "طرابلس", correctAnswers: ["طرابلس", "tripoli"] },
                    { questionText: "ما هي عاصمة موريتانيا؟", displayAnswer: "نواكشوط", correctAnswers: ["نواكشوط", "nouakchott"] },
                    { questionText: "ما هي عاصمة سلطنة عمان؟", displayAnswer: "مسقط", correctAnswers: ["مسقط", "muscat"] },
                    { questionText: "ما هي عاصمة فلسطين؟", displayAnswer: "القدس", correctAnswers: ["القدس", "jerusalem"] }
                ]
            },
            {
                category: "الفواكه",
                questions: [
                    { questionText: "فاكهة حمراء وصغيرة غالباً ما تستخدم في الحلويات؟", displayAnswer: "فراولة", correctAnswers: ["فراولة", "كرز", "توت"] },
                    { questionText: "فاكهة صفراء تنمو في مجموعات وغنية بالبوتاسيوم؟", displayAnswer: "موز", correctAnswers: ["موز"] },
                    { questionText: "فاكهة برتقالية اللون، غنية بفيتامين سي؟", displayAnswer: "برتقال", correctAnswers: ["برتقال", "يوسفي", "مانجو"] },
                    { questionText: "فاكهة استوائية كبيرة ذات قشرة خشنة ولحم أصفر حلو؟", displayAnswer: "أناناس", correctAnswers: ["أناناس"] },
                    { questionText: "فاكهة صيفية كبيرة الحجم، خضراء من الخارج وحمراء من الداخل؟", displayAnswer: "بطيخ", correctAnswers: ["بطيخ", "دلاع", "دلاعة", "بطيخة"] }
                ]
            },
            {
                category: "عواصم دول أوروبية",
                questions: [
                    { questionText: "ما هي عاصمة ألمانيا؟", displayAnswer: "برلين", correctAnswers: ["برلين", "berlin"] },
                    { questionText: "ما هي عاصمة فرنسا؟", displayAnswer: "باريس", correctAnswers: ["باريس", "paris"] },
                    { questionText: "ما هي عاصمة إيطاليا؟", displayAnswer: "روما", correctAnswers: ["روما", "rome"] },
                    { questionText: "ما هي عاصمة إسبانيا؟", displayAnswer: "مدريد", correctAnswers: ["مدريد", "madrid"] },
                    { questionText: "ما هي عاصمة المملكة المتحدة؟", displayAnswer: "لندن", correctAnswers: ["لندن", "london"] }
                ]
            },
            {
                category: "أمثال شعبية تونسية",
                questions: [
                    { questionText: "كمل المثل: إلّي في كرشه التبن...", displayAnswer: "يخاف من النار", correctAnswers: ["يخاف من النار"] },
                    { questionText: "كمل المثل: الباب إلّي يجيك منّو الريح...", displayAnswer: "سدّو واستريح", correctAnswers: ["سدو واستريح", "سده واستريح"] },
                    { questionText: "كمل المثل: طاحت الصمعة...", displayAnswer: "علّقو الحجام", correctAnswers: ["علقو الحجام", "علقوا الحجام"] },
                    { questionText: "كمل المثل: الجمل ما يشوفش...", displayAnswer: "حدبتو", correctAnswers: ["حدبته", "حدبتو"] },
                    { questionText: "كمل المثل: كي تطيح البقرة...", displayAnswer: "يكثروا سكاكينها", correctAnswers: ["يكثروا سكاكينها", "تكثر سكاكينها"] }
                ]
            },
            {
                category: "ثقافة عامة",
                questions: [
                    { questionText: "ما هو أسرع حيوان بري في العالم؟", displayAnswer: "الفهد", correctAnswers: ["الفهد", "فهد الشيتا"] },
                    { questionText: "كم عدد الكواكب في المجموعة الشمسية؟", displayAnswer: "ثمانية", correctAnswers: ["8", "ثمانية"] },
                    { questionText: "من هو مؤلف رواية 'ألف ليلة وليلة'؟", displayAnswer: "مجهول", correctAnswers: ["مجهول", "غير معروف"] },
                    { questionText: "ما هو أكبر محيط في العالم؟", displayAnswer: "المحيط الهادئ", correctAnswers: ["الهادئ", "الهادي"] }
                ]
            },
            {
                category: "اسئلة الشلة", // RESTORED
                questions: [
                    { questionText: "كي نقولو كنترول شنوة يجي للبالك ؟", displayAnswer: "كعبورة", correctAnswers: ["لمكعبر", "كعبر" , "ka3boura" , "كعبورة"] },
                    { questionText: "شكون الي يفلم برشا في الشلة و يحب يجيبها يعرف كل شي ؟", displayAnswer: "ولد الورغي", correctAnswers: ["lou", "لؤي" , "louay" , "ولد الورغي"] },
                    { questionText: "قلك عمرك ما ترمي القزاز في طريق الرجالة ...", displayAnswer: "يجي نهار و تقصدهم حفيان", correctAnswers: ["يجي نهار وتقصدهم حفيان", "واطططططط"] },
                    { questionText: "شكون انيك واحد في الشلة ؟", displayAnswer: "كلكم كيف كيف", correctAnswers: ["الكل", "hama" , "الزعيم" , "za3im" , "louay" , "ka3boura" , "lahdir" , "hayder"] },
                    { questionText: "رسلان علاه معادش يقعد معانا ؟", displayAnswer: "تبع البنات", correctAnswers: ["nour", "نور" , "miboun" , "ميبون" , "تبع لبنات" , "wabna"] }
                ]
            },
            {
                category: "حيوانات الغابة", // RESTORED
                questions: [
                    { questionText: "ملك الغابة؟", displayAnswer: "أسد", correctAnswers: ["أسد", "اسد"] },
                    { questionText: "حيوان مخطط بالأبيض والأسود يشبه الحصان؟", displayAnswer: "حمار وحشي", correctAnswers: ["حمار وحشي", "حماروحشي"] },
                    { questionText: "أكبر حيوان بري على وجه الأرض؟", displayAnswer: "فيل", correctAnswers: ["فيل", "الفيل"] },
                    { questionText: "حيوان طويل العنق ذو بقع بنية؟", displayAnswer: "زرافة", correctAnswers: ["زرافة", "الزرافة"] }
                ]
            },
            {
                category: "أسئلة تونسية", // RESTORED
                questions: [
                    { questionText: "شنوة عاصمة تونس؟", displayAnswer: "تونس", correctAnswers: ["تونس", "tunis", "tounes"] },
                    { questionText: "شنوة اسم العملة التونسية؟", displayAnswer: "دينار", correctAnswers: ["دينار", "dinar"] },
                    { questionText: "شكون ربح كاس افريقيا 2004؟", displayAnswer: "تونس", correctAnswers: ["تونس", "المنتخب التونسي", "tounes"] },
                    { questionText: "شنوة اسم أطول واد في تونس؟", displayAnswer: "واد مجردة", correctAnswers: ["واد مجردة", "مجردة", "oued mejerdah"] },
                    { questionText: "شكون الرئيس الأول لتونس؟", displayAnswer: "الحبيب بورقيبة", correctAnswers: ["الحبيب بورقيبة", "بورقيبة", "bourguiba"] }
                ]
            }
        ];
        
        // --- Element Grabber ---
        const $ = (id) => document.getElementById(id);
        const loadingOverlay = $('loading-overlay'), roleSelectionScreen = $('role-selection-screen'),
              hostSetupScreen = $('host-setup-screen'), waitingRoomScreen = $('waiting-room-screen'),
              joinGameScreen = $('join-game-screen'), gamePlayScreen = $('game-play-screen'),
              questionResultsScreen = $('question-results-screen'), gameEndScreen = $('game-end-screen'),
              createHostButton = $('create-host-button'), joinPlayerButton = $('join-player-button'),
              timeLimitSelect = $('time-limit-select'), createGameButton = $('create-game-button'),
              gameLinkDisplay = $('game-link-display'), qrcodeDiv = $('qrcode'),
              qrcodeFallbackMessage = $('qrcode-fallback-message'), copyLinkButton = $('copy-link-button'),
              joinedPlayersList = $('joined-players-list'), startGameButton = $('start-game-button'),
              gameCodeInput = $('game-code-input'), playerNicknameInput = $('player-nickname-input'),
              joinRoomButton = $('join-room-button'), gameTimerDisplay = $('game-timer'),
              playerScoreDisplay = $('player-score'), gameCategoryDisplay = $('game-category'),
              gameQuestionDisplay = $('game-question'), pointsButtonGroup = $('points-button-group'),
              gameGuessInput = $('game-guess-input'), submitAnswerButton = $('submit-answer-button'),
              playerCorrectGuessesList = $('player-correct-guesses-list'), sharedRoundGuessesList = $('shared-round-guesses-list'),
              endQuestionEarlyButton = $('end-question-early-button'), resultsCategory = $('results-category'),
              resultsQuestion = $('results-question'), roundCorrectAnswersList = $('round-correct-answers-list'),
              questionPlayerScoresList = $('question-player-scores-list'), questionResultsHostControls = $('question-results-host-controls'),
              nextQuestionButton = $('next-question-button'), endGameFinalButton = $('end-game-final-button'),
              gameCountdownScreen = $('game-countdown-screen'), countdownTimerDisplay = $('countdown-timer-display'),
              questionCounterDisplay = $('question-counter'), hostSubmissionStatusList = $('host-submission-status-list'),
              hostGameplayControls = $('host-gameplay-controls'), endTitle = $('end-title'),
              endMessage = $('end-message'), finalScoresList = $('final-scores-list'),
              playAgainButton = $('play-again-button'), startNewRoundSameRoomButton = $('start-new-round-same-room-button'),
              playerExitButtonGameplay = $('player-exit-button-gameplay'), playerExitButtonResults = $('player-exit-button-results'),
              customMessageButtonsContainer = $('custom-message-buttons'), customMessageBox = $('custom-message-box'),
              customMessageTitle = $('custom-message-title'), customMessageContent = $('custom-message-content'),
              quizCategoryInput = $('quiz-category-input'), quizCategoryDropdown = $('quiz-category-dropdown'),
              selectedCategoriesTags = $('selected-categories-tags'), hostNicknameInput = $('host-nickname-input'),
              totalQuestionsPerGameSelect = $('total-questions-per-game-select');

        // --- Sound ---
        const synth = new Tone.Synth({ type: "sine", envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 } }).toDestination();
        function playTimerSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            synth.triggerAttackRelease("C5", "16n");
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            populatePointsButtons();
            initializeFirebase();
        });

        // --- Helper Functions ---
        function normalize(text) {
            if (typeof text !== 'string') return '';
            return text.toLowerCase().replace(/\s+/g, '').replace(/أ|إ|آ/g, 'ا').replace(/ى/g, 'ي').replace(/ة/g, 'ه').replace(/ؤ|أ/g, 'و').replace(/ئ/g, 'ي').replace(/[^a-z0-9\u0600-\u06FF]/g, '');
        }
        function similarity(s1, s2) {
            let longer = s1, shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength === 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            let costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue; lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }
        function isCorrectAnswer(playerAnswer, acceptedAnswers) {
            const normalizedPlayerAnswer = normalize(playerAnswer);
            return acceptedAnswers.some(ans => similarity(normalizedPlayerAnswer, normalize(ans)) >= 0.85);
        }

        // --- UI Functions ---
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }
        function showScreen(screenElement) {
            [roleSelectionScreen, hostSetupScreen, waitingRoomScreen, joinGameScreen, gamePlayScreen, questionResultsScreen, gameEndScreen, gameCountdownScreen].forEach(s => s.classList.add('hidden'));
            screenElement.classList.remove('hidden');
        }
        function showCustomMessageBox(title, content, options = {}) {
            customMessageTitle.textContent = title;
            customMessageContent.innerHTML = content;
            customMessageButtonsContainer.innerHTML = '';
            const buttonsToRender = options.buttons || [{ text: 'حسناً', callback: hideCustomMessageBox, className: 'bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-3 px-8 rounded-lg' }];
            buttonsToRender.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className;
                button.onclick = () => { if(btnConfig.callback) btnConfig.callback(); hideCustomMessageBox(); };
                customMessageButtonsContainer.appendChild(button);
            });
            customMessageBox.classList.remove('hidden', 'opacity-0');
            customMessageBox.firstElementChild.classList.remove('scale-90');
        }
        function hideCustomMessageBox() {
            customMessageBox.classList.add('opacity-0');
            customMessageBox.firstElementChild.classList.add('scale-90');
            setTimeout(() => customMessageBox.classList.add('hidden'), 300);
        }

        // --- Setup UI ---
        function setupQuizCategorySelection() {
            quizCategoryDropdown.innerHTML = '';
            quizzes.forEach((quiz, index) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = index; checkbox.className = 'ml-2';
                checkbox.checked = selectedQuizIndices.includes(index);
                label.append(checkbox, ` ${quiz.category}`);
                quizCategoryDropdown.appendChild(label);
                checkbox.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.value);
                    if (e.target.checked) !selectedQuizIndices.includes(idx) && selectedQuizIndices.push(idx);
                    else selectedQuizIndices = selectedQuizIndices.filter(i => i !== idx);
                    updateSelectedCategoriesTags();
                });
            });
            updateSelectedCategoriesTags();
        }
        function updateSelectedCategoriesTags() {
            selectedCategoriesTags.innerHTML = '';
            selectedQuizIndices.forEach(index => {
                const tag = document.createElement('span');
                tag.className = 'tag'; tag.textContent = quizzes[index].category;
                const removeBtn = document.createElement('span');
                removeBtn.className = 'tag-remove'; removeBtn.textContent = 'x';
                removeBtn.style.marginRight = '5px';
                removeBtn.onclick = () => {
                    selectedQuizIndices = selectedQuizIndices.filter(i => i !== index);
                    setupQuizCategorySelection();
                };
                tag.appendChild(removeBtn);
                selectedCategoriesTags.appendChild(tag);
            });
            quizCategoryInput.placeholder = selectedQuizIndices.length === 0 ? "انقر لاختيار الفئات..." : `تم اختيار ${selectedQuizIndices.length} فئة`;
        }
        function populatePointsButtons() {
            pointsButtonGroup.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.type = 'button'; button.className = 'points-button'; button.textContent = i;
                button.dataset.points = i;
                if (userUsedPointsBets.includes(i)) { button.disabled = true; button.classList.add('used'); }
                if (i === selectedPointsBet && !button.disabled) button.classList.add('selected');
                button.addEventListener('click', (e) => {
                    if (e.target.disabled) return;
                    const currentSelected = pointsButtonGroup.querySelector('.points-button.selected');
                    if (currentSelected) currentSelected.classList.remove('selected');
                    e.target.classList.add('selected');
                    selectedPointsBet = parseInt(e.target.dataset.points);
                });
                pointsButtonGroup.appendChild(button);
            }
            if (!pointsButtonGroup.querySelector('.points-button.selected')) {
                const firstAvailable = pointsButtonGroup.querySelector('.points-button:not(.used)');
                if (firstAvailable) { firstAvailable.classList.add('selected'); selectedPointsBet = parseInt(firstAvailable.dataset.points); }
            }
        }
        
        // --- Firebase Core ---
        async function initializeFirebase() {
            showLoading();
            try {
                const firebaseConfig = {
                   apiKey: "AIzaSyCwdZjTwrnjKZU_AilP5_GZJeEuUZjVcUY",
                   authDomain: "ka3boura-dbcf5.firebaseapp.com",
                   projectId: "ka3boura-dbcf5",
                   storageBucket: "ka3boura-dbcf5.appspot.com",
                   messagingSenderId: "1051115240747",
                   appId: "1:1051115240747:web:694751eef3173327f5596e"
                };
                appId = firebaseConfig.projectId;
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                await auth.signInAnonymously();
                auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        hideLoading();
                        const idFromUrl = new URLSearchParams(window.location.search).get('gameId');
                        if (idFromUrl) {
                            gameCodeInput.value = idFromUrl.toUpperCase();
                            playerNicknameInput.value = localStorage.getItem('playerNickname') || '';
                            if (playerNicknameInput.value) joinGame(idFromUrl, playerNicknameInput.value);
                            else showScreen(joinGameScreen);
                        } else showScreen(roleSelectionScreen);
                    } else showCustomMessageBox("خطأ", "فشل المصادقة مع الخادم.");
                });
            } catch (error) {
                hideLoading();
                showCustomMessageBox("خطأ فادح", `فشل تهيئة Firebase: ${error.message}`);
            }
        }

        // --- Game Flow ---
        function exitGame() {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe();
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe();
            clearInterval(timerInterval);
            clearInterval(currentQuestionSoundInterval);
            gameId = null; isHost = false; userUsedPointsBets = [];
            window.history.pushState({}, '', window.location.pathname);
            showScreen(roleSelectionScreen);
        }

        async function createGame() {
            showLoading();
            try {
                if (!hostNicknameInput.value.trim()) throw new Error("الرجاء إدخال اسمك المستعار.");
                if (selectedQuizIndices.length === 0) throw new Error("الرجاء اختيار فئة واحدة على الأقل.");
                
                gameId = await (async () => { let id, isUnique = false; while(!isUnique) { id = String(Math.floor(100 + Math.random() * 900)); const doc = await db.collection(`artifacts/${appId}/public/data/games`).doc(id).get(); if(!doc.exists) isUnique = true; } return id; })();

                isHost = true; userNickname = hostNicknameInput.value.trim();
                localStorage.setItem('playerNickname', userNickname);
                
                let allPossibleQuestions = [];
                selectedQuizIndices.forEach(catIndex => allPossibleQuestions.push(...quizzes[catIndex].questions.map(q => ({...q, category: quizzes[catIndex].category}))));
                for (let i = allPossibleQuestions.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [allPossibleQuestions[i], allPossibleQuestions[j]] = [allPossibleQuestions[j], allPossibleQuestions[i]]; }
                const quizSetForGame = allPossibleQuestions.slice(0, parseInt(totalQuestionsPerGameSelect.value));
                if (quizSetForGame.length === 0) throw new Error("الفئات المختارة لا تحتوي على أسئلة كافية.");

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                await gameRef.set({
                    hostId: userId, gamePhase: 'lobby', quizSet: quizSetForGame,
                    selectedCategoryIndices, timeLimitPerQuestion: parseInt(timeLimitSelect.value),
                    currentQuestionIndexInGame: 0, scoresReconciledForCurrentQuestion: false,
                });
                await gameRef.collection('players').doc(userId).set({
                    nickname: userNickname, score: 0, joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    hasSubmittedAnswer: false, usedPointsBets: []
                });
                
                const gameRoomLink = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                gameLinkDisplay.textContent = gameRoomLink;
                qrcodeDiv.innerHTML = ''; new QRCode(qrcodeDiv, { text: gameRoomLink, width: 128, height: 128 });
                copyLinkButton.onclick = () => navigator.clipboard.writeText(gameRoomLink).then(() => showCustomMessageBox("تم النسخ!", "تم نسخ رابط الغرفة."));
                
                listenToGameChanges(); listenToPlayers(); showScreen(waitingRoomScreen);
            } catch (error) { showCustomMessageBox("خطأ", error.message); } finally { hideLoading(); }
        }

        async function joinGame(code, nickname) {
            showLoading();
            try {
                if (!code || !nickname) throw new Error("يرجى إدخال الرمز والاسم.");
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(code);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) throw new Error("رمز اللعبة غير صحيح.");
                if (gameDoc.data().gamePhase === 'final_results') throw new Error("اللعبة قد انتهت.");
                
                gameId = code; userNickname = nickname;
                localStorage.setItem('playerNickname', nickname);
                isHost = gameDoc.data().hostId === userId;
                
                await gameRef.collection('players').doc(userId).set({ nickname, score: 0, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), hasSubmittedAnswer: false, usedPointsBets: [] }, { merge: true });
                
                window.history.pushState({}, '', `${window.location.pathname}?gameId=${gameId}`);
                gameLinkDisplay.textContent = `رمز الغرفة: ${gameId}`;
                qrcodeDiv.style.display = 'none'; copyLinkButton.style.display = 'none';
                
                listenToGameChanges(); listenToPlayers(); showScreen(waitingRoomScreen);
            } catch (error) { exitGame(); showCustomMessageBox("خطأ في الانضمام", error.message); } finally { hideLoading(); }
        }

        async function submitGuess() {
            if (gameGuessInput.disabled) return;
            const guess = gameGuessInput.value.trim();
            if (guess === '') return showCustomMessageBox("خطأ", "الرجاء كتابة إجابتك.");
            if (userUsedPointsBets.includes(selectedPointsBet)) return showCustomMessageBox("خطأ", `لقد راهنت بهذه القيمة (${selectedPointsBet}) من قبل.`);
            
            showLoading();
            try {
                const playerRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId);
                await playerRef.update({
                    playerSubmittedAnswer: guess, playerSelectedPoints: selectedPointsBet,
                    hasSubmittedAnswer: true, usedPointsBets: firebase.firestore.FieldValue.arrayUnion(selectedPointsBet)
                });
            } catch (error) { showCustomMessageBox("خطأ", "فشل إرسال الإجابة."); } finally { hideLoading(); }
        }

        // --- Realtime Listeners ---
        function listenToGameChanges() {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe();
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            gameSnapshotUnsubscribe = gameRef.onSnapshot((doc) => {
                if (!doc.exists) return exitGame();
                const gameData = doc.data(), gamePhase = gameData.gamePhase;
                
                questionCounterDisplay.textContent = `${gamePhase === 'lobby' || gamePhase === 'game_countdown' ? 0 : gameData.currentQuestionIndexInGame} / ${gameData.quizSet.length}`;

                if (gamePhase === 'lobby') {
                    showScreen(waitingRoomScreen);
                    userUsedPointsBets = []; populatePointsButtons();
                    if(isHost) startGameButton.textContent = "بدء اللعب!";
                } else if (gamePhase === 'game_countdown') {
                    showScreen(gameCountdownScreen);
                    let count = 5;
                    countdownTimerDisplay.textContent = count;
                    clearInterval(timerInterval);
                    timerInterval = setInterval(() => {
                        count--;
                        countdownTimerDisplay.textContent = count > 0 ? count : 'انطلق!';
                        if (count <= 0) clearInterval(timerInterval);
                    }, 1000);
                } else if (gamePhase === 'question_active') {
                    showScreen(gamePlayScreen);
                    gameCategoryDisplay.textContent = gameData.currentCategory;
                    gameQuestionDisplay.textContent = gameData.currentQuestionText;
                    
                    ['disabled', 'value'].forEach(p => gameGuessInput[p] = p === 'disabled' ? false : '');
                    submitAnswerButton.disabled = false;
                    playerCorrectGuessesList.innerHTML = ''; sharedRoundGuessesList.innerHTML = '';
                    
                    db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId).get().then(playerDoc => {
                        if(playerDoc.exists) userUsedPointsBets = playerDoc.data().usedPointsBets || [];
                        populatePointsButtons();
                        if(playerDoc.exists && playerDoc.data().hasSubmittedAnswer) {
                            gameGuessInput.disabled = true; submitAnswerButton.disabled = true;
                            pointsButtonGroup.querySelectorAll('button').forEach(b => b.disabled = true);
                        }
                    });
                    
                    if (isHost) { hostGameplayControls.classList.remove('hidden'); playerExitButtonGameplay.classList.add('hidden'); }
                    else { hostGameplayControls.classList.add('hidden'); playerExitButtonGameplay.classList.remove('hidden'); }

                    clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval); soundStarted = false;
                    timerInterval = setInterval(() => {
                        const remaining = Math.round(gameData.timeLimitPerQuestion - (Date.now() - gameData.questionStartTime.toMillis()) / 1000);
                        gameTimerDisplay.textContent = Math.max(0, remaining);
                        if (remaining <= 5 && !soundStarted) { currentQuestionSoundInterval = setInterval(playTimerSound, 500); soundStarted = true; }
                        if (remaining <= 0) {
                            clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval);
                            if (isHost) gameRef.update({ gamePhase: 'question_results' });
                        }
                    }, 250);
                } else if (gamePhase === 'question_results') {
                    if (isHost && !gameData.scoresReconciledForCurrentQuestion) reconcileQuestionScores();
                    showScreen(questionResultsScreen);
                    clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval);
                    resultsCategory.textContent = gameData.currentCategory;
                    resultsQuestion.textContent = gameData.currentQuestionText;
                    roundCorrectAnswersList.innerHTML = `<li><i class="fas fa-key text-yellow-500 mr-2"></i> ${gameData.currentDisplayAnswer}</li>`;
                    showQuestionPlayerScoresDetailed();
                    if (isHost) {
                        questionResultsHostControls.classList.remove('hidden');
                        const isLastQuestion = gameData.currentQuestionIndexInGame >= gameData.quizSet.length;
                        nextQuestionButton.classList.toggle('hidden', isLastQuestion);
                        endGameFinalButton.classList.toggle('hidden', !isLastQuestion);
                    } else playerExitButtonResults.classList.remove('hidden');
                } else if (gamePhase === 'final_results') {
                    showFinalScores();
                }
            }, error => { console.error(error); exitGame(); });
        }
        
        function listenToPlayers() {
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe();
            const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).orderBy("joinedAt", "asc");
            playersSnapshotUnsubscribe = playersRef.onSnapshot((snapshot) => {
                joinedPlayersList.innerHTML = '';
                if(isHost) hostSubmissionStatusList.innerHTML = '';
                let allPlayersSubmitted = snapshot.size > 0;
                snapshot.forEach(doc => {
                    const playerData = doc.data(), playerId = doc.id;
                    const isCurrentUser = playerId === userId;
                    
                    const li = document.createElement('li');
                    li.innerHTML = `${playerData.nickname} - النقاط: ${playerData.score || 0}${playerId === userId && isHost ? ' <i class="fas fa-crown text-yellow-500"></i>' : ''}`;
                    joinedPlayersList.appendChild(li);

                    if (isHost) {
                        const statusItem = document.createElement('li');
                        statusItem.innerHTML = `${playerData.nickname}: ${playerData.hasSubmittedAnswer ? '<i class="fas fa-check-circle text-green-500 ml-2"></i>' : '<i class="fas fa-hourglass-half text-gray-500 ml-2"></i>'}`;
                        hostSubmissionStatusList.appendChild(statusItem);
                        if (!playerData.hasSubmittedAnswer) allPlayersSubmitted = false;
                    }
                    if (isCurrentUser) {
                        playerScoreDisplay.textContent = playerData.score || 0;
                        userUsedPointsBets = playerData.usedPointsBets || [];
                        if (gamePlayScreen.classList.contains('hidden')) populatePointsButtons();
                    }
                });
                if (isHost) {
                    endQuestionEarlyButton.disabled = !allPlayersSubmitted;
                    startGameButton.classList.toggle('hidden', snapshot.size < 1); // Allow host to start alone if they wish
                }
            });
        }

        // --- Game Logic ---
        async function reconcileQuestionScores() {
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            try {
                await db.runTransaction(async t => {
                    const gameDoc = await t.get(gameRef);
                    if (!gameDoc.exists || gameDoc.data().scoresReconciledForCurrentQuestion) return;
                    const gameData = gameDoc.data(), correctAnswers = gameData.currentCorrectAnswers;
                    let roundGuesses = [];
                    const playersRef = gameRef.collection('players');
                    const playersSnap = await t.get(playersRef);
                    for (const playerDoc of playersSnap.docs) {
                        const playerData = playerDoc.data();
                        let scoreChange = 0;
                        if (playerData.hasSubmittedAnswer) {
                            if (isCorrectAnswer(playerData.playerSubmittedAnswer, correctAnswers)) {
                                scoreChange = playerData.playerSelectedPoints;
                                if (!roundGuesses.some(g => normalize(g) === normalize(playerData.playerSubmittedAnswer))) roundGuesses.push(playerData.playerSubmittedAnswer);
                            } else scoreChange = -playerData.playerSelectedPoints;
                        }
                        const newScore = (playerData.score || 0) + scoreChange;
                        t.update(playerDoc.ref, { score: newScore, playerScoreChange: scoreChange });
                    }
                    t.update(gameRef, { currentQuestionGuessedAnswers: roundGuesses, scoresReconciledForCurrentQuestion: true });
                });
            } catch (error) { console.error("Score reconciliation failed:", error); }
        }

        // --- Game State Changers ---
        async function initiateGameStartCountdown() {
            if (!isHost) return;
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            await gameRef.update({ gamePhase: 'game_countdown' });
            // FIX: The host is responsible for triggering the next phase after the countdown duration.
            setTimeout(async () => {
                const doc = await gameRef.get();
                if(doc.exists && doc.data().gamePhase === 'game_countdown') {
                    startNextQuestion();
                }
            }, 5000); // 5 seconds for countdown
        }
        async function startNextQuestion() {
            if (!isHost) return;
            showLoading();
            try {
                await db.runTransaction(async t => {
                    const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                    const gameDoc = await t.get(gameRef);
                    if (!gameDoc.exists) throw new Error("Game not found.");
                    const gameData = gameDoc.data();
                    const nextIndex = gameData.currentQuestionIndexInGame;
                    if (nextIndex >= gameData.quizSet.length) return t.update(gameRef, { gamePhase: 'final_results' });
                    
                    const nextQ = gameData.quizSet[nextIndex];
                    t.update(gameRef, {
                        gamePhase: 'question_active',
                        currentQuestionIndexInGame: nextIndex + 1,
                        currentCategory: nextQ.category,
                        currentQuestionText: nextQ.question,
                        currentCorrectAnswers: nextQ.correctAnswers,
                        currentDisplayAnswer: nextQ.displayAnswer,
                        questionStartTime: firebase.firestore.FieldValue.serverTimestamp(),
                        scoresReconciledForCurrentQuestion: false
                    });
                    const playersRef = gameRef.collection('players');
                    const playersSnap = await t.get(playersRef);
                    playersSnap.docs.forEach(p => t.update(p.ref, { hasSubmittedAnswer: false, playerScoreChange: 0 }));
                });
            } catch(e) { console.error(e); } finally { hideLoading(); }
        }
        async function startNewRoundInSameRoom() {
            if (!isHost) return;
            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) throw new Error("Game not found.");
                const gameData = gameDoc.data();
                
                let allPossibleQuestions = [];
                gameData.selectedCategoryIndices.forEach(catIndex => allPossibleQuestions.push(...quizzes[catIndex].questions.map(q => ({...q, category: quizzes[catIndex].category}))));
                for (let i = allPossibleQuestions.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [allPossibleQuestions[i], allPossibleQuestions[j]] = [allPossibleQuestions[j], allPossibleQuestions[i]]; }
                const newQuizSet = allPossibleQuestions.slice(0, gameData.quizSet.length);

                const batch = db.batch();
                batch.update(gameRef, { gamePhase: 'lobby', quizSet: newQuizSet, currentQuestionIndexInGame: 0 });
                const playersSnap = await gameRef.collection('players').get();
                playersSnap.docs.forEach(p => batch.update(p.ref, { score: 0, usedPointsBets: [], hasSubmittedAnswer: false }));
                await batch.commit();
            } catch(e) { console.error(e); } finally { hideLoading(); }
        }
        function endGame() { if (isHost) db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).update({ gamePhase: 'final_results' }); }

        // --- Final Display Functions ---
        async function showQuestionPlayerScoresDetailed() {
            questionPlayerScoresList.innerHTML = '';
            const playersRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).collection('players').orderBy("score", "desc");
            const playersSnap = await playersRef.get();
            playersSnap.forEach((doc, index) => {
                const p = doc.data(), li = document.createElement('li'), scoreChange = p.playerScoreChange || 0;
                li.className = 'py-2 px-4 rounded-lg mb-2 bg-gray-50 flex justify-between items-center flex-wrap';
                li.innerHTML = `
                    <div class="font-bold">${index + 1}. ${p.nickname}</div>
                    <div class="text-sm ${scoreChange > 0 ? 'text-green-600' : 'text-red-600'}">(${scoreChange >= 0 ? '+' : ''}${scoreChange})</div>
                    <div class="w-full text-xs text-gray-500">إجابة: ${p.playerSubmittedAnswer || 'لم يجب'}</div>
                    <div class="font-semibold">الإجمالي: ${p.score}</div>`;
                questionPlayerScoresList.appendChild(li);
            });
        }
        async function showFinalScores() {
            showScreen(gameEndScreen);
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe();
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe();
            clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval);
            finalScoresList.innerHTML = '';
            const playersRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).collection('players').orderBy("score", "desc");
            const playersSnap = await playersRef.get();
            let scores = []; playersSnap.forEach(doc => scores.push(doc.data()));
            if(scores.length > 0) {
                endMessage.textContent = `تهانينا للفائز ${scores[0].nickname}!`;
                scores.forEach((p, i) => {
                    const li = document.createElement('li');
                    li.className = `py-2 px-4 rounded-lg mb-2 ${i === 0 ? 'bg-yellow-200 font-bold text-yellow-800' : 'bg-gray-50'}`;
                    li.innerHTML = `${i === 0 ? '<i class="fas fa-trophy text-yellow-600"></i> ' : ''}المركز ${i + 1}: ${p.nickname} - ${p.score} نقطة`;
                    finalScoresList.appendChild(li);
                });
            } else endMessage.textContent = "انتهت اللعبة بدون لاعبين.";
            if(isHost) startNewRoundSameRoomButton.classList.remove('hidden');
        }

        // --- Event Listeners ---
        createHostButton.addEventListener('click', () => { setupQuizCategorySelection(); hostNicknameInput.value = localStorage.getItem('playerNickname') || ''; showScreen(hostSetupScreen); });
        joinPlayerButton.addEventListener('click', () => { playerNicknameInput.value = localStorage.getItem('playerNickname') || ''; showScreen(joinGameScreen); });
        createGameButton.addEventListener('click', createGame);
        submitAnswerButton.addEventListener('click', submitGuess);
        startGameButton.addEventListener('click', initiateGameStartCountdown);
        endQuestionEarlyButton.addEventListener('click', () => { if(isHost) db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).update({gamePhase: 'question_results'}); });
        nextQuestionButton.addEventListener('click', startNextQuestion);
        endGameFinalButton.addEventListener('click', endGame);
        startNewRoundSameRoomButton.addEventListener('click', startNewRoundInSameRoom);
        playerExitButtonGameplay.addEventListener('click', exitGame);
        playerExitButtonResults.addEventListener('click', exitGame);
        joinRoomButton.addEventListener('click', () => joinGame(gameCodeInput.value.trim().toUpperCase(), playerNicknameInput.value.trim()));
        gameGuessInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitGuess(); } });
        playAgainButton.addEventListener('click', exitGame);
        quizCategoryInput.addEventListener('click', () => quizCategoryDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (e) => { if (!quizCategoryInput.contains(e.target) && !quizCategoryDropdown.contains(e.target)) quizCategoryDropdown.classList.add('hidden'); });

    </script>
</body>
</html>
