<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سبوركل بارتي (متعدد اللاعبين)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Base font and direction for Arabic */
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* For Arabic text */
            text-align: right; /* For Arabic text */
        }
        /* Custom animation for list items - Tailwind's default doesn't have this exact one */
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInFromBottom 0.5s ease-out forwards;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4a90e2; /* Blue color for spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for the copy button */
        .copy-button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .copy-button:hover {
            background-color: #45a049;
        }
        /* Style for the QR code container */
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            min-height: 128px; /* Ensure space even if QR fails */
        }
        .multiselect-container {
            position: relative;
            width: 100%;
        }
        .multiselect-dropdown {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 10;
            margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .multiselect-dropdown label {
            display: block;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .multiselect-dropdown label:hover {
            background-color: #e2e8f0;
        }
        .multiselect-selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .tag {
            background-color: #a78bfa; /* Purple-300 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Full rounded */
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .tag-remove:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 min-h-screen flex flex-col items-center justify-center p-4 text-gray-800">

    <!-- Loading Overlay - Shown during Firebase initialization or data fetching -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center text-white text-xl">
            <div class="loading-spinner mb-4"></div>
            جاري التحميل... <!-- Loading text in Arabic -->
        </div>
    </div>

    <!-- Main Game Container -->
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full flex flex-col items-center relative overflow-hidden transform transition-all duration-500 ease-in-out">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 text-center leading-tight">لعبة سبوركل بارتي <i class="fas fa-users text-blue-500"></i></h1>
        <p class="text-lg text-gray-600 mb-8 text-center" id="game-description">
            اختر دورك: إما مضيف لإنشاء غرفة، أو لاعب للانضمام إلى غرفة موجودة. <!-- Game description in Arabic -->
        </p>

        <!-- Role Selection Screen -->
        <div id="role-selection-screen" class="w-full flex flex-col items-center space-y-6">
            <button id="create-host-button" class="w-full md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-crown"></i> إنشاء غرفة (مضيف) <!-- Create host room button -->
            </button>
            <button id="join-player-button" class="w-full md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-gamepad"></i> الانضمام إلى غرفة (لاعب) <!-- Join player room button -->
            </button>
        </div>

        <!-- Host Room Setup Screen -->
        <div id="host-setup-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">إعداد غرفة اللعب</h2> <!-- Host setup title -->

            <div class="w-full mb-6">
                <label for="quiz-category-input" class="block text-xl font-semibold text-gray-700 mb-2">اختر فئات الأسئلة (يمكن اختيار أكثر من واحدة):</label>
                <div class="multiselect-container">
                    <input type="text" id="quiz-category-input" readonly placeholder="انقر هنا لاختيار الفئات..."
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 cursor-pointer">
                    <div id="quiz-category-dropdown" class="multiselect-dropdown hidden">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>
                <div id="selected-categories-tags" class="multiselect-selected-tags">
                    <!-- Selected tags will appear here -->
                </div>
            </div>

            <div class="w-full mb-6">
                <label for="time-limit-select" class="block text-xl font-semibold text-gray-700 mb-2">الوقت المخصص لكل جولة (بالثواني):</label> <!-- Time limit label -->
                <select id="time-limit-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="30">30 ثانية</option>
                    <option value="60">60 ثانية</option>
                    <option value="90">90 ثانية</option>
                    <option value="120">120 ثانية</option>
                </select>
            </div>

            <button id="create-game-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-plus-circle"></i> إنشاء اللعبة <!-- Create game button -->
            </button>
        </div>

        <!-- Waiting Room Screen (Host & Player) -->
        <div id="waiting-room-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4" id="waiting-room-title">انتظر انضمام اللاعبين...</h2> <!-- Waiting room title -->
            <p class="text-xl text-gray-700 mb-6">شارك هذا الرابط مع أصدقائك للانضمام:</p> <!-- Share link instruction -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 flex flex-col items-center">
                <span id="game-link-display" class="text-md md:text-xl font-medium text-blue-600 break-all text-center"></span>
                <div id="qrcode" class="mb-2 p-2 bg-white rounded-lg shadow-md flex justify-center items-center">
                    <!-- QR code will be rendered here by JavaScript -->
                    <div id="qrcode-fallback-message" class="text-gray-500 text-sm text-center">
                        <!-- Fallback message for QR code -->
                    </div>
                </div>
                <button id="copy-link-button" class="copy-button mt-4">انسخ الرابط</button>
            </div>
            
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">اللاعبون المنضمون:</h3> <!-- Joined players list title -->
            <ul id="joined-players-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 h-40 overflow-y-auto shadow-inner text-lg">
                <!-- Players will be listed here by JavaScript -->
            </ul>

            <button id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out hidden">
                <i class="fas fa-play"></i> بدء اللعب! <!-- Start game button (for host) -->
            </button>
        </div>

        <!-- Game Play Screen (Host & Player) -->
        <div id="game-play-screen" class="w-full hidden">
            <div class="flex flex-col md:flex-row justify-between items-center w-full mb-8 space-y-4 md:space-y-0">
                <div class="flex items-center space-x-2 space-x-reverse text-2xl font-bold text-gray-700 bg-gray-100 px-5 py-3 rounded-lg shadow-md">
                    <i class="fas fa-hourglass-half text-blue-500"></i>
                    <span>الوقت: <span id="game-timer" class="text-blue-600">--</span> ثانية</span> <!-- Game timer display -->
                </div>
                <div class="flex items-center space-x-2 space-x-reverse text-2xl font-bold text-gray-700 bg-gray-100 px-5 py-3 rounded-lg shadow-md">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span>نقاطك: <span id="player-score" class="text-yellow-600">0</span></span> <!-- Player's score display -->
                </div>
            </div>

            <p class="text-2xl font-bold text-gray-800 mb-4 text-center">الفئة: <span id="game-category" class="text-indigo-600"></span></p> <!-- Current category display -->

            <input type="text" id="game-guess-input" placeholder="اكتب إجابتك هنا..."
                   class="w-full p-4 mb-6 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors duration-300 bg-gray-50"> <!-- Guess input field -->

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">الإجابات الصحيحة (الخاصة بك):</h3> <!-- Player's correct guesses title -->
                    <ul id="player-correct-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2">
                        <!-- Player's correct guesses will be listed here -->
                    </ul>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3">الإجابات المشتركة (لهذه الجولة):</h3> <!-- Shared correct guesses title -->
                    <ul id="shared-round-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2">
                        <!-- All correct guesses across players for THIS ROUND will be listed here -->
                    </ul>
                </div>
            </div>
            
            <!-- Host-only button to end round early -->
            <button id="end-round-early-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out mt-6 hidden">
                <i class="fas fa-flag-checkered"></i> إنهاء الجولة الآن <!-- End round early button -->
            </button>
        </div>

        <!-- Round Results Screen (New) -->
        <div id="round-results-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">نتائج الجولة!</h2>
            <p class="text-xl text-gray-700 mb-6 text-center">فئة الجولة: <span id="results-category" class="font-bold text-indigo-600"></span></p>
            
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الإجابات الصحيحة لهذه الجولة:</h3>
            <ul id="round-correct-answers-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 max-h-64 overflow-y-auto shadow-inner text-lg list-disc pr-6">
                <!-- All correct answers for the round -->
            </ul>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">نقاط اللاعبين في هذه الجولة:</h3>
            <ul id="round-player-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto">
                <!-- Player scores for this round -->
            </ul>

            <!-- Host controls for next round or end game -->
            <div id="round-results-host-controls" class="w-full flex flex-col items-center gap-4 hidden">
                <button id="next-round-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                    <i class="fas fa-forward"></i> الجولة التالية
                </button>
                <button id="end-game-final-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                    <i class="fas fa-times-circle"></i> إنهاء اللعبة
                </button>
            </div>
        </div>

        <!-- Game End Screen (Final Results) -->
        <div id="game-end-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center" id="end-title">النتائج النهائية للعبة!</h2> <!-- Game end title -->
            <p class="text-xl text-gray-700 mb-6 text-center" id="end-message"></p> <!-- End message -->

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الترتيب النهائي:</h3> <!-- Final scores title -->
            <ul id="final-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto">
                <!-- Final scores will be listed here by JavaScript -->
            </ul>

            <button id="play-again-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-redo"></i> العب مرة أخرى <!-- Play again button -->
            </button>
        </div>

        <!-- Custom Message Box - For alerts and confirmations -->
        <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-40 hidden transition-opacity duration-300 ease-out opacity-0">
            <div class="bg-white rounded-xl p-8 text-center shadow-xl transform scale-90 transition-transform duration-300 ease-out">
                <h2 id="custom-message-title" class="text-3xl font-bold text-gray-900 mb-4"></h2> <!-- Message title -->
                <p id="custom-message-content" class="text-xl text-gray-700 mb-6"></p> <!-- Message content -->
                <button id="custom-message-close-button" class="bg-blue-600 hover:bg-blue-700 text-white text-xl font-semibold py-3 px-8 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out">
                    حسناً <!-- Close button -->
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase CDN Scripts - MUST be included BEFORE main game script for global `firebase` object -->
    <!-- These load the Firebase library globally, making `firebase.initializeApp`, etc., available -->
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- QRCode.js for generating QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>

    <!-- Main JavaScript Logic -->
    <script type="text/javascript">
        // Global variables for Firebase and App
        let app, db, auth, userId, userNickname, appId;
        let gameId = null;
        let isHost = false;
        let gameSnapshotUnsubscribe = null; // Listener for game document changes
        let playersSnapshotUnsubscribe = null; // Listener for players collection changes
        let timerInterval = null; // Interval for host's game timer

        // Quiz data - Add more quizzes as needed!
        // IMPORTANT: Answers should be unique within each quiz to avoid issues with `arrayUnion`
        const quizzes = [
            {
                category: "عواصم الدول العربية",
                answers: ["الرياض", "القاهرة", "بغداد", "دمشق", "عمان", "بيروت", "الرباط", "تونس", "الجزائر", "الخرطوم", "صنعاء", "ابوظبي", "الدوحة", "الكويت", "المنامة", "مقديشو", "جيبوتي", "موروني", "طرابلس", "نواكشوط", "مسقط", "القدس"]
            },
            {
                category: "الفواكه",
                answers: ["تفاح", "برتقال", "موز", "عنب", "فراولة", "مانجو", "أناناس", "بطيخ", "شمام", "كيوي", "توت", "كرز", "ليمون", "جوافة", "خوخ", "رمان", "تين", "بلح", "توت أزرق", "كمثرى"]
            },
            {
                category: "دول أوروبية (أكثر من 20)",
                answers: [
                    "ألمانيا", "فرنسا", "إيطاليا", "إسبانيا", "المملكة المتحدة", "بولندا", "أوكرانيا", "رومانيا", "هولندا", "بلجيكا",
                    "اليونان", "البرتغال", "السويد", "النمسا", "سويسرا", "صربيا", "بلغاريا", "الدنمارك", "فنلندا", "النرويج",
                    "إيرلندا", "كرواتيا", "البوسنة والهرسك", "ليتوانيا", "لاتفيا", "إستونيا", "سلوفاكيا", "سلوفينيا", "المجر", "جمهورية التشيك",
                    "مولدوفا", "ألبانيا", "مقدونيا الشمالية", "الجبل الأسود", "مالطا", "لوكسمبورغ", "قبرص", "آيسلندا", "كوسوفو", "أندورا",
                    "سان مارينو", "ليختنشتاين", "موناكو", "الفاتيكان", "روسيا (الجزء الأوروبي)", "تركيا (الجزء الأوروبي)", "بيلاروسيا", "جورجيا", "أذربيجان", "أرمينيا"
                ]
            },
            {
                category: "حيوانات الغابة",
                answers: ["أسد", "نمر", "فيل", "زرافة", "قرد", "دب", "ثعلب", "ذئب", "غزال", "حمار وحشي", "ضبع", "كنغر", "كوالا", "باندا"]
            },
            {
                category: "عواصم دول العالم (غير العربية)",
                answers: ["واشنطن", "لندن", "باريس", "برلين", "روما", "مدريد", "طوكيو", "بكين", "موسكو", "أوتاوا", "كانبرا", "برازيليا", "بوينس آيرس", "نيودلهي", "أثينا", "وارسو", "ليما", "سيول", "بانكوك", "أنقرة"]
            }
        ];
        
        // Multi-select quiz categories logic
        let selectedQuizIndices = [];
        const quizCategoryInput = document.getElementById('quiz-category-input');
        const quizCategoryDropdown = document.getElementById('quiz-category-dropdown');
        const selectedCategoriesTags = document.getElementById('selected-categories-tags');

        // Function to populate and manage the multi-select dropdown
        function setupQuizCategorySelection() {
            quizCategoryDropdown.innerHTML = ''; // Clear previous options
            quizzes.forEach((quiz, index) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = index;
                checkbox.className = 'ml-2'; // Tailwind spacing

                checkbox.checked = selectedQuizIndices.includes(index); // Set checked state

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(quiz.category));
                quizCategoryDropdown.appendChild(label);

                checkbox.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        if (!selectedQuizIndices.includes(index)) {
                            selectedQuizIndices.push(index);
                        }
                    } else {
                        selectedQuizIndices = selectedQuizIndices.filter(i => i !== index);
                    }
                    updateSelectedCategoriesTags();
                });
            });
            updateSelectedCategoriesTags(); // Initial render of tags
        }

        // Function to update the displayed tags for selected categories
        function updateSelectedCategoriesTags() {
            selectedCategoriesTags.innerHTML = '';
            selectedQuizIndices.forEach(index => {
                const quiz = quizzes[index];
                if (quiz) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = quiz.category;
                    
                    const removeBtn = document.createElement('span');
                    removeBtn.className = 'tag-remove';
                    removeBtn.textContent = 'x';
                    removeBtn.onclick = () => {
                        selectedQuizIndices = selectedQuizIndices.filter(i => i !== index);
                        setupQuizCategorySelection(); // Re-render dropdown and tags
                    };
                    tag.appendChild(removeBtn);
                    selectedCategoriesTags.appendChild(tag);
                }
            });
            // Update input placeholder based on selection
            if (selectedQuizIndices.length === 0) {
                quizCategoryInput.placeholder = "انقر هنا لاختيار الفئات...";
            } else {
                quizCategoryInput.placeholder = `تم اختيار ${selectedQuizIndices.length} فئات`;
            }
        }

        // Toggle dropdown visibility
        quizCategoryInput.addEventListener('click', () => {
            quizCategoryDropdown.classList.toggle('hidden');
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!quizCategoryInput.contains(event.target) && !quizCategoryDropdown.contains(event.target)) {
                quizCategoryDropdown.classList.add('hidden');
            }
        });


        // --- DOM Elements (Get references to HTML elements) ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const roleSelectionScreen = document.getElementById('role-selection-screen');
        const hostSetupScreen = document.getElementById('host-setup-screen');
        const waitingRoomScreen = document.getElementById('waiting-room-screen');
        const joinGameScreen = document.getElementById('join-game-screen');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const roundResultsScreen = document.getElementById('round-results-screen'); // New round results screen
        const gameEndScreen = document.getElementById('game-end-screen');

        const createHostButton = document.getElementById('create-host-button');
        const joinPlayerButton = document.getElementById('join-player-button');
        const timeLimitSelect = document.getElementById('time-limit-select');
        const createGameButton = document.getElementById('create-game-button');
        const gameLinkDisplay = document.getElementById('game-link-display'); // Displays the game link
        const qrcodeDiv = document.getElementById('qrcode'); // Container for QR code (or fallback message)
        const qrcodeFallbackMessage = document.getElementById('qrcode-fallback-message'); // Element for fallback message
        const copyLinkButton = document.getElementById('copy-link-button');

        const joinedPlayersList = document.getElementById('joined-players-list');
        const startGameButton = document.getElementById('start-game-button'); // Now starts the first round
        const gameCodeInput = document.getElementById('game-code-input');
        const playerNicknameInput = document.getElementById('player-nickname-input');
        const joinRoomButton = document.getElementById('join-room-button');
        const gameTimerDisplay = document.getElementById('game-timer');
        const playerScoreDisplay = document.getElementById('player-score');
        const gameCategoryDisplay = document.getElementById('game-category');
        const gameGuessInput = document.getElementById('game-guess-input');
        const playerCorrectGuessesList = document.getElementById('player-correct-guesses-list');
        const sharedRoundGuessesList = document.getElementById('shared-round-guesses-list'); // Renamed for current round
        const endRoundEarlyButton = document.getElementById('end-round-early-button'); // Button for host to end round early

        const resultsCategory = document.getElementById('results-category');
        const roundCorrectAnswersList = document.getElementById('round-correct-answers-list');
        const roundPlayerScoresList = document.getElementById('round-player-scores-list');
        const roundResultsHostControls = document.getElementById('round-results-host-controls');
        const nextRoundButton = document.getElementById('next-round-button');
        const endGameFinalButton = document.getElementById('end-game-final-button');


        const endTitle = document.getElementById('end-title');
        const endMessage = document.getElementById('end-message');
        const finalScoresList = document.getElementById('final-scores-list');
        const playAgainButton = document.getElementById('play-again-button');
        const customMessageBox = document.getElementById('custom-message-box');
        const customMessageTitle = document.getElementById('custom-message-title');
        const customMessageContent = document.getElementById('custom-message-content');
        const customMessageCloseButton = document.getElementById('custom-message-close-button');

        // --- Firebase Initialization ---
        // This function initializes Firebase and handles user authentication.
        async function initializeFirebase() {
            showLoading(); // Show loading overlay
            try {
                // *** FIREBASE CONFIGURATION (YOUR PROJECT'S SETTINGS) ***
                // This is the configuration you provided for your Firebase project 'ka3boura-dbcf5'.
                const firebaseConfig = {
                  apiKey: "AIzaSyCwdZjTwrnjKZU_AilP5_GZJeEuUZjVcUY",
                  authDomain: "ka3boura-dbcf5.firebaseapp.com",
                  projectId: "ka3boura-dbcf5",
                  storageBucket: "ka3boura-dbcf5.firebasestorage.app",
                  messagingSenderId: "1051115240747",
                  appId: "1:1051115240747:web:694751eef3173327f5596e",
                  measurementId: "G-9413DFK5DF"
                };
                // ***********************************************************************************

                // Log the Firebase config to console to help debugging if there's an issue
                console.log("Using Firebase Config:", firebaseConfig);

                // IMPORTANT: Assign to the GLOBAL appId variable declared at the top.
                appId = firebaseConfig.projectId;
                console.log("Derived App ID for Firestore path (Global):", appId);


                app = firebase.initializeApp(firebaseConfig); // Initialize Firebase app
                db = firebase.firestore(app); // Get Firestore instance
                auth = firebase.auth(app); // Get Auth instance

                // Sign in anonymously for game functionality.
                await auth.signInAnonymously();

                // Listen for authentication state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid; // Store the authenticated user ID
                        console.log("Authenticated with userId:", userId);
                        hideLoading(); // Hide loading overlay

                        // Check URL for existing gameId to auto-join if provided (e.g., from QR code link)
                        const urlParams = new URLSearchParams(window.location.search);
                        const idFromUrl = urlParams.get('gameId');
                        if (idFromUrl) {
                            gameId = idFromUrl;
                            playerNicknameInput.value = localStorage.getItem('playerNickname') || ''; // Load saved nickname from local storage

                            // If nickname is available, prompt user to join directly. Otherwise, show join screen.
                            if (!playerNicknameInput.value) {
                                showScreen(joinGameScreen); // Show join screen for nickname input
                                showCustomMessageBox("الانضمام إلى لعبة", `أدخل اسمك المستعار للانضمام إلى اللعبة برمز ${gameId}.`);
                                customMessageCloseButton.onclick = () => {
                                    hideCustomMessageBox();
                                    // User needs to fill nickname and click join manually
                                };
                            } else {
                                showCustomMessageBox("الانضمام إلى لعبة", `هل تريد الانضمام إلى اللعبة برمز ${gameId} باسم ${playerNicknameInput.value}؟`);
                                customMessageCloseButton.onclick = () => {
                                    hideCustomMessageBox();
                                    joinGame(gameId, playerNicknameInput.value); // Auto-join with saved nickname
                                };
                            }
                        } else {
                            showScreen(roleSelectionScreen); // Show role selection if no gameId in URL
                        }
                    } else {
                        console.log("No user signed in.");
                        hideLoading(); // Hide loading even if no user
                        showScreen(roleSelectionScreen); // Always show role selection if not authenticated
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error Details:", error); // Log the full error object for detailed debugging
                showCustomMessageBox("خطأ", `فشل تهيئة اللعبة. تأكد من إعداد Firebase بشكل صحيح وقواعد الأمان. التفاصيل: ${error.message}`);
                hideLoading();
            }
        }

        // --- UI Management Functions ---
        // Shows the loading spinner overlay
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        // Hides the loading spinner overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Hides all game screens and shows the specified one
        function showScreen(screenElement) {
            // Hide all potential screens
            roleSelectionScreen.classList.add('hidden');
            hostSetupScreen.classList.add('hidden');
            waitingRoomScreen.classList.add('hidden');
            joinGameScreen.classList.add('hidden');
            gamePlayScreen.classList.add('hidden');
            roundResultsScreen.classList.add('hidden'); // Hide new round results screen
            gameEndScreen.classList.add('hidden');
            customMessageBox.classList.add('hidden'); // Also ensure custom message box is hidden

            // Show the target screen
            screenElement.classList.remove('hidden');
            // If it's not the message box, ensure the message box is hidden
            if (screenElement !== customMessageBox) {
                customMessageBox.classList.remove('flex', 'opacity-100');
                customMessageBox.classList.add('hidden', 'opacity-0');
            }
        }

        // Displays a custom message box (replacement for alert/confirm)
        function showCustomMessageBox(title, content) {
            customMessageTitle.textContent = title;
            customMessageContent.textContent = content;
            customMessageBox.classList.remove('hidden', 'opacity-0');
            customMessageBox.classList.add('flex', 'opacity-100'); // Add flex and opacity for fade-in
        }

        // Hides the custom message box
        function hideCustomMessageBox() {
            customMessageBox.classList.remove('flex', 'opacity-100');
            customMessageBox.classList.add('hidden', 'opacity-0'); // Remove flex and opacity for fade-out
        }

        // --- Game Helper Functions ---
        // Generates a short, random alphanumeric string for game codes
        function generateGameCode(length = 5) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        // Normalizes a string (lowercase, trims whitespace) for consistent comparison
        function normalizeString(str) {
            return str.toLowerCase().trim();
        }

        // --- Host Specific Functions ---
        // Creates a new game instance in Firestore
        async function createGame() {
            showLoading(); // Show loading spinner
            try {
                if (selectedQuizIndices.length === 0) {
                    showCustomMessageBox("خطأ", "الرجاء اختيار فئة واحدة على الأقل للأسئلة.");
                    hideLoading();
                    return;
                }

                gameId = generateGameCode(); // Generate a unique game ID
                isHost = true; // Set current user as host
                const timeLimit = parseInt(timeLimitSelect.value); // Get selected time limit

                // Prepare the quiz order for the game
                // Map selected indices to an array of quiz objects (category and allAnswers)
                const quizSetForGame = selectedQuizIndices.map(index => ({
                    category: quizzes[index].category,
                    allAnswers: quizzes[index].answers.map(normalizeString)
                }));
                // Shuffle the quiz order for randomness
                for (let i = quizSetForGame.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [quizSetForGame[i], quizSetForGame[j]] = [quizSetForGame[j], quizSetForGame[i]];
                }


                // Reference to the new game document in Firestore
                // Path: artifacts/{appId}/public/data/games/{gameId}
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                console.log("Attempting to create game at path:", gameRef.path); // Log path
                await gameRef.set({ // Create the game document
                    hostId: userId,
                    gamePhase: 'lobby', // Initial phase
                    quizSet: quizSetForGame, // Array of quizzes for this game
                    currentQuizIndexInOrder: 0, // Index of the current quiz in the quizSet
                    currentCategory: '', // Will be set when round starts
                    currentAllAnswers: [], // Will be set when round starts
                    currentRoundGuessedAnswers: [], // Guesses for the current round
                    roundStartTime: null, // Timestamp when current round started
                    timeLimitPerRound: timeLimit,
                    currentTime: timeLimit, // Initialize current time with full time limit
                    playerScores: {}, // To store overall cumulative scores for players
                    lastUpdate: Date.now() // Timestamp for host's last update (for real-time timer sync)
                });

                // Add host as a player in the game's subcollection
                // Path: artifacts/{appId}/public/data/games/{gameId}/players/{userId}
                const playerRef = gameRef.collection('players').doc(userId);
                console.log("Attempting to add host player at path:", playerRef.path); // Log path
                await playerRef.set({
                    nickname: "المضيف", // Default nickname for the host
                    score: 0, // Overall score
                    joinedAt: Date.now(),
                    correctGuesses: [] // Individual correct guesses (cumulative across rounds)
                });
                userNickname = "المضيف"; // Set current user's nickname

                console.log("Game created with ID:", gameId);
                // Display the direct link to the game room
                const gameRoomLink = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                gameLinkDisplay.textContent = gameRoomLink; // Display the full link
                gameLinkDisplay.href = gameRoomLink; // Make it clickable (if needed, though copy is main)
                
                // Try to generate QR code, with fallback if QRCode library is not defined
                qrcodeDiv.innerHTML = ''; // Clear previous content
                qrcodeFallbackMessage.textContent = ''; // Clear fallback message
                try {
                    if (typeof QRCode !== 'undefined' && QRCode) { // Explicit check for QRCode global object
                        new QRCode(qrcodeDiv, {
                            text: gameRoomLink,
                            width: 128,
                            height: 128,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        console.log("QR Code generated successfully.");
                    } else {
                        throw new Error("QRCode library not available (fallback).");
                    }
                } catch (qrError) {
                    console.warn("Failed to generate QR Code:", qrError);
                    qrcodeFallbackMessage.textContent = "فشل توليد رمز QR. يرجى استخدام الرابط أعلاه للانضمام.";
                    // Optionally style qrcodeDiv to show the message better
                    qrcodeDiv.style.minHeight = 'auto';
                    qrcodeDiv.style.border = '1px dashed #ddd';
                    qrcodeDiv.style.padding = '10px';
                }

                // Add an event listener to copy the link to clipboard
                copyLinkButton.onclick = () => {
                    // Use document.execCommand('copy') for better compatibility in iframes
                    const textArea = document.createElement("textarea");
                    textArea.value = gameRoomLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showCustomMessageBox("تم النسخ!", "تم نسخ رابط الغرفة إلى الحافظة.");
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        showCustomMessageBox("خطأ في النسخ", "فشل نسخ الرابط، يرجى نسخه يدوياً.");
                    }
                    document.body.removeChild(textArea);
                };

                showScreen(waitingRoomScreen); // Show waiting room screen
                listenToGameChanges(); // Start listening to the game document for real-time updates
                listenToPlayers(); // Start listening to players joining the room
                startGameButton.classList.remove('hidden'); // Show start game button for host
            } catch (error) {
                console.error("Error creating game:", error);
                showCustomMessageBox("خطأ في إنشاء اللعبة", error.message || "حدث خطأ أثناء إنشاء الغرفة.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // Starts the next round of the game
        async function startNextRound() {
            showLoading();
            try {
                if (!gameId) throw new Error("لا يوجد معرف لعبة.");
                if (!isHost) throw new Error("فقط المضيف يمكنه بدء الجولة.");

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) throw new Error("اللعبة غير موجودة.");

                const gameData = gameDoc.data();
                const currentQuizIndex = gameData.currentQuizIndexInOrder;
                const quizSet = gameData.quizSet;

                if (currentQuizIndex >= quizSet.length) {
                    // All quizzes played, end the game
                    await gameRef.update({ gamePhase: 'final_results' });
                    return;
                }

                const nextQuiz = quizSet[currentQuizIndex];

                await gameRef.update({
                    gamePhase: 'question_active',
                    currentQuizIndexInOrder: currentQuizIndex + 1, // Advance to next quiz index
                    currentCategory: nextQuiz.category,
                    currentAllAnswers: nextQuiz.allAnswers,
                    currentRoundGuessedAnswers: [], // Reset guessed answers for new round
                    roundStartTime: Date.now(),
                    currentTime: gameData.timeLimitPerRound, // Reset timer
                    // Clear player-specific correct guesses from previous round for results screen
                    playerRoundCorrectGuesses: {} 
                });

                // Clear player's correct guesses for the *new* round on their local UI
                playerCorrectGuessesList.innerHTML = ''; 
                gameGuessInput.value = '';
                gameGuessInput.focus();

                console.log(`Starting round ${currentQuizIndex + 1}: ${nextQuiz.category}`);

            } catch (error) {
                console.error("Error starting next round:", error);
                showCustomMessageBox("خطأ", error.message || "فشل بدء الجولة التالية.");
            } finally {
                hideLoading();
            }
        }

        // --- Host Specific Functions ---
        // Allows host to end the current round early
        async function endRoundEarly() {
            if (!isHost || !gameId) return; // Only host can do this in an active game

            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                await gameRef.update({
                    gamePhase: 'round_results', // Move to showing round results
                    currentTime: 0 // Ensure timer is at zero
                });
                console.log("Host ended round early.");
            } catch (error) {
                console.error("Error ending round early:", error);
                showCustomMessageBox("خطأ", "فشل إنهاء الجولة مبكراً.");
            } finally {
                hideLoading();
            }
        }

        // Ends the entire game
        async function endGame() {
            if (!isHost || !gameId) return;
            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                await gameRef.update({
                    gamePhase: 'final_results' // Move to final results
                });
                console.log("Host ended the entire game.");
            } catch (error) {
                console.error("Error ending game:", error);
                showCustomMessageBox("خطأ", "فشل إنهاء اللعبة.");
            } finally {
                hideLoading();
            }
        }


        // --- Player Specific Functions ---
        // Allows a player to join an existing game
        async function joinGame(code, nickname) {
            showLoading(); // Show loading spinner
            try {
                if (!code || !nickname) {
                    throw new Error("يرجى إدخال رمز اللعبة واسمك المستعار."); // Input validation
                }

                // Reference to the game document
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(code);
                console.log("Attempting to join game at path:", gameRef.path); // Log path
                const gameDoc = await gameRef.get(); // Get game document

                if (!gameDoc.exists) {
                    throw new Error("رمز اللعبة غير صحيح أو الغرفة غير موجودة."); // Game not found
                }

                const gameData = gameDoc.data();
                if (gameData.gamePhase === 'final_results') {
                    showCustomMessageBox("اللعبة انتهت", "عذراً، هذه اللعبة قد انتهت بالفعل.");
                    hideLoading();
                    showScreen(roleSelectionScreen); // Redirect to role selection
                    return;
                }

                gameId = code; // Set current game ID
                isHost = false; // Current user is a player
                userNickname = nickname; // Set current user's nickname
                localStorage.setItem('playerNickname', nickname); // Save nickname locally for future use

                // Add player to the game's players subcollection
                const playerRef = gameRef.collection('players').doc(userId);
                console.log("Attempting to add player at path:", playerRef.path); // Log path
                await playerRef.set({ // Use set with merge to avoid overwriting if player rejoins
                    nickname: nickname,
                    score: 0, // Overall score
                    joinedAt: Date.now(),
                    correctGuesses: [] // Overall correct guesses
                }, { merge: true });

                console.log("Joined game:", gameId);
                // Update URL to include gameId for easy sharing/rejoining
                if (!window.location.search.includes(`gameId=${gameId}`)) {
                    const newUrl = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                    window.history.pushState({ path: newUrl }, '', newUrl); // Change URL without reloading
                }

                showScreen(waitingRoomScreen); // Show waiting room screen
                document.getElementById('waiting-room-title').textContent = `في انتظار بدء اللعبة...`; // Player-specific waiting message
                // For players, the game link display will just show the game ID
                gameLinkDisplay.textContent = `رمز الغرفة: ${gameId}`;
                // Hide QR code and copy button for players
                if (qrcodeDiv) qrcodeDiv.innerHTML = ''; // Clear QR code
                if (qrcodeFallbackMessage) qrcodeFallbackMessage.textContent = ''; // Clear fallback message
                if (copyLinkButton) copyLinkButton.classList.add('hidden'); // Hide copy button
                
                listenToGameChanges(); // Start listening to game document
                listenToPlayers(); // Start listening to players in the room
            } catch (error) {
                console.error("Error joining game:", error);
                showCustomMessageBox("خطأ في الانضمام", error.message || "فشل الانضمام إلى الغرفة.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // Submits a player's guess to Firestore
        async function submitGuess() {
            // Only allow submission if gameId is set and we are on the game play screen.
            if (!gameId || gamePlayScreen.classList.contains('hidden')) {
                 return; // Do nothing if not in active game play
            }

            const guess = normalizeString(gameGuessInput.value); // Get and normalize player's guess
            gameGuessInput.value = ''; // Clear input field immediately after submission

            if (guess === '') return; // Do nothing if guess is empty

            showLoading(); // Show loading spinner
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const playerRef = gameRef.collection('players').doc(userId);

                // Use a Firestore transaction to ensure atomic updates
                await db.runTransaction(async (transaction) => {
                    const gameDoc = await transaction.get(gameRef); // Get current game data
                    const playerDoc = await transaction.get(playerRef); // Get current player data

                    if (!gameDoc.exists || !playerDoc.exists) {
                        throw "Game or player data not found."; // Critical error if documents don't exist
                    }

                    const gameData = gameDoc.data();
                    const playerData = playerDoc.data();

                    const currentAllAnswers = gameData.currentAllAnswers || []; // All possible answers for the current round
                    const currentRoundGuessedAnswers = gameData.currentRoundGuessedAnswers || []; // Answers guessed in THIS round by ANY player
                    let playerOverallScore = playerData.score || 0; // Player's overall score
                    let playerRoundCorrectGuesses = playerData.currentRoundCorrectGuesses || []; // Player's correct guesses for THIS round

                    // Check if guess is correct AND has not been guessed by ANYONE yet for THIS round
                    if (currentAllAnswers.includes(guess) && !currentRoundGuessedAnswers.includes(guess)) {
                        // Add guess to the shared list of guessed answers for THIS round
                        transaction.update(gameRef, {
                            currentRoundGuessedAnswers: firebase.firestore.FieldValue.arrayUnion(guess)
                        });

                        // Update player's overall score and their own list of correct guesses for THIS round
                        transaction.update(playerRef, {
                            score: playerOverallScore + 10, // Increase overall score by 10
                            currentRoundCorrectGuesses: firebase.firestore.FieldValue.arrayUnion(guess)
                        });
                        console.log("Correct guess:", guess);
                    } else if (currentAllAnswers.includes(guess) && currentRoundGuessedAnswers.includes(guess)) {
                        console.log("Answer already guessed by someone (or self) this round:", guess);
                        // Optionally provide visual feedback to user: already guessed
                    } else {
                        console.log("Incorrect guess:", guess);
                        // Optionally provide visual feedback to user: incorrect
                    }
                });
            } catch (error) {
                console.error("Error submitting guess:", error);
                // For a multiplayer game, avoid showing pop-up for every incorrect guess. Log instead.
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // --- Real-time Listeners ---
        // Listens for changes to the main game document in Firestore
        function listenToGameChanges() {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe(); // Unsubscribe from previous listener if exists

            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            console.log("Listening to game changes at path:", gameRef.path); // Log path

            gameSnapshotUnsubscribe = gameRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const gameData = docSnap.data();
                    const gamePhase = gameData.gamePhase;

                    // Update global player score (your own score)
                    // This will be updated by listenToPlayers, but keep this for direct gameData access too if needed.
                    // (Not strictly necessary here as listenToPlayers handles it)

                    // Phase: Waiting room / Lobby
                    if (gamePhase === 'lobby') {
                        showScreen(waitingRoomScreen);
                        // Host sees 'Start Game' (which starts first round)
                        if (isHost) {
                            startGameButton.textContent = "بدء الجولة الأولى!";
                            startGameButton.onclick = startNextRound; // Change function for start button
                            if (joinedPlayersList.children.length > 1) { // If at least host + 1 player
                                startGameButton.classList.remove('hidden');
                            } else {
                                startGameButton.classList.add('hidden');
                            }
                        } else {
                            startGameButton.classList.add('hidden'); // Players don't see this button
                        }
                    } 
                    // Phase: Question is active
                    else if (gamePhase === 'question_active') {
                        showScreen(gamePlayScreen);
                        gameCategoryDisplay.textContent = gameData.currentCategory;
                        gameGuessInput.focus();
                        
                        // Show/hide "End Round Early" button for host only during game play
                        if (isHost) {
                            endRoundEarlyButton.classList.remove('hidden');
                        } else {
                            endRoundEarlyButton.classList.add('hidden');
                        }

                        // Host-specific timer logic: Host updates time in Firestore
                        if (isHost) {
                            clearInterval(timerInterval); // Clear any old timer
                            timerInterval = setInterval(async () => {
                                const now = Date.now();
                                // Calculate elapsed time since round started
                                const elapsed = Math.floor((now - gameData.roundStartTime) / 1000);
                                const remainingTime = gameData.timeLimitPerRound - elapsed;
                                
                                if (remainingTime >= 0) {
                                    // Update Firestore with current time and last update timestamp
                                    await gameRef.update({ currentTime: remainingTime, lastUpdate: now });
                                    gameTimerDisplay.textContent = remainingTime; // Update timer display
                                } else {
                                    clearInterval(timerInterval); // Stop timer
                                    // If time runs out, move to round results phase
                                    await gameRef.update({ gamePhase: 'round_results', currentTime: 0 });
                                }
                            }, 1000); // Update every second
                        } else {
                            // Player-specific timer logic: Players display time from host's update
                            const timeFromHost = gameData.currentTime;
                            gameTimerDisplay.textContent = timeFromHost;
                            // Game status change to 'round_results' or 'final_results' will trigger screen change for players
                        }

                        // Update shared correct guesses list for the CURRENT ROUND for all players
                        sharedRoundGuessesList.innerHTML = ''; // Clear existing list
                        (gameData.currentRoundGuessedAnswers || []).forEach(answer => {
                            const listItem = document.createElement('li');
                            listItem.textContent = answer;
                            listItem.classList.add('text-purple-700', 'font-semibold', 'opacity-0', 'animate-fade-in-up');
                            sharedRoundGuessesList.appendChild(listItem);
                        });

                        // Auto-advance if all answers for the current round are guessed
                        if ((gameData.currentRoundGuessedAnswers || []).length === (gameData.currentAllAnswers || []).length && (gameData.currentAllAnswers || []).length > 0) {
                            if (gamePhase === 'question_active') { // Only auto-advance if currently in active question phase
                                gameRef.update({ gamePhase: 'round_results' }); // Move to showing round results
                            }
                        }

                    } 
                    // Phase: Showing Round Results
                    else if (gamePhase === 'round_results') {
                        showScreen(roundResultsScreen);
                        clearInterval(timerInterval); // Stop any timer

                        resultsCategory.textContent = gameData.currentCategory;
                        
                        // Display all correct answers for this specific round
                        roundCorrectAnswersList.innerHTML = '';
                        (gameData.currentAllAnswers || []).forEach(answer => {
                            const listItem = document.createElement('li');
                            // Highlight if it was guessed
                            if ((gameData.currentRoundGuessedAnswers || []).includes(answer)) {
                                listItem.innerHTML = `<i class="fas fa-check text-green-500 mr-2"></i> ${answer}`;
                            } else {
                                listItem.innerHTML = `<i class="fas fa-times text-red-500 mr-2"></i> ${answer}`;
                            }
                            roundCorrectAnswersList.appendChild(listItem);
                        });

                        // Display player scores for this round (fetching live data from players subcollection)
                        showRoundPlayerScores();

                        // Host controls for next round or end game
                        if (isHost) {
                            roundResultsHostControls.classList.remove('hidden');
                            // Check if there are more quizzes
                            if (gameData.currentQuizIndexInOrder < gameData.quizSet.length) {
                                nextRoundButton.classList.remove('hidden');
                                endGameFinalButton.classList.add('hidden'); // Hide end game button if more rounds
                            } else {
                                nextRoundButton.classList.add('hidden'); // Hide next round button
                                endGameFinalButton.classList.remove('hidden'); // Show end game button
                            }
                        } else {
                            roundResultsHostControls.classList.add('hidden'); // Hide host controls for players
                        }
                    }
                    // Phase: Final Game Results
                    else if (gamePhase === 'final_results') {
                        clearInterval(timerInterval); // Stop any active timers
                        showFinalScores(); // Display final overall scores
                    }
                } else {
                    console.log("Game document deleted or does not exist.");
                    showCustomMessageBox("اللعبة غير موجودة", "غرفة اللعب هذه لم تعد موجودة. قد يكون المضيف قد أغلقها.");
                    showScreen(roleSelectionScreen); // Go back to role selection
                }
            }, (error) => {
                console.error("Error listening to game changes:", error);
                showCustomMessageBox("خطأ في الاتصال", `فقد الاتصال باللعبة. يرجى التحقق من اتصالك بالإنترنت. التفاصيل: ${error.message}`);
            });
        }

        // Listens for changes to the players subcollection in Firestore
        function listenToPlayers() {
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe(); // Unsubscribe from previous listener

            const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
            console.log("Listening to players at path:", playersRef.path); // Log path
            const q = playersRef;

            playersSnapshotUnsubscribe = q.onSnapshot((snapshot) => {
                joinedPlayersList.innerHTML = ''; // Clear current list of joined players
                playerCorrectGuessesList.innerHTML = ''; // Clear player's own current round guesses display

                let currentPlayerOverallScore = 0;
                let currentPlayerRoundCorrectGuesses = [];

                snapshot.forEach((doc) => {
                    const playerData = doc.data();
                    const playerId = doc.id;

                    // Update the list of joined players in the waiting room
                    const listItem = document.createElement('li');
                    // Display partial user ID for uniqueness and debugging in multiplayer
                    listItem.textContent = `${playerData.nickname || 'لاعب مجهول'} (ID: ${playerId.substring(0, 8)}... - النقاط: ${playerData.score || 0})`;
                    joinedPlayersList.appendChild(listItem);

                    // Update current player's overall score and current round guesses (only for self)
                    if (playerId === userId) {
                        playerOverallScore = playerData.score || 0;
                        currentPlayerRoundCorrectGuesses = playerData.currentRoundCorrectGuesses || [];
                    }
                });
                playerScoreDisplay.textContent = currentPlayerOverallScore; // Update UI with overall score

                // Populate the current player's specific correct guesses list for THIS ROUND
                currentPlayerRoundCorrectGuesses.forEach(guess => {
                    const listItem = document.createElement('li');
                    listItem.textContent = guess;
                    listItem.classList.add('text-green-700', 'font-semibold', 'opacity-0', 'animate-fade-in-up');
                    playerCorrectGuessesList.appendChild(listItem);
                });

                // Host-specific logic: Show/hide start button based on number of players
                // Only apply if host is in waiting room phase
                const gameDocRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                gameDocRef.get().then(doc => {
                    if (doc.exists && doc.data().gamePhase === 'lobby' && isHost) {
                        if (snapshot.size > 1) { // More than 1 player (host + at least one other)
                            startGameButton.classList.remove('hidden'); // Show start button
                        } else {
                            startGameButton.classList.add('hidden'); // Hide if only host or no other players
                        }
                    }
                }).catch(error => console.error("Error checking game phase:", error));

            }, (error) => {
                console.error("Error listening to players:", error);
                // Optionally show error message about player list update issues
            });
        }

        // Displays scores of players for the CURRENT round on the results screen
        async function showRoundPlayerScores() {
            roundPlayerScoresList.innerHTML = ''; // Clear previous scores
            try {
                const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersSnapshot = await playersRef.get();

                let roundScores = [];
                playersSnapshot.forEach(doc => {
                    const playerData = doc.data();
                    roundScores.push({
                        nickname: playerData.nickname,
                        roundCorrectGuessesCount: (playerData.currentRoundCorrectGuesses || []).length, // Count correct guesses for this round
                        overallScore: playerData.score || 0 // Display overall score as well
                    });
                });

                // Sort by round correct guesses count descending
                roundScores.sort((a, b) => b.roundCorrectGuessesCount - a.roundCorrectGuessesCount);

                roundScores.forEach(player => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('py-2', 'px-4', 'rounded-lg', 'mb-2', 'bg-gray-50');
                    listItem.textContent = `${player.nickname}: ${player.roundCorrectGuessesCount} إجابة صحيحة في هذه الجولة (إجمالي النقاط: ${player.overallScore})`;
                    roundPlayerScoresList.appendChild(listItem);
                });

            } catch (error) {
                console.error("Error showing round player scores:", error);
                showCustomMessageBox("خطأ", "فشل عرض نتائج الجولة.");
            }
        }


        // Displays the final overall scores screen and results
        async function showFinalScores() {
            showLoading(); // Show loading spinner
            try {
                // Unsubscribe from real-time listeners to prevent further updates
                if (gameSnapshotUnsubscribe) {
                    gameSnapshotUnsubscribe();
                    gameSnapshotUnsubscribe = null;
                }
                if (playersSnapshotUnsubscribe) {
                    playersSnapshotUnsubscribe();
                    playersSnapshotUnsubscribe = null;
                }

                // Fetch all player data one last time to get final scores
                const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersSnapshot = await playersRef.get();

                let finalScores = [];
                playersSnapshot.forEach(doc => {
                    finalScores.push(doc.data());
                });

                // Sort players by overall score in descending order to determine winner
                finalScores.sort((a, b) => (b.score || 0) - (a.score || 0));

                finalScoresList.innerHTML = ''; // Clear previous final scores list
                if (finalScores.length > 0) {
                    finalScores.forEach((player, index) => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('py-2', 'px-4', 'rounded-lg', 'mb-2');
                        if (index === 0) { // Highlight the winner
                            listItem.classList.add('bg-yellow-200', 'font-bold', 'text-yellow-800');
                            listItem.innerHTML = `<i class="fas fa-trophy text-yellow-600 mr-2"></i> المركز الأول: ${player.nickname} - ${player.score} نقطة`;
                        } else { // Other players
                            listItem.classList.add('bg-gray-50');
                            listItem.textContent = `${player.nickname} - ${player.score} نقطة`;
                        }
                        finalScoresList.appendChild(listItem);
                    });
                    endTitle.textContent = "انتهت اللعبة!";
                    endMessage.textContent = `فاز ${finalScores[0].nickname} بـ ${finalScores[0].score} نقطة!`;
                } else {
                    endTitle.textContent = "انتهت اللعبة!";
                    endMessage.textContent = "لم يكن هناك لاعبون في هذه الجولة.";
                }

                showScreen(gameEndScreen); // Show the game end screen

            } catch (error) {
                console.error("Error showing final scores:", error);
                showCustomMessageBox("خطأ في النتائج", "فشل عرض النتائج النهائية.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // --- Event Listeners (Handle user interactions) ---
        // When host wants to create a game
        createHostButton.addEventListener('click', () => {
            setupQuizCategorySelection(); // Initialize multi-select dropdown
            showScreen(hostSetupScreen); // Show host setup screen
        });

        // When a player wants to join a game
        joinPlayerButton.addEventListener('click', () => {
            playerNicknameInput.value = localStorage.getItem('playerNickname') || ''; // Pre-fill nickname if saved
            showScreen(joinGameScreen); // Show join game screen
        });

        // Host clicks to create the game instance in Firebase
        createGameButton.addEventListener('click', createGame);

        // Host clicks to start the game (first round) from waiting room
        startGameButton.addEventListener('click', startNextRound); // Reassigned to startNextRound

        // Host clicks to end the current round early
        endRoundEarlyButton.addEventListener('click', endRoundEarly);

        // Host clicks to proceed to the next round from round results screen
        nextRoundButton.addEventListener('click', startNextRound);

        // Host clicks to end the entire game from round results screen
        endGameFinalButton.addEventListener('click', endGame);


        // Player clicks to join a specific room
        joinRoomButton.addEventListener('click', () => {
            const code = gameCodeInput.value.trim().toUpperCase(); // Get game code
            const nickname = playerNicknameInput.value.trim(); // Get player nickname
            if (code && nickname) { // Validate inputs
                joinGame(code, nickname);
            } else {
                showCustomMessageBox("خطأ في الإدخال", "يرجى إدخال رمز الغرفة واسمك المستعار.");
            }
        });

        // Handle player's guess submission on Enter key press
        gameGuessInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                submitGuess(); // Submit the guess
            }
        });

        // Button to play again after a game ends
        playAgainButton.addEventListener('click', () => {
            // Reset all game-related global variables and listeners
            gameId = null;
            isHost = false;
            clearInterval(timerInterval); // Clear any active timer
            if (gameSnapshotUnsubscribe) { // Unsubscribe from Firestore listeners
                gameSnapshotUnsubscribe();
                gameSnapshotUnsubscribe = null;
            }
            if (playersSnapshotUnsubscribe) { // Unsubscribe from Firestore listeners
                playersSnapshotUnsubscribe();
                playersSnapshotUnsubscribe = null;
            }
            selectedQuizIndices = []; // Reset selected quizzes for host setup
            showScreen(roleSelectionScreen); // Return to role selection screen
            window.history.pushState({}, '', window.location.pathname); // Clear gameId from URL
        });

        // Close button for the custom message box
        customMessageCloseButton.addEventListener('click', hideCustomMessageBox);

        // --- Initial Load ---
        // Initialize Firebase when the DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
