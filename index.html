<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حرقاسة HARGASA GAME</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for audio effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* Base font and direction for Arabic */
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            text-align: right;
        }
        /* Custom animation for list items */
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInFromBottom 0.5s ease-out forwards;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4a90e2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the QR code container */
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            min-height: 128px;
        }
        .multiselect-container {
            position: relative;
            width: 100%;
        }
        .multiselect-dropdown {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 10;
            margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .multiselect-dropdown label {
            display: block;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .multiselect-dropdown label:hover {
            background-color: #e2e8f0;
        }
        .multiselect-selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: center;
        }
        .tag {
            background-color: #a78bfa;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .tag-remove:hover {
            opacity: 1;
        }
        /* Styles for points buttons */
        .points-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }
        .points-button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #cbd5e0;
            background-color: #f8fafc;
            color: #4a5568;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .points-button.selected {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .points-button.used {
            background-color: #e2e8f0;
            color: #94a3b8;
            border-color: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.8;
            text-decoration: line-through;
        }
        .points-button:not(.selected):hover {
            background-color: #e2e8f0;
            border-color: #a0aec0;
        }
        .points-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Center text in lists */
        #joined-players-list li,
        #final-scores-list li,
        #question-player-scores-list li {
            text-align: center;
        }
        /* Styles for Power-up buttons */
        .power-ups-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .power-up-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .power-up-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .power-up-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        .power-up-btn:disabled {
            background-color: #9ca3af;
            color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #power-up-double-points { background-color: #f59e0b; color: white; }
        #power-up-extra-time { background-color: #10b981; color: white; }
        #power-up-hint { background-color: #8b5cf6; color: white; }

        /* Responsive adjustments for game play screen elements */
        /* Make game stats row compact on mobile */
        .game-stats-row {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap */
            justify-content: center; /* Center items when they wrap */
            gap: 0.5rem; /* Smaller gap for mobile */
            margin-bottom: 1.5rem;
            width: 100%;
        }
        .game-stats-row > div { /* Target the individual stat items */
            flex-basis: calc(33% - 0.5rem); /* Attempt 3 items per row on mobile (Time, Score, Question Counter) */
            min-width: 100px; /* Minimum width for readability */
            padding: 0.5rem 0.75rem; /* Reduced padding */
            text-align: center; /* Center text inside stat item */
            font-size: 0.9rem; /* Slightly smaller font for mobile stats */
        }
        /* On desktop, revert to original layout for stats */
        @media (min-width: 768px) {
            .game-stats-row {
                flex-wrap: nowrap; /* No wrap on desktop */
                justify-content: space-around;
                gap: 1rem; /* Larger gap for desktop */
            }
            .game-stats-row > div {
                flex-basis: auto; /* Auto width on desktop */
                padding: 1rem 1.5rem; /* Original padding */
                font-size: 1.25rem; /* Original font size */
            }
            /* Specific width adjustments for desktop for better distribution */
            .game-stats-row > div:nth-child(1) { width: 30%; } /* Time */
            .game-stats-row > div:nth-child(2) { width: 25%; } /* Score */
            .game-stats-row > div:nth-child(3) { width: 30%; } /* Question Counter */
        }

        /* Power-ups container on mobile */
        @media (max-width: 767px) {
            .power-ups-container {
                flex-direction: row; /* Keep as row, but wrap */
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem; /* Reduced gap */
            }
            .power-up-btn {
                flex-grow: 1; /* Allow buttons to grow and fill space */
                min-width: 120px; /* Minimum width for buttons */
                padding: 0.4rem 0.8rem; /* Smaller padding */
                font-size: 0.85rem; /* Smaller font */
            }
        }

        /* Adjust input and button in gameplay for better mobile experience */
        .game-input-send {
            flex-direction: column;
            gap: 0.75rem;
        }
        #game-guess-input {
            width: 100%;
        }
        #submit-answer-button {
            width: 100%;
        }

        /* Styles for multiple choice buttons */
        .multiple-choice-option-btn {
            background-color: #a78bfa; /* Purple-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: bold;
            font-size: 1.25rem; /* text-xl */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            width: 100%; /* Full width */
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* shadow-md */
        }
        .multiple-choice-option-btn:hover:not(:disabled) {
            background-color: #8b5cf6; /* Purple-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); /* shadow-lg */
        }
        .multiple-choice-option-btn:disabled {
            background-color: #9ca3af; /* Gray-400 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .multiple-choice-option-btn.selected-option {
            background-color: #4a90e2; /* Blue-500, or a distinct selected color */
            border: 2px solid #3b82f6; /* Blue-600 */
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 min-h-screen flex flex-col items-center justify-center p-4 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center text-white text-xl">
            <div class="loading-spinner mb-4"></div>
            جاري التحميل...
        </div>
    </div>

    <div id="game-countdown-screen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center text-yellow-400 text-9xl font-extrabold z-50 hidden">
        <span id="countdown-timer-display">5</span>
    </div>

    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full flex flex-col items-center relative overflow-hidden">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 text-center leading-tight">لعبة حرقاسة HARGASA GAME <i class="fas fa-users text-blue-500"></i></h1>
        <p class="text-lg text-gray-600 mb-8 text-center" id="game-description">
            اختر دورك: إما مضيف لإنشاء غرفة، أو لاعب للانضمام إلى غرفة موجودة.
        </p>

        <!-- Role Selection Screen -->
        <div id="role-selection-screen" class="w-full flex flex-col items-center space-y-6">
            <button id="create-host-button" class="w-11/12 md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 hover:shadow-2xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-crown"></i> إنشاء غرفة (مضيف)
            </button>
            <button id="join-player-button" class="w-11/12 md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 hover:shadow-2xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-gamepad"></i> الانضمام إلى غرفة (لاعب)
            </button>
        </div>

        <!-- Host Room Setup Screen -->
        <div id="host-setup-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">إعداد غرفة اللعب</h2>

            <div class="w-full md:w-5/6 mb-6">
                <label for="host-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2 text-center">اسمك المستعار (المضيف):</label>
                <input type="text" id="host-nickname-input" placeholder="اسم المضيف"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 bg-gray-50 text-center">
            </div>

            <div class="w-full md:w-5/6 mb-6">
                <label for="quiz-category-input" class="block text-xl font-semibold text-gray-700 mb-2 text-center">اختر فئات الأسئلة:</label>
                <div class="multiselect-container">
                    <input type="text" id="quiz-category-input" readonly placeholder="انقر هنا لاختيار الفئات..."
                            class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 cursor-pointer text-center">
                    <div id="quiz-category-dropdown" class="multiselect-dropdown hidden"></div>
                </div>
                <div id="selected-categories-tags" class="multiselect-selected-tags"></div>
            </div>

            <div class="w-full md:w-5/6 mb-6">
                <label for="total-questions-per-game-select" class="block text-xl font-semibold text-gray-700 mb-2 text-center">عدد الأسئلة الكلي:</label>
                <select id="total-questions-per-game-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 text-center">
                    <option value="5">5 أسئلة</option>
                    <option value="10">10 أسئلة</option>
                    <option value="15">15 سؤال</option>
                    <option value="20">20 سؤال</option>
                    <option value="30">30 سؤال</option>
                </select>
            </div>

            <div class="w-full md:w-5/6 mb-6">
                <label for="time-limit-select" class="block text-xl font-semibold text-gray-700 mb-2 text-center">الوقت لكل سؤال (بالثواني):</label>
                <select id="time-limit-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 text-center">
                    <option value="15">15 ثانية</option>
                    <option value="20">20 ثانية</option>
                    <option value="30">30 ثانية</option>
                    <option value="45">45 ثانية</option>
                    <option value="60">60 ثانية</option>
                </select>
            </div>

            <button id="create-game-button" class="w-11/12 md:w-2/3 bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-plus-circle"></i> إنشاء اللعبة
            </button>
        </div>

        <!-- Waiting Room Screen -->
        <div id="waiting-room-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4" id="waiting-room-title">انتظر انضمام اللاعبين...</h2>
            <p class="text-xl text-gray-700 mb-6">شارك هذا الرابط مع أصدقائك:</p>
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 flex flex-col items-center w-full max-w-lg">
                <span id="game-link-display" class="text-md md:text-xl font-medium text-blue-600 break-all text-center"></span>
                <div id="qrcode" class="my-4 p-2 bg-white rounded-lg shadow-md flex justify-center items-center">
                    <div id="qrcode-fallback-message" class="text-gray-500 text-sm text-center"></div>
                </div>
                <button id="copy-link-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-copy mr-2"></i> انسخ الرابط
                </button>
            </div>
            
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">اللاعبون المنضمون:</h3>
            <ul id="joined-players-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 h-40 overflow-y-auto shadow-inner text-lg"></ul>

            <button id="start-game-button" class="w-11/12 md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out hidden">
                <i class="fas fa-play"></i> بدء اللعب!
            </button>
        </div>

        <!-- Join Game Screen -->
        <div id="join-game-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">الانضمام إلى غرفة اللعب</h2>
            <div class="w-full md:w-5/6 mb-6">
                <label for="game-code-input" class="block text-xl font-semibold text-gray-700 mb-2 text-center">أدخل رمز الغرفة:</label>
                <input type="text" id="game-code-input" placeholder="مثال: 123"
                        class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 transition-colors duration-300 bg-gray-50 uppercase text-center tracking-widest">
            </div>
             <div class="w-full md:w-5/6 mb-6">
                <label for="player-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2 text-center">أدخل اسمك المستعار:</label>
                <input type="text" id="player-nickname-input" placeholder="اسمك"
                        class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 transition-colors duration-300 bg-gray-50 text-center">
            </div>
            <button id="join-room-button" class="w-11/12 md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-door-open"></i> الانضمام
            </button>
        </div>

        <!-- Game Play Screen -->
        <div id="game-play-screen" class="w-full flex flex-col items-center hidden">
            <p class="text-2xl font-bold text-gray-800 mb-4 text-center">الفئة: <span id="game-category" class="text-indigo-600"></span></p>
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md mb-6 w-full text-center">
                <p class="text-2xl font-extrabold text-gray-900" id="game-question"></p>
            </div>

            <!-- Enhanced game stats row for better mobile layout -->
            <div class="game-stats-row flex justify-around items-center w-full mb-6">
                <div class="flex items-center space-x-2 space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-hourglass-half text-blue-500"></i>
                    <span>الوقت: <span id="game-timer" class="text-blue-600">--</span> ثانية</span>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span>نقاطك: <span id="player-score" class="text-yellow-600">0</span></span>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-question-circle text-purple-500"></i>
                    <span>السؤال: <span id="question-counter" class="text-purple-600">-- / --</span></span>
                </div>
            </div>

            <div id="power-ups-container" class="power-ups-container">
                 <button id="power-up-double-points" class="power-up-btn">
                     <i class="fas fa-bolt"></i> ضعف النقاط
                 </button>
                 <button id="power-up-extra-time" class="power-up-btn">
                     <i class="fas fa-clock"></i> وقت إضافي
                 </button>
                 <button id="power-up-hint" class="power-up-btn">
                     <i class="fas fa-lightbulb"></i> استعمال جوكر
                 </button>
            </div>
            
            <div class="w-full mb-6">
                <label class="block text-xl font-semibold text-gray-700 mb-2 text-center">راهن بالنقاط:</label>
                <div id="points-button-group" class="points-button-group"></div>
            </div>

            <!-- Multiple Choice Options Container (initially hidden) -->
            <div id="multiple-choice-options" class="w-full flex flex-col items-center gap-4 mb-4 hidden">
                <!-- Options buttons will be injected here by JavaScript -->
            </div>

            <div class="game-input-send flex items-center flex-wrap gap-2 w-full mb-4">
                <label for="game-guess-input" class="sr-only">اكتب إجابتك هنا</label>
                <input type="text" id="game-guess-input" placeholder="اكتب إجابتك هنا..."
                   class="flex-grow p-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-400 transition-colors duration-300 bg-gray-50 text-center">
                <button id="submit-answer-button" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 hover:shadow-lg transition-all duration-300 ease-out flex-shrink-0">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
            </div>

            
            <div id="host-gameplay-controls" class="w-full flex flex-col items-center gap-4 hidden mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">حالة إجابة اللاعبين (المضيف فقط):</h3>
                <ul id="host-submission-status-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 mb-4 shadow-inner text-base max-h-32 overflow-y-auto"></ul>
                <button id="end-question-early-button" class="w-11/12 md:w-2/3 bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out">
                    <i class="fas fa-flag-checkered"></i> إنهاء السؤال الآن
                </button>
            </div>

            <button id="player-exit-button-gameplay" class="w-11/12 md:w-2/3 bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out mt-6 hidden">
                <i class="fas fa-sign-out-alt"></i> الخروج من اللعبة
            </button>
        </div>

        <!-- Question Results Screen -->
        <div id="question-results-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">نتائج السؤال!</h2>
            <p class="text-xl text-gray-700 mb-6 text-center">الفئة: <span id="results-category" class="font-bold text-indigo-600"></span></p>
            <p class="text-2xl font-semibold text-gray-800 mb-4 text-center">السؤال: <span id="results-question" class="font-bold text-gray-900"></span></p>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الإجابة الصحيحة:</h3>
            <ul id="round-correct-answers-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 max-h-64 overflow-y-auto shadow-inner text-lg list-disc pr-6"></ul>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">أداء اللاعبين في هذا السؤال:</h3>
            <ul id="question-player-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto"></ul>

            <div id="question-results-host-controls" class="w-full flex flex-col items-center gap-4 hidden">
                <button id="next-question-button" class="w-11/12 md:w-2/3 bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                    <i class="fas fa-forward"></i> السؤال التالي
                </button>
                <button id="end-game-final-button" class="w-11/12 md:w-2/3 bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                    <i class="fas fa-times-circle"></i> إنهاء اللعبة
                </button>
            </div>
            <button id="player-exit-button-results" class="w-11/12 md:w-2/3 bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out mt-6 hidden">
                <i class="fas fa-sign-out-alt"></i> الخروج من اللعبة
            </button>
        </div>

        <!-- Game End Screen -->
        <div id="game-end-screen" class="w-full flex flex-col items-center gap-4 hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center" id="end-title">النتائج النهائية للعبة!</h2>
            <p class="text-xl text-gray-600 mb-6 text-center" id="end-message"></p>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الترتيب النهائي:</h3>
            <ul id="final-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto"></ul>

            <button id="start-new-round-same-room-button" class="w-11/12 md:w-2/3 bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out flex items-center justify-center gap-3 mb-4 hidden">
                <i class="fas fa-sync-alt"></i> بدء جولة جديدة بنفس الغرفة
            </button>

            <button id="play-again-button" class="w-11/12 md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 hover:shadow-xl transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-redo"></i> العب مرة أخرى (غرفة جديدة)
            </button>
        </div>

        <!-- Custom Message Box -->
        <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-40 hidden transition-opacity duration-300 ease-out opacity-0">
            <div class="bg-white rounded-xl p-8 text-center shadow-xl transform scale-90 transition-transform duration-300 ease-out">
                <h2 id="custom-message-title" class="text-3xl font-bold text-gray-900 mb-4"></h2>
                <div id="custom-message-content" class="text-xl text-gray-700 mb-6"></div>
                <div id="custom-message-buttons" class="flex justify-center gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Firebase & Other Scripts -->
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <script type="text/javascript">
      // JAVASCRIPT LOGIC
        let app, db, auth, userId, userNickname, appId;
        let gameId = null;
        let isHost = false;
        let gameSnapshotUnsubscribe = null; // Listener for game document changes
        let playersSnapshotUnsubscribe = null; // Listener for players collection changes
        let timerInterval = null; // Interval for local game timer (for all clients)
        let hostTimeUpdater = null; // Interval for host to update remaining time in Firestore
        let selectedPointsBet = 1; // Default selected points bet
        let userUsedPointsBets = []; // Array to store points already used by the current player in the current GAME
        let currentQuestionSoundInterval = null; // Interval for repeated sound effect
        let soundStarted = false; // Flag to control sound playback for time running out
        let localTimerRemaining = 0; // Local state for the timer, updated by clients reading Firestore
        let isDoublePointsActive = false;
        let lobbyMusicLoop = null;
        // Track the currently displayed question index to prevent input clearing on every timer update
        let lastDisplayedQuestionIndex = -1;
        let selectedMultipleChoiceOption = null; // To store the selected option text for multiple choice

        const multipleChoiceOptionsContainer = document.getElementById('multiple-choice-options');
    
        const quizzes = [
            { category: "عواصم الدول العربية", questions: [ { questionText: "ما هي عاصمة تونس؟", displayAnswer: "تونس", correctAnswers: ["تونس", "tunis"] }, { questionText: "ما هي عاصمة مصر؟", displayAnswer: "القاهرة", correctAnswers: ["القاهرة", "cairo"] }, { questionText: "ما هي عاصمة السعودية؟", displayAnswer: "الرياض", correctAnswers: ["الرياض", "riyadh"] }, { questionText: "ما هي عاصمة العراق؟", displayAnswer: "بغداد", correctAnswers: ["بغداد", "baghdad"] }, { questionText: "ما هي عاصمة سوريا؟", displayAnswer: "دمشق", correctAnswers: ["دمشق", "damascus"] }, { questionText: "ما هي عاصمة الأردن؟", displayAnswer: "عمان", correctAnswers: ["عمان", "amman"] }, { questionText: "ما هي عاصمة لبنان؟", displayAnswer: "بيروت", correctAnswers: ["بيروت", "beirut"] }, { questionText: "ما هي عاصمة المغرب؟", displayAnswer: "الرباط", correctAnswers: ["الرباط", "rabat"] }, { questionText: "ما هي عاصمة الجزائر؟", displayAnswer: "الجزائر", correctAnswers: ["الجزائر", "algiers"] }, { questionText: "ما هي عاصمة السودان؟", displayAnswer: "الخرطوم", correctAnswers: ["الخرطوم", "khartoum"] }, { questionText: "ما هي عاصمة اليمن؟", displayAnswer: "صنعاء", correctAnswers: ["صنعاء", "sanaa"] }, { questionText: "ما هي عاصمة الإمارات؟", displayAnswer: "أبو ظبي", correctAnswers: ["ابوظبي", "أبو ظبي", "abu dhabi"] }, { questionText: "ما هي عاصمة قطر؟", displayAnswer: "الدوحة", correctAnswers: ["الدوحة", "doha"] }, { questionText: "ما هي عاصمة الكويت؟", displayAnswer: "الكويت", correctAnswers: ["الكويت", "kuwait"] }, { questionText: "ما هي عاصمة البحرين؟", displayAnswer: "المنامة", correctAnswers: ["المنامة", "manama"] }, { questionText: "ما هي عاصمة الصومال؟", displayAnswer: "مقديشو", correctAnswers: ["مقديشو", "mogadishu"] }, { questionText: "ما هي عاصمة جيبوتي؟", displayAnswer: "جيبوتي", correctAnswers: ["جيبوتي", "djibouti"] }, { questionText: "ما هي عاصمة جزر القمر؟", displayAnswer: "موروني", correctAnswers: ["موروني", "moroni"] }, { questionText: "ما هي عاصمة ليبيا؟", displayAnswer: "طرابلس", correctAnswers: ["طرابلس", "tripoli"] }, { questionText: "ما هي عاصمة موريتانيا؟", displayAnswer: "نواكشوط", correctAnswers: ["نواكشوط", "nouakchott"] }, { questionText: "ما هي عاصمة سلطنة عمان؟", displayAnswer: "مسقط", correctAnswers: ["مسقط", "muscat"] }, { questionText: "ما هي عاصمة فلسطين؟", displayAnswer: "القدس", correctAnswers: ["القدس", "jerusalem"] } ] },
            { category: "الفواكه", questions: [ { questionText: "فاكهة حمراء وصغيرة غالباً ما تستخدم في الحلويات؟", displayAnswer: "فراولة", correctAnswers: ["فراولة", "كرز", "توت"] }, { questionText: "فاكهة صفراء تنمو في مجموعات وغنية بالبوتاسيوم؟", displayAnswer: "موز", correctAnswers: ["موز"] }, { questionText: "فاكهة برتقالية اللون، غنية بفيتامين سي؟", display: "برتقال", correctAnswers: ["برتقال", "يوسفي", "مانجو"] }, { questionText: "فاكهة استوائية كبيرة ذات قشرة خائكة ولحم أصفر حلو جداً؟", displayAnswer: "أناناس", correctAnswers: ["أناناس"] }, { questionText: "فاكهة صيفية كبيرة الحجم، خضراء من الخارج وحمراء من الداخل مع بذور سوداء؟", displayAnswer: "دلاع", correctAnswers: ["دلاع"] } ] },
            { category: "عواصم دول أوروبية", questions: [ { questionText: "ما هي عاصمة ألمانيا؟", displayAnswer: "برلين", correctAnswers: ["برلين", "berlin"] }, { questionText: "ما هي عاصمة فرنسا؟", displayAnswer: "باريس", correctAnswers: ["باريس", "paris"] }, { questionText: "ما هي عاصمة إيطاليا؟", displayAnswer: "روما", correctAnswers: ["روما", "rome"] }, { questionText: "ما هي عاصمة إسبانيا؟", displayAnswer: "مدريد", correctAnswers: ["مدريد", "madrid"] }, { questionText: "ما هي عاصمة المملكة المتحدة؟", displayAnswer: "لندن", correctAnswers: ["لندن", "london"] }, { questionText: "ما هي عاصمة بولندا؟", displayAnswer: "وارسو", correctAnswers: ["وارسو", "warsaw"] }, { questionText: "ما هي عاصمة أوكرانيا؟", displayAnswer: "كييف", correctAnswers: ["كييف", "kiev"] }, { questionText: "ما هي عاصمة رومانيا؟", displayAnswer: "بوخارست", correctAnswers: ["بوخارست", "bucharest"] }, { questionText: "ما هي عاصمة هولندا؟", displayAnswer: "أمستردام", correctAnswers: ["أمستردام", "amsterdam"] }, { questionText: "ما هي عاصمة بلجيكا؟", displayAnswer: "بروكسل", correctAnswers: ["بروكسل", "brussels"] }, { questionText: "ما هي عاصمة اليونان؟", displayAnswer: "أثينا", correctAnswers: ["أثينا", "athens"] }, { questionText: "ما هي عاصمة البرتغال؟", displayAnswer: "لشبونة", correctAnswers: ["لشبونة", "lisbon"] }, { questionText: "ما هي عاصمة السويد؟", displayAnswer: "ستوكهولم", correctAnswers: ["ستوكهولم", "stockholm"] }, { questionText: "ما هي عاصمة النمسا؟", displayAnswer: "فيينا", correctAnswers: ["فيينا", "vienna"] }, { questionText: "ما هي عاصمة سويسرا؟", displayAnswer: "برن", correctAnswers: ["برن", "bern"] }, { questionText: "ما هي عاصمة الدنمارك؟", displayAnswer: "كوبنهاغن", correctAnswers: ["كوبنهاغن", "copenhagen"] }, { questionText: "ما هي عاصمة فنلندا؟", displayAnswer: "هلسنكي", correctAnswers: ["هلسنكي", "helsinki"] }, { questionText: "ما هي عاصمة النرويج؟", displayAnswer: "أوسلو", correctAnswers: ["أوسلو", "oslo"] }, { questionText: "ما هي عاصمة إيرلندا؟", displayAnswer: "دبلن", correctAnswers: ["دبلن", "dublin"] }, { questionText: "ما هي عاصمة كرواتيا؟", displayAnswer: "زغرب", correctAnswers: ["زغرب", "zagreb"] } ] },
            { category: "أمثال شعبية تونسية", questions: [ { questionText: "كمل المثل: قلك عمرك ما تحط القزار في طريق الرجالة ...", displayAnswer: "يجي نهار و تقصدهم حفيان ", correctAnswers: [" يجي نهار و تقصدهم حفيان ", "يجي نهار و تقصدهم حفيان "] }, { questionText: "كمل المثل: إلّي في كرشه التبن...", displayAnswer: "يخاف من النار", correctAnswers: ["يخاف من النار", "يخاف من العافية"] }, { questionText: "كمل المثل: الباب إلّي يجيك منّو الريح...", displayAnswer: "سدّو واستريح", correctAnswers: ["سدّو واستريح", "سدّو"] }, { questionText: "كمل المثل: قطوسة تتغزل في خنافرها...", displayAnswer: "والفار يلعب قدّامها", correctAnswers: ["والفار يلعب قدّامها"] }, { questionText: "كمل المثل: إلّي ما يعرفك...", displayAnswer: "يجهلك", correctAnswers: ["يجهلك"] }, { questionText: "كمل المثل: العزوزة إذا تحفّت...", displayAnswer: "تحنّ للرقص", correctAnswers: ["تحنّ للرقص", "ترقص"] }, { questionText: "كمل المثل: تفرهد القطوس...", displayAnswer: "يلعب بديلو", correctAnswers: ["يلعب بديلو"] }, { questionText: "كمل المثل: طاحت الصمعة...", displayAnswer: "علّقو الحجام", correctAnswers: ["علّقو الحجام", "علقوا الحجام"] }, { questionText: "كمل المثل: لا يعجبه العجب...", displayAnswer: "ولا صيام رجب", correctAnswers: ["ولا صيام رجب"] }, { questionText: "كمل المثل: القطوس ما يهرّبش...", displayAnswer: "على دار فيها لحمة", correctAnswers: ["على دار فيها لحمة", "على الدار فيها لحمة"] }, { questionText: "كمل المثل: إلّي تحبو يكثر...", displayAnswer: "منو الهزار", correctAnswers: ["منو الهزار"] }, { questionText: "كمل المثل: ما يحس الجمرة...", displayAnswer: "كان إلي عافس عليها", correctAnswers: ["كان إلي عافس عليها", "كان الي عافس عليها"] }, { questionText: "كمل المثل: اللّي فيه طبّة...", displayAnswer: "ما ينساهاش", correctAnswers: ["ما ينساهاش"] }, { questionText: "كمل المثل: شد مشومك...", displayAnswer: "لا يجيك ما أشوم منّو", correctAnswers: ["لا يجيك ما أشوم منّو", "ما أشوم منو"] }, { questionText: "كمل المثل: الجمل ما يشوفش...", displayAnswer: "حدبتو", correctAnswers: ["حدبتو"] }, { questionText: "كمل المثل: إلّي يخاف من عشاه...", displayAnswer: "ما يشبعش", correctAnswers: ["ما يشبعش"] }, { questionText: "كمل المثل: قالولو زغرت، قال...", displayAnswer: "نعرف نبكي", correctAnswers: ["نعرف نبكي"] }, { questionText: "كمل المثل: كي تتفرهد العصفورة...", displayAnswer: "تجيها السقطة", correctAnswers: ["تجيها السقطة"] }, { questionText: "كمل المثل: كي تطيح البقرة...", displayAnswer: "يكثروا سكاكينها", correctAnswers: ["يكثروا سكاكينها", "تكتر سكاكينها"] }, { questionText: "كمل المثل: إلّي شاف البلا يصيح...", displayAnswer: "و إلّي ما شافش يقول سحر", correctAnswers: ["و إلّي ما شافش يقول سحر", "اللي ما شافش يقول سحر"] }, { questionText: "كمل المثل: الهدرة كيف السكاكين...", displayAnswer: "تجرح", correctAnswers: ["تجرح"] }, { questionText: "كمل المثل: إلّي ما ربحك...", displayAnswer: "ما يجرحكش", correctAnswers: ["ما يجرحكش"] }, { questionText: "كمل المثل: إلّي يحبك...", displayAnswer: "ما يضربكش بالعصا", correctAnswers: ["ما يضربكش بالعصا"] }, { questionText: "كمل المثل: الطماع يغلبو...", displayAnswer: "الكذاب", correctAnswers: ["الكذاب"] }, { questionText: "كمل المثل: ما يفلّ الحديد...", displayAnswer: "كان الحديد", correctAnswers: ["كان الحديد"] }, { questionText: "كمل المثل: إلّي يعوم ما يخافش...", displayAnswer: "من الموج", correctAnswers: ["من الموج"] }, { questionText: "كمل المثل: قالو لو ثنيها، قال...", displayAnswer: "كي نعدلها", correctAnswers: ["كي نعدلها"] }, { questionText: "كمل المثل: الباهي كيف الذهب...", displayAnswer: "ما يتخبّاش", correctAnswers: ["ما يتخبّاش"] }, { questionText: "كمل المثل: سكران ومبلول...", displayAnswer: "ويطلب في النار", correctAnswers: ["ويطلب في النار"] }, { questionText: "كمل المثل: الجبان...", displayAnswer: "يموت ألف مرّة", correctAnswers: ["يموت ألف مرّة", "يموت ألف مرة"] }, { questionText: "كمل المثل: رزق البخيل...", displayAnswer: "ياكلو العيّار", correctAnswers: ["ياكلو العيّار"] }, { questionText: "كمل المثل: حوت ياكل حوت...", displayAnswer: "وقليل الجهد يموت", correctAnswers: ["وقليل الجهد يموت"] }, { questionText: "كمل المثل: كيف يضيق بيك الحال...", displayAnswer: "رد بالك من الرجال", correctAnswers: ["رد بالك من الرجال"] }, { questionText: "كمل المثل: كثر الهم...", displayAnswer: "يضحّك", correctAnswers: ["يضحّك"] }, { questionText: "كمل المثل: الدنيا كالبحر...", displayAnswer: "يوم هادي ويوم هايج", correctAnswers: ["يوم هادي ويوم هايج"] }, { questionText: "كمل المثل: نعرفك تعوم...", displayAnswer: "وقت الغرق", correctAnswers: ["وقت الغرق"] }, { questionText: "كمل المثل: دابّة ما تعضّيش...", displayAnswer: "ما تخوّفنيش", correctAnswers: ["ما تخوّفنيش"] }, { questionText: "كمل المثل: الكلب كيف يكثر نباحو...", displayAnswer: "ما يعضّيش", correctAnswers: ["ما يعضّيش"] }, { questionText: "كمل المثل: الزين...", displayAnswer: "زين الروح", correctAnswers: ["زين الروح"] }, { questionText: "كمل المثل: ما تشوف بعينك...", displayAnswer: "أصدق من إلّي تسمع بأذنك", correctAnswers: ["أصدق من إلّي تسمع بأذنك"] }, { questionText: "كمل المثل: من طيّب أصله...", displayAnswer: "ما يخونكش", correctAnswers: ["ما يخونكش"] }, { questionText: "كمل المثل: إلّي يطيّحك من السرج...", displayAnswer: "ما هوش صاحبك", correctAnswers: ["ما هوش صاحبك"] }, { questionText: "كمل المثل: ثمة ناس...", displayAnswer: "تلبس ذهب وتخونك", correctAnswers: ["تلبس ذهب وتخونك"] }, { questionText: "كمل المثل: الزوالي كيف...", displayAnswer: "يطيح تكسرولو ضرسو", correctAnswers: ["يطيح تكسرولو ضرسو"] }, { questionText: "كمل المثل: إلّي ما عندوش ظهر...", displayAnswer: "ما يسوى شي", correctAnswers: ["ما يسوى شي"] }, { questionText: "كمل المثل: إلّي يزرع ريح...", displayAnswer: "يحصد العاصفة", correctAnswers: ["يحصد العاصفة"] }, { questionText: "كمل المثل: الكلمة كيف الرصاصة...", displayAnswer: "إذا خرجت ما ترجعش", correctAnswers: ["إذا خرجت ما ترجعش"] }, { questionText: "كمل المثل: اللسان...", displayAnswer: "يكسر العظم", correctAnswers: ["يكسر العظم"] }, { questionText: "كمل المثل: باش تحكم عالناس...", displayAnswer: "شوف أفعالهم", correctAnswers: ["شوف أفعالهم"] }, { questionText: "كمل المثل: ثمة ناس في وجهك مراية...", displayAnswer: "وفي ظهرك سكاكية", correctAnswers: ["وفي ظهرك سكاكية"] }, { questionText: "كمل المثل: الصحبة الزينة...", displayAnswer: "كنز ما يفنى", correctAnswers: ["كنز ما يفنى"] } ] },
            { category: "الثقافة العامة", questions: [ { questionText: "ما اسم عاصمة فلسطين؟", displayAnswer: "القدس", correctAnswers: ["القدس", "القدس الشريف"] }, { questionText: "ما هو الحيوان الذي يُصدر أعلى صوت؟", displayAnswer: "الحوت الأزرق", correctAnswers: ["الحوت الأزرق"] }, { questionText: "في أي سنة قامت الثورة الفرنسية؟", displayAnswer: "1789", correctAnswers: ["1789"] }, { questionText: "من هو أول من رسم خريطة للعالم؟", displayAnswer: "الإدريسي", correctAnswers: ["الإدريسي"] }, { questionText: "ما هو الشيء الذي لا يمشي إلا بالضرب؟", displayAnswer: "المسمار", correctAnswers: ["المسمار"] }, { questionText: "ما اسم أقصر سورة في القرآن؟", displayAnswer: "سورة الكوثر", correctAnswers: ["سورة الكوثر", "الكوثر"] }, { questionText: "كم عدد أسنان الطفل اللبنية؟", displayAnswer: "20", correctAnswers: ["20", "عشرون"] }, { questionText: "ما هو الحيوان الذي يُعتبر أطول الحيوانات رقبة؟", displayAnswer: "الزرافة", correctAnswers: ["الزرافة"] }, { questionText: "ما اسم أول دولة عربية نالت استقلالها؟", displayAnswer: "مصر", correctAnswers: ["مصر"] }, { questionText: "من هو الصحابي الملقب بترجمان القرآن؟", displayAnswer: "عبد الله بن عباس", correctAnswers: ["عبد الله بن عباس", "ابن عباس"] }, { questionText: "ما اسم العملة في بريطانيا؟", displayAnswer: "الجنيه الإسترليني", correctAnswers: ["الجنيه الإسترليني", "إسترليني"] }, { questionText: "في أي دولة يوجد برج بيزا المائل؟", displayAnswer: "إيطاليا", correctAnswers: ["إيطاليا"] }, { questionText: "من هو أول سفير في الإسلام؟", displayAnswer: "مصعب بن عمير", correctAnswers: ["مصعب بن عمير", "مصعب"] }, { questionText: "من هو مؤسس الدولة العباسية؟", displayAnswer: "أبو العباس السفاح", correctAnswers: ["أبو العباس السفاح", "السفاح"] }, { questionText: "ما هو أسرع المخلوقات البحرية؟", displayAnswer: "سمكة الزعنفة الشراعية", correctAnswers: ["سمكة الزعنفة الشراعية", "الزعنفة الشراعية"] }, { questionText: "من أول من آمن من الصبيان؟", displayAnswer: "علي بن أبي طالب", correctAnswers: ["علي بن أبي طالب", "علي"] }, { questionText: "ما اسم الدولة التي يُطلق عليها 'أرض الشمس المشرقة'؟", displayAnswer: "اليابان", correctAnswers: ["اليابان"] }, { questionText: "كم عدد النجوم على علم الولايات المتحدة؟", displayAnswer: "50", correctAnswers: ["50", "خمسون"] }, { questionText: "ما هو المضيق الذي يفصل بين إفريقيا وأوروبا؟", displayAnswer: "مضيق جبل طارق", correctAnswers: ["مضيق جبل طارق", "جبل طارق"] }, { questionText: "من هو الفيلسوف الذي قال: 'أنا أفكر إذن أنا موجود'؟", displayAnswer: "ديكارت", correctAnswers: ["ديكارت", "رينيه ديكارت"] }, { questionText: "ما اسم الكتاب السماوي الذي أُنزل على عيسى عليه السلام؟", displayAnswer: "الإنجيل", correctAnswers: ["الإنجيل"] }, { questionText: "ما اسم المدينة التي تُعرف بمدينة الضباب؟", displayAnswer: "لندن", correctAnswers: ["لندن"] }, { questionText: "كم عدد لاعبي فريق كرة القدم الأساسي؟", displayAnswer: "11", correctAnswers: ["11", "أحد عشر"] }, { questionText: "من هو العالم المسلم الذي اشتهر بالطب والجراحة؟", displayAnswer: "الزهراوي", correctAnswers: ["الزهراوي"] }, { questionText: "ما هو أقدم علم في التاريخ؟", displayAnswer: "الفلك", correctAnswers: ["الفلك", "علم الفلك"] }, { questionText: "من أول من استخدم الشوكة في الأكل؟", displayAnswer: "العرب", correctAnswers: ["العرب"] }, { questionText: "من هو أول من كتب بسم الله الرحمن الرحيم؟", displayAnswer: "سليمان عليه السلام", correctAnswers: ["سليمان", "سليمان عليه السلام"] }, { questionText: "ما اسم الطائر الذي كلمه النبي سليمان؟", displayAnswer: "الهدهد", correctAnswers: ["الهدهد"] }, { questionText: "ما اسم أكبر جزر العالم؟", displayAnswer: "جرينلاند", correctAnswers: ["جرينلاند", "غرينلاند"] }, { questionText: "ما هو الحيوان الذي يمتلك حاسة شم أقوى من الكلب؟", displayAnswer: "الدب", correctAnswers: ["الدب"] }, { questionText: "ما اسم عاصمة ليبيا؟", displayAnswer: "طرابلس", correctAnswers: ["طرابلس"] }, { questionText: "ما اسم أكبر بحيرة عذبة في العالم؟", displayAnswer: "بحيرة سوبيريور", correctAnswers: ["بحيرة سوبيريور"] }, { questionText: "ما هو العلم الذي يدرس الأحياء المجهرية؟", displayAnswer: "علم الميكروبيولوجيا", correctAnswers: ["علم الميكروبيولوجيا", "الميكروبيولوجيا"] }, { questionText: "من هو القائد الذي فتح الأندلس؟", displayAnswer: "طارق بن زياد", correctAnswers: ["طارق بن زياد", "طارق"] }, { questionText: "ما اسم العضو الذي يضخ الدم في الجسم؟", displayAnswer: "القلب", correctAnswers: ["القلب"] }, { questionText: "ما اسم أول دولة فازت بكأس العالم؟", displayAnswer: "الأوروغواي", correctAnswers: ["الأوروغواي", "أوروغواي"] }, { questionText: "من هو الصحابي الذي اهتز له عرش الرحمن؟", displayAnswer: "سعد بن معاذ", correctAnswers: ["سعد بن معاذ", "سعد"] }, { questionText: "ما اسم أكبر مدينة في العالم من حيث عدد السكان؟", displayAnswer: "طوكيو", correctAnswers: ["طوكيو"] }, { questionText: "ما اسم الحيوان الذي يعيش في الماء واليابسة؟", displayAnswer: "الضفدع", correctAnswers: ["الضفدع"] }, { questionText: "كم عدد أجنحة الملَك؟", displayAnswer: "600", correctAnswers: ["600", "ستمئة"] }, { questionText: "من هو الخليفة الذي أنشأ نظام البريد؟", displayAnswer: "عمر بن الخطاب", correctAnswers: ["عمر بن الخطاب", "عمر"] }, { questionText: "من هو العالم الذي اخترع المصعد؟", displayAnswer: "إليشا أوتيس", correctAnswers: ["إليشا أوتيس", "أوتيس"] }, { questionText: "ما هو أصل كلمة 'بنطلون'؟", displayAnswer: "فرنسية", correctAnswers: ["فرنسية"] }, { questionText: "في أي قارة تقع دولة كينيا؟", displayAnswer: "أفريقيا", correctAnswers: ["أفريقيا"] }, { questionText: "ما اسم الجهاز الذي يقيس سرعة الرياح؟", displayAnswer: "الأنيمومتر", correctAnswers: ["الأنيمومتر"] }, { questionText: "من هو الشاعر الجاهلي الذي لقب بالملك الضليل؟", displayAnswer: "امرؤ القيس", correctAnswers: ["امرؤ القيس"] }, { questionText: "كم عدد عيون النحلة؟", displayAnswer: "5", correctAnswers: ["5", "خمسة"] }, { questionText: "ما اسم الجبل الذي كلم الله عليه موسى؟", displayAnswer: "جبل الطور", correctAnswers: ["جبل الطور", "الطور"] }, { questionText: "ما اسم الكتاب الذي كتبه ابن خلدون؟", displayAnswer: "المقدمة", correctAnswers: ["المقدمة"] }, { questionText: "ما اسم أكبر نهر في أوروبا؟", displayAnswer: "نهر الفولغا", correctAnswers: ["نهر الفولغا", "الفولغا"] }, { questionText: "من هو أول من خطّ بالقلم؟", displayAnswer: "إدريس عليه السلام", correctAnswers: ["إدريس", "إدريس عليه السلام"] }, { questionText: "ما هو أول شيء خلقه الله؟", displayAnswer: "القلم", correctAnswers: ["القلم"] }, { questionText: "ما اسم الغاز الذي تنفثه السيارات؟", displayAnswer: "ثاني أكسيد الكربون", correctAnswers: ["ثاني أكسيد الكربون", "CO2"] }, { questionText: "ما اسم أبطأ الكائنات في العالم؟", displayAnswer: "الكسلان", correctAnswers: ["الكسلان"] }, { questionText: "من هو صاحب كتاب 'الأغاني'؟", displayAnswer: "أبو الفرج الأصفهاني", correctAnswers: ["أبو الفرج الأصفهاني"] }, { questionText: "ما اسم أول دولة عربية استضافت كأس العالم؟", displayAnswer: "قطر", correctAnswers: ["قطر"] }, { questionText: "ما اسم الدولة التي تتكون من 7000 جزيرة؟", displayAnswer: "الفلبين", correctAnswers: ["الفلبين"] }, { questionText: "من هو الصحابي الذي جمع القرآن الكريم في عهد عثمان؟", displayAnswer: "زيد بن ثابت", correctAnswers: ["زيد بن ثابت", "زيد"] }, { questionText: "كم عدد أرجل الحشرة؟", displayAnswer: "6", correctAnswers: ["6", "ستة"] }, { questionText: "من أول من سكن مكة؟", displayAnswer: "قبيلة جرهم", correctAnswers: ["قبيلة جرهم", "جرهم"] }, { questionText: "ما اسم أول كائن خلقه الله من الملائكة؟", displayAnswer: "جبريل", correctAnswers: ["جبريل"] }, { questionText: "ما اسم المرض الذي يُصيب كريات الدم الحمراء؟", displayAnswer: "فقر الدم", correctAnswers: ["فقر الدم", "أنيميا"] }, { questionText: "ما اسم وحدة قياس الضغط الجوي؟", displayAnswer: "بار", correctAnswers: ["بار"] }, { questionText: "ما اسم أصغر قارة في العالم؟", displayAnswer: "أوقيانوسيا", correctAnswers: ["أوقيانوسيا"] } ] },
            { category: " اسئلة الشلة ", questions: [ { questionText: " كي نقولو كنترول شنوة يجي للبالك ؟  ", displayAnswer: "كعبورة", correctAnswers: ["لمكعبر", "كعبر" , " ka3boura " , " كعبورة "   ] }, { questionText: "    شكون الي يفلم برشا في الشلة و يحب يجيبها يعرف كل شي ؟    ", displayAnswer: " ولد الورغي  ", correctAnswers: [" lou ", "لؤي" , " louay " , " ولد الورغي " ] }, { questionText: " قلك عمرك ما ترمي القزاز في طريق الرجالة ... ", displayAnswer: "يجي نهار و تقصدهم حفيان ، و اضرب نعنبو الي بكاهم واطا واطططططط ", correctAnswers: ["يجي نهار و تقصدهم حفيان", "واطططططط"] }, { questionText: "قلك على شلة تجي كل يوم للقهوة علالة و لا نهار قعدو مع طفلة ", displayAnswer: "شلتنا", correctAnswers: ["النياكة", "المكاحيط" , " المنيكين " ] }, { questionText: "شكون انيك واحد في الشلة ؟  ", displayAnswer: "كلكم كي زبي ", correctAnswers: ["الكل", "hama" , " الزعيم "  , " za3im " , " louay " , "ka3boura" , " lahdir " , " hayder "] }, { questionText: "رسلان  علاه معادش يقعد معانا ؟    ", displayAnswer: "رجولية هاذي ؟ وبنة نرا دينمها ... تبع لبنات تو تربح", correctAnswers: ["nour ", "نور" , " miboun "  , " ميبون " , " تبع لبنات " , "نور " , " نور متاع زبي  " , " wabna "] }, { questionText: "كعبورة قداه من مرة طاح كنترول ؟    ", displayAnswer: "قول قداه من مرة نجح برانسيبال ههه  ", correctAnswers: ["5", "2" , " 3 "  , " 4 " , " louay " , "ka3boura" , " lahdir " , " hayder "] }, { questionText: "شكون اكثر واحد يكره صاحبة الحرقاسة ؟ ", displayAnswer: "ولد الورغي اكيد ", correctAnswers: ["ولد الورغي", "louay" , "لؤي" ] } ] },
            { category: "حيوانات الغابة", questions: [ { questionText: "ملك الغابة؟", displayAnswer: "أسد", correctAnswers: ["أسد", "اسد"] }, { questionText: "حيوان مخطط بالأبيض والأسود يشبه الحصان؟", displayAnswer: "حمار وحشي", correctAnswers: ["حمار وحشي", "حماروحشي"] }, { questionText: "أكبر حيوان بري على وجه الأرض، بخرطوم طويل وأذنين كبيرتين؟", displayAnswer: "فيل", correctAnswers: ["فيل", "الفيل"] }, { questionText: "حيوان طويل العنق ذو بقع بنية، يتغذى على أوراق الأشجار العالية؟", displayAnswer: "زرافة", correctAnswers: ["زرافة", "الزرافة"] }, { questionText: "حيوان ذكي يعيش في الغابات يأكل الموز ويتأرجح بين الأشجار؟", displayAnswer: "قرد", correctAnswers: ["قرد", "القرد"] } ] },
            { category: "عواصم دول العالم (غير العربية)", questions: [ { questionText: "ما هي عاصمة اليابان؟", displayAnswer: "طوكيو", correctAnswers: ["طوكيو", "tokyo"] }, { questionText: "ما هي عاصمة الولايات المتحدة الأمريكية؟", displayAnswer: "واشنطن", correctAnswers: ["واشنطن", "washington"] }, { questionText: "ما هي عاصمة روسيا؟", displayAnswer: "موسكو", correctAnswers: ["موسكو", "moscow"] }, { questionText: "ما هي عاصمة الصين؟", displayAnswer: "بكين", correctAnswers: ["بكين", "beijing"] }, { questionText: "ما هي عاصمة الهند؟", displayAnswer: "نيودلهي", correctAnswers: ["نيودلهي", "new delhi"] } ] },
            { category: "أسئلة تونسية", questions: [ { questionText: "شنوة عاصمة تونس؟", displayAnswer: "تونس", correctAnswers: ["تونس", "tunis", "tounes"] }, { questionText: "شنوة اسم العملة التونسية؟", displayAnswer: "دينار", correctAnswers: ["دينار", "dinar", "دنيار"] }, { questionText: "شكون ربح كاس افريقيا 2004؟", displayAnswer: "تونس", correctAnswers: ["تونس", "المنتخب التونسي", "tounes", "منتخب تونس"] }, { questionText: "شنوة اسم أطول واد في تونس؟", displayAnswer: "واد مجردة", correctAnswers: ["واد مجردة", "مجردة", "وادي مجردة", "oued mejerdah"] }, { questionText: "شكون الرئيس الأول لتونس؟", displayAnswer: "الحبيب بورقيبة", correctAnswers: ["الحبيب بورقيبة", "بورقيبة", "حبيب بورقيبة", "bourguiba"] }, { questionText: "شنوة اسم مدينة تونسية مشهورة بالحمامات الطبيعية؟", displayAnswer: "حمام الأنف", correctAnswers: ["حمام الأنف", "حمام الانف", "hammam linf", "hamam lanf"] }, { questionText: "شنوة الأكلة التونسية المشهورة اللي فيها كسكسي وخضرة ولحم؟", displayAnswer: "كسكسي", correctAnswers: ["كسكسي", "كسكس", "couscous"] }, { questionText: "شنوة العاصمة الثقافية لتونس؟", displayAnswer: "القيروان", correctAnswers: ["القيروان", "kairouan", "kayrawan"] }, { questionText: "شنوة اسم أشهر طبق حلويات تونسي في الأعياد؟", display: "المقروض", correctAnswers: ["المقروض", "مقروض", "makroudh"] }, { questionText: "أكبر جزيرة تونسية؟", displayAnswer: "جربة", correctAnswers: ["جربة", "djerba", "jareba"] }, { questionText: "شنوة اسم الجبل الأعلى في تونس؟", displayAnswer: "جبل الشعانبي", correctAnswers: ["جبل الشعانبي", "الشعانبي", "chambi"] }, { questionText: "فنان تونسي مشهور بأغنية 'يا ليلى يا ليلة'؟", displayAnswer: "صابر الرباعي", correctAnswers: ["صابر الرباعي", "رباعي", "saber rebai"] }, { questionText: "شنوة اسم بحيرة تونسية مشهورة بالطيور المهاجرة؟", displayAnswer: "بحيرة إشكل", correctAnswers: ["بحيرة إشكل", "إشكل", "ichkeul"] }, { questionText: "اسم الملعب الوطني في تونس العاصمة؟", displayAnswer: "ملعب حمادي العقربي", correctAnswers: ["ملعب حمادي العقربي", "ملعب رادس", "رادس", "hamadi agerbi"] }, { questionText: "في أي ولاية تونسية توجد مدينة دقة الأثرية؟", displayAnswer: "باجة", correctAnswers: ["باجة", "beja"] } ] },
            // NEW CATEGORY: Tunisian & General Knowledge Multiple Choice Questions
            {
                category: "أسئلة تونسية وعالمية (متعددة الخيارات)",
                questions: [
                    {
                        questionText: "ما هي عاصمة ولاية صفاقس؟",
                        options: ["سوسة", "صفاقس", "المنستير"], // Reduced to 3 options
                        correctAnswerIndex: 1, // 'صفاقس'
                        displayAnswer: "صفاقس",
                        correctAnswers: ["صفاقس", "sfax"]
                    },
                    {
                        questionText: "من هو أول رئيس للجمهورية التونسية؟",
                        options: ["الحبيب بورقيبة", "الهادي نويرة", "زين العابدين بن علي"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الحبيب بورقيبة",
                        correctAnswers: ["الحبيب بورقيبة", "بورقيبة"]
                    },
                    {
                        questionText: "كم عدد أركان الإسلام؟",
                        options: ["4", "5", "6"],
                        correctAnswerIndex: 1,
                        displayAnswer: "5",
                        correctAnswers: ["5", "خمسة", "خمسة أركان"]
                    },
                    {
                        questionText: "في أي سنة تأسست جامعة الزيتونة؟",
                        options: ["737م", "988م", "1147م"],
                        correctAnswerIndex: 0,
                        displayAnswer: "737م",
                        correctAnswers: ["737", "737م", "القرن الثامن"]
                    },
                    {
                        questionText: "من هو أول من أسلم من الصبيان؟",
                        options: ["علي بن أبي طالب", "عبد الله بن مسعود", "عثمان بن عفان"],
                        correctAnswerIndex: 0,
                        displayAnswer: "علي بن أبي طالب",
                        correctAnswers: ["علي بن أبي طالب", "علي"]
                    },
                    {
                        questionText: "ما هو أكبر محيط في العالم؟",
                        options: ["الأطلسي", "الهندي", "الهادئ"],
                        correctAnswerIndex: 2,
                        displayAnswer: "الهادئ",
                        correctAnswers: ["الهادئ", "المحيط الهادئ"]
                    },
                    {
                        questionText: "في أي ولاية تونسية تقع مدينة الكاف؟",
                        options: ["الكاف", "سليانة", "جندوبة"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الكاف",
                        correctAnswers: ["الكاف"]
                    },
                    {
                        questionText: "من هو خاتم الأنبياء؟",
                        options: ["عيسى عليه السلام", "محمد صلى الله عليه وسلم", "موسى عليه السلام"],
                        correctAnswerIndex: 1,
                        displayAnswer: "محمد صلى الله عليه وسلم",
                        correctAnswers: ["محمد", "محمد صلى الله عليه وسلم"]
                    },
                    {
                        questionText: "ما هو الكوكب المعروف بالكوكب الأحمر؟",
                        options: ["الزهرة", "المريخ", "عطارد"],
                        correctAnswerIndex: 1,
                        displayAnswer: "المريخ",
                        correctAnswers: ["المريخ"]
                    },
                    {
                        questionText: "ما هو اسم الرئيس التونسي الذي خلف زين العابدين بن علي سنة 2011؟",
                        options: ["المنصف المرزوقي", "الباجي قائد السبسي", "محمد الغنوشي"],
                        correctAnswerIndex: 0,
                        displayAnswer: "المنصف المرزوقي",
                        correctAnswers: ["المنصف المرزوقي", "المرزوقي"]
                    },
                    {
                        questionText: "كم عدد الركعات في صلاة الفجر؟",
                        options: ["2", "3", "4"],
                        correctAnswerIndex: 0,
                        displayAnswer: "2",
                        correctAnswers: ["2", "ركعتان", "ركعتين"]
                    },
                    {
                        questionText: "ما هي العاصمة الاقتصادية لتونس؟",
                        options: ["تونس", "صفاقس", "سوسة"],
                        correctAnswerIndex: 1,
                        displayAnswer: "صفاقس",
                        correctAnswers: ["صفاقس", "Sfax"]
                    },
                    {
                        questionText: "من هو النبي الذي فُضّل بكثرة المال والذرية؟",
                        options: ["سليمان", "إبراهيم", "أيوب"],
                        correctAnswerIndex: 0,
                        displayAnswer: "سليمان",
                        correctAnswers: ["سليمان", "النبي سليمان"]
                    },
                    {
                        questionText: "في أي قارة تقع الأرجنتين؟",
                        options: ["أمريكا الجنوبية", "أوروبا", "أفريقيا"],
                        correctAnswerIndex: 0,
                        displayAnswer: "أمريكا الجنوبية",
                        correctAnswers: ["أمريكا الجنوبية"]
                    },
                    {
                        questionText: "ما هو اسم عاصمة المغرب؟",
                        options: ["الدار البيضاء", "الرباط", "فاس"],
                        correctAnswerIndex: 1,
                        displayAnswer: "الرباط",
                        correctAnswers: ["الرباط"]
                    },
                    {
                        questionText: "في أي سنة هبط الإنسان على سطح القمر؟",
                        options: ["1969", "1972", "1965"],
                        correctAnswerIndex: 0,
                        displayAnswer: "1969",
                        correctAnswers: ["1969", "سنة 1969"]
                    },
                    {
                        questionText: "ما هي السورة التي تُعرف بسورة النور؟",
                        options: ["النور", "الرحمن", "الكوثر"],
                        correctAnswerIndex: 0,
                        displayAnswer: "النور",
                        correctAnswers: ["سورة النور", "النور"]
                    },
                    {
                        questionText: "ما هي ثاني أكبر مدينة تونسية بعد العاصمة؟",
                        options: ["صفاقس", "سوسة", "قفصة"],
                        correctAnswerIndex: 0,
                        displayAnswer: "صفاقس",
                        correctAnswers: ["صفاقس"]
                    },
                    {
                        questionText: "ما هو العلم الذي يدرس الظواهر الاقتصادية؟",
                        options: ["علم النفس", "الاقتصاد", "الاجتماع"],
                        correctAnswerIndex: 1,
                        displayAnswer: "الاقتصاد",
                        correctAnswers: ["الاقتصاد"]
                    },
                    {
                        questionText: "من أول من نزل عليه الوحي من الملائكة؟",
                        options: ["ميكائيل", "جبريل", "إسرافيل"],
                        correctAnswerIndex: 1,
                        displayAnswer: "جبريل",
                        correctAnswers: ["جبريل", "الملك جبريل"]
                    },
                    {
                        questionText: "من هو مؤسس الدولة العثمانية؟",
                        options: ["عثمان بن أرطغرل", "محمد الفاتح", "سليمان القانوني"],
                        correctAnswerIndex: 0,
                        displayAnswer: "عثمان بن أرطغرل",
                        correctAnswers: ["عثمان", "عثمان بن أرطغرل"]
                    },
                    {
                        questionText: "ما هو البحر الذي يربط بين أوروبا وأفريقيا؟",
                        options: ["البحر الأبيض المتوسط", "البحر الأسود", "المحيط الأطلسي"],
                        correctAnswerIndex: 0,
                        displayAnswer: "البحر الأبيض المتوسط",
                        correctAnswers: ["المتوسط", "البحر الأبيض"]
                    },
                    {
                        questionText: "كم عدد الخلفاء الراشدين؟",
                        options: ["3", "4", "5"],
                        correctAnswerIndex: 1,
                        displayAnswer: "4",
                        correctAnswers: ["4", "أربعة"]
                    },
                    {
                        questionText: "أين يقع جامع الزيتونة؟",
                        options: ["صفاقس", "القيروان", "تونس العاصمة"],
                        correctAnswerIndex: 2,
                        displayAnswer: "تونس العاصمة",
                        correctAnswers: ["تونس", "العاصمة"]
                    },
                    {
                        questionText: "من هو أول من نطق بالعربية الفصحى؟",
                        options: ["إسماعيل", "آدم", "إبراهيم"],
                        correctAnswerIndex: 0,
                        displayAnswer: "إسماعيل",
                        correctAnswers: ["إسماعيل", "النبي إسماعيل"]
                    },
                    {
                        questionText: "من هو الشاعر الذي قال: 'إذا الشعب يومًا أراد الحياة'؟",
                        options: ["نزار قباني", "أبو القاسم الشابي", "إيليا أبو ماضي"],
                        correctAnswerIndex: 1,
                        displayAnswer: "أبو القاسم الشابي",
                        correctAnswers: ["الشابي", "أبو القاسم الشابي"]
                    },
                    {
                        questionText: "ما هي الدولة الوحيدة التي لا تملك جيشًا؟",
                        options: ["الفاتيكان", "كوستاريكا", "سويسرا"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الفاتيكان",
                        correctAnswers: ["الفاتيكان"]
                    },
                    {
                        questionText: "ما هو عدد أحزاب الصلاة؟",
                        options: ["30", "60", "120"],
                        correctAnswerIndex: 1,
                        displayAnswer: "60",
                        correctAnswers: ["60", "ستون"]
                    },
                    {
                        questionText: "من هو أول من أسلم من الرجال؟",
                        options: ["أبو بكر الصديق", "عمر بن الخطاب", "عثمان بن عفان"],
                        correctAnswerIndex: 0,
                        displayAnswer: "أبو بكر الصديق",
                        correctAnswers: ["أبو بكر", "الصديق"]
                    },
                    {
                        questionText: "ما هو اسم الجبل الذي كلّم الله عليه موسى؟",
                        options: ["جبل عرفات", "جبل النور", "جبل الطور"],
                        correctAnswerIndex: 2,
                        displayAnswer: "جبل الطور",
                        correctAnswers: ["الطور", "جبل الطور"]
                    },
                    {
                        questionText: "ما هي الدولة التي تُعد أكبر منتج لليورانيوم في العالم؟",
                        options: ["كازاخستان", "كندا", "الولايات المتحدة"],
                        correctAnswerIndex: 0,
                        displayAnswer: "كازاخستان",
                        correctAnswers: ["كازاخستان"]
                    },
                    {
                        questionText: "من هو مؤلف رواية 'الجريمة والعقاب'؟",
                        options: ["دوستويفسكي", "تولستوي", "تشيخوف"],
                        correctAnswerIndex: 0,
                        displayAnswer: "دوستويفسكي",
                        correctAnswers: ["دوستويفسكي", "فيودور دوستويفسكي"]
                    },
                    {
                        questionText: "ما هو العنصر الكيميائي الذي رمزه Sn؟",
                        options: ["الزنك", "القصدير", "الرصاص"],
                        correctAnswerIndex: 1,
                        displayAnswer: "القصدير",
                        correctAnswers: ["قصدير", "القصدير"]
                    },
                    {
                        questionText: "في أي سنة سقط جدار برلين؟",
                        options: ["1987", "1989", "1991"],
                        correctAnswerIndex: 1,
                        displayAnswer: "1989",
                        correctAnswers: ["1989"]
                    },
                    {
                        questionText: "من هو الفيلسوف اليوناني الذي تتلمذ على يد سقراط؟",
                        options: ["أرسطو", "أفلاطون", "طاليس"],
                        correctAnswerIndex: 1,
                        displayAnswer: "أفلاطون",
                        correctAnswers: ["أفلاطون"]
                    },
                    {
                        questionText: "ما هي أول دولة اعترفت بالولايات المتحدة الأمريكية؟",
                        options: ["فرنسا", "المغرب", "إسبانيا"],
                        correctAnswerIndex: 1,
                        displayAnswer: "المغرب",
                        correctAnswers: ["المغرب"]
                    },
                    {
                        questionText: "أي من الكواكب التالية يُعد الأبعد عن الشمس؟",
                        options: ["أورانوس", "نبتون", "زحل"],
                        correctAnswerIndex: 1,
                        displayAnswer: "نبتون",
                        correctAnswers: ["نبتون"]
                    },
                    {
                        questionText: "في أي بلد نشأت لعبة الشطرنج؟",
                        options: ["الهند", "الصين", "إيران"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الهند",
                        correctAnswers: ["الهند"]
                    },
                    {
                        questionText: "ما هو الاسم القديم لفرنسا في العصور الرومانية؟",
                        options: ["غاليا", "لومبارديا", "بيزنطة"],
                        correctAnswerIndex: 0,
                        displayAnswer: "غاليا",
                        correctAnswers: ["غاليا", "Gaul"]
                    },
                    {
                        questionText: "كم يبلغ عدد العظام في جسم الإنسان البالغ؟",
                        options: ["206", "210", "204"],
                        correctAnswerIndex: 0,
                        displayAnswer: "206",
                        correctAnswers: ["206"]
                    },
                    {
                        questionText: "في أي دولة يقع بركان فيزوف؟",
                        options: ["إيطاليا", "البرتغال", "اليونان"],
                        correctAnswerIndex: 0,
                        displayAnswer: "إيطاليا",
                        correctAnswers: ["إيطاليا"]
                    },
                    {
                        questionText: "من هو مبتكر نظرية النسبية؟",
                        options: ["نيوتن", "أينشتاين", "هايزنبرغ"],
                        correctAnswerIndex: 1,
                        displayAnswer: "أينشتاين",
                        correctAnswers: ["أينشتاين", "ألبرت أينشتاين"]
                    },
                    {
                        questionText: "ما هو الحيوان الذي يُلقب بملك الغابة؟",
                        options: ["النمر", "الأسد", "الفهد"],
                        correctAnswerIndex: 1,
                        displayAnswer: "الأسد",
                        correctAnswers: ["الأسد"]
                    },
                    {
                        questionText: "من هو الشاعر الذي كتب 'المعلقات' ولقب بـ 'ملك الشعراء'؟",
                        options: ["عنترة بن شداد", "امرؤ القيس", "زهير بن أبي سلمى"],
                        correctAnswerIndex: 1,
                        displayAnswer: "امرؤ القيس",
                        correctAnswers: ["امرؤ القيس"]
                    },
                    {
                        questionText: "أي دولة تملك أكبر عدد من الجزر في العالم؟",
                        options: ["السويد", "إندونيسيا", "الفلبين"],
                        correctAnswerIndex: 0,
                        displayAnswer: "السويد",
                        correctAnswers: ["السويد"]
                    },
                    {
                        questionText: "من هو أول من دار حول الأرض؟",
                        options: ["يوري غاغارين", "جون غلين", "أرمسترونغ"],
                        correctAnswerIndex: 0,
                        displayAnswer: "يوري غاغارين",
                        correctAnswers: ["يوري غاغارين"]
                    },
                    {
                        questionText: "في أي سنة تأسست منظمة الصحة العالمية؟",
                        options: ["1945", "1948", "1952"],
                        correctAnswerIndex: 1,
                        displayAnswer: "1948",
                        correctAnswers: ["1948"]
                    },
                    {
                        questionText: "ما هو أقدم علم وُضع للإنسان؟",
                        options: ["الفلك", "الطب", "الفلسفة"],
                        correctAnswerIndex: 2,
                        displayAnswer: "الفلسفة",
                        correctAnswers: ["الفلسفة"]
                    },
                    {
                        questionText: "ما اسم الكوكب الذي له أكبر عدد من الأقمار؟",
                        options: ["زحل", "المشتري", "أورانوس"],
                        correctAnswerIndex: 1,
                        displayAnswer: "المشتري",
                        correctAnswers: ["المشتري"]
                    },
                    {
                        questionText: "ما هي العاصمة الحالية للنمسا؟",
                        options: ["فيينا", "براغ", "ميونيخ"],
                        correctAnswerIndex: 0,
                        displayAnswer: "فيينا",
                        correctAnswers: ["فيينا"]
                    },
                    {
                        questionText: "من هو الرسام الشهير الذي رسم لوحة 'الصرخة'؟",
                        options: ["فان غوخ", "إدفارد مونك", "بيكاسو"],
                        correctAnswerIndex: 1,
                        displayAnswer: "إدفارد مونك",
                        correctAnswers: ["إدفارد مونك", "مونك"]
                    },
                    {
                        questionText: "ما هي الدولة الوحيدة التي لا تتغير فيها الساعة حسب الفصول؟",
                        options: ["اليابان", "الجزائر", "سريلانكا"],
                        correctAnswerIndex: 0,
                        displayAnswer: "اليابان",
                        correctAnswers: ["اليابان"]
                    },
                    {
                        questionText: "ما هي أصغر قارة في العالم؟",
                        options: ["أوروبا", "أوقيانوسيا", "أستراليا"],
                        correctAnswerIndex: 2,
                        displayAnswer: "أستراليا",
                        correctAnswers: ["أستراليا"]
                    },
                    {
                        questionText: "ما هو أقدم دستور مكتوب في العالم لا يزال معمولًا به؟",
                        options: ["دستور بريطانيا", "دستور الولايات المتحدة", "دستور فرنسا"],
                        correctAnswerIndex: 1,
                        displayAnswer: "دستور الولايات المتحدة",
                        correctAnswers: ["الولايات المتحدة"]
                    },
                    {
                        questionText: "من هو مخترع المصباح الكهربائي؟",
                        options: ["إديسون", "فاراداي", "تسلا"],
                        correctAnswerIndex: 0,
                        displayAnswer: "إديسون",
                        correctAnswers: ["إديسون", "توماس إديسون"]
                    },
                    {
                        questionText: "في أي قارة يقع نهر الأمازون؟",
                        options: ["أمريكا الشمالية", "أمريكا الجنوبية", "أفريقيا"],
                        correctAnswerIndex: 1,
                        displayAnswer: "أمريكا الجنوبية",
                        correctAnswers: ["أمريكا الجنوبية"]
                    },
                    {
                        questionText: "ما هي الدولة التي تُعد مهد الألعاب الأولمبية؟",
                        options: ["إيطاليا", "اليونان", "فرنسا"],
                        correctAnswerIndex: 1,
                        displayAnswer: "اليونان",
                        correctAnswers: ["اليونان"]
                    },
                    {
                        questionText: "من أول من استخدم الورق في الكتابة؟",
                        options: ["الرومان", "الصينيون", "الفرس"],
                        correctAnswerIndex: 1,
                        displayAnswer: "الصينيون",
                        correctAnswers: ["الصينيون", "الصين"]
                    },
                    {
                        questionText: "ما هو أضخم حيوان على وجه الأرض؟",
                        options: ["الفيل", "الحوت الأزرق", "فرس النهر"],
                        correctAnswerIndex: 1,
                        displayAnswer: "الحوت الأزرق",
                        correctAnswers: ["الحوت الأزرق"]
                    },
                    {
                        questionText: "من كتب رواية 'مئة عام من العزلة'؟",
                        options: ["غابرييل غارسيا ماركيز", "إرنست همنغواي", "باولو كويلو"],
                        correctAnswerIndex: 0,
                        displayAnswer: "غابرييل غارسيا ماركيز",
                        correctAnswers: ["ماركيز", "غابرييل"]
                    },
                    {
                        questionText: "ما هو الجهاز المسؤول عن تنقية الدم في جسم الإنسان؟",
                        options: ["الكبد", "القلب", "الكلى"],
                        correctAnswerIndex: 2,
                        displayAnswer: "الكلى",
                        correctAnswers: ["الكلى"]
                    },
                    {
                        questionText: "ما هو العنصر الوحيد الذي لا يحتوي على نيوترونات؟",
                        options: ["الهيدروجين", "الهيليوم", "الليثيوم"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الهيدروجين",
                        correctAnswers: ["الهيدروجين"]
                    },
                    {
                        questionText: "ما هو الجزء من الدماغ المسؤول عن التوازن؟",
                        options: ["المخيخ", "الفص الجبهي", "النخاع الشوكي"],
                        correctAnswerIndex: 0,
                        displayAnswer: "المخيخ",
                        correctAnswers: ["المخيخ"]
                    },
                    {
                        questionText: "كم عدد أزواج الكروموسومات في جسم الإنسان؟",
                        options: ["23", "22", "24"],
                        correctAnswerIndex: 0,
                        displayAnswer: "23",
                        correctAnswers: ["23", "23 زوجًا"]
                    },
                    {
                        questionText: "في الرياضيات، ما هو اسم العدد غير النسبي الذي يساوي تقريبًا 3.14159؟",
                        options: ["باي", "إي", "جذر 2"],
                        correctAnswerIndex: 0,
                        displayAnswer: "باي",
                        correctAnswers: ["باي", "π"]
                    },
                    {
                        questionText: "أي من العضلات التالية تعمل بشكل لا إرادي فقط؟",
                        options: ["القلب", "عضلات الذراع", "عضلات البطن"],
                        correctAnswerIndex: 0,
                        displayAnswer: "القلب",
                        correctAnswers: ["القلب"]
                    },
                    {
                        questionText: "ما هو اسم النظرية التي تصف العلاقة بين الزمان والمكان؟",
                        options: ["نظرية الكم", "النسبية العامة", "الاحتمالات"],
                        correctAnswerIndex: 1,
                        displayAnswer: "النسبية العامة",
                        correctAnswers: ["النسبية العامة", "نظرية النسبية"]
                    },
                    {
                        questionText: "ما هو أقرب كوكب إلى الشمس؟",
                        options: ["عطارد", "الزهرة", "المريخ"],
                        correctAnswerIndex: 0,
                        displayAnswer: "عطارد",
                        correctAnswers: ["عطارد"]
                    },
                    {
                        questionText: "ما هو الغاز الذي يُستخدم في تبريد أجهزة التكييف؟",
                        options: ["الأمونيا", "الفريون", "الميثان"],
                        correctAnswerIndex: 1,
                        displayAnswer: "الفريون",
                        correctAnswers: ["فريون", "الفريون"]
                    },
                    {
                        questionText: "ما هي وحدة قياس الشحنة الكهربائية؟",
                        options: ["أوم", "فولت", "كولوم"],
                        correctAnswerIndex: 2,
                        displayAnswer: "كولوم",
                        correctAnswers: ["كولوم"]
                    },
                    {
                        questionText: "من هو الفيلسوف الذي قال: «أنا أفكر إذن أنا موجود»؟",
                        options: ["سقراط", "ديكارت", "أفلاطون"],
                        correctAnswerIndex: 1,
                        displayAnswer: "ديكارت",
                        correctAnswers: ["ديكارت", "رينيه ديكارت"]
                    },
                    {
                        questionText: "في الفلك، كم عدد الكواكب القزمة المعترف بها رسميًا؟",
                        options: ["5", "7", "3"],
                        correctAnswerIndex: 0,
                        displayAnswer: "5",
                        correctAnswers: ["5", "خمسة"]
                    },
                    {
                        questionText: "ما هو البروتين المسؤول عن نقل الأوكسجين في الدم؟",
                        options: ["الهيموغلوبين", "الكرياتين", "الألبومين"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الهيموغلوبين",
                        correctAnswers: ["هيموغلوبين"]
                    },
                    {
                        questionText: "ما اسم الظاهرة التي تجعل السماء زرقاء؟",
                        options: ["الانكسار", "الحيود", "تبعثر رايلي"],
                        correctAnswerIndex: 2,
                        displayAnswer: "تبعثر رايلي",
                        correctAnswers: ["تبعثر رايلي", "Rayleigh scattering"]
                    },
                    {
                        questionText: "ما هو المصطلح الذي يطلق على دراسة الحشرات؟",
                        options: ["علم الطفيليات", "علم الحشرات", "علم الأحياء الدقيقة"],
                        correctAnswerIndex: 1,
                        displayAnswer: "علم الحشرات",
                        correctAnswers: ["علم الحشرات"]
                    },
                    {
                        questionText: "ما هو الكوكب الوحيد الذي يدور حول نفسه من الشرق إلى الغرب؟",
                        options: ["الزهرة", "أورانوس", "نبتون"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الزهرة",
                        correctAnswers: ["الزهرة"]
                    },
                    {
                        questionText: "ما هو عدد الأضلاع في الشكل الهندسي الديكاجون؟",
                        options: ["10", "12", "8"],
                        correctAnswerIndex: 0,
                        displayAnswer: "10",
                        correctAnswers: ["10"]
                    },
                    {
                        questionText: "أي عضو في جسم الإنسان يُنتج الأنسولين؟",
                        options: ["الكبد", "البنكرياس", "الكلى"],
                        correctAnswerIndex: 1,
                        displayAnswer: "البنكرياس",
                        correctAnswers: ["البنكرياس"]
                    },
                    {
                        questionText: "ما هو أكبر غدد جسم الإنسان؟",
                        options: ["الكبد", "البنكرياس", "الغدة الدرقية"],
                        correctAnswerIndex: 0,
                        displayAnswer: "الكبد",
                        correctAnswers: ["الكبد"]
                    },
                    {
                        questionText: "ما اسم العملية التي يتحول فيها السائل إلى غاز؟",
                        options: ["التكاثف", "الغليان", "التبخر"],
                        correctAnswerIndex: 2,
                        displayAnswer: "التبخر",
                        correctAnswers: ["التبخر"]
                    },
                    {
                        questionText: "ما هو الاسم العلمي للفيتامين D؟",
                        options: ["كوليكالسيفيرول", "توكوفيرول", "نياسين"],
                        correctAnswerIndex: 0,
                        displayAnswer: "كوليكالسيفيرول",
                        correctAnswers: ["كوليكالسيفيرول", "فيتامين D"]
                    }
                ]
            }
        ];
        
        function normalize(text) {
            return text
                .toLowerCase()
                .replace(/\s+/g, '')
                .replace(/أ|إ|آ/g, 'ا')
                .replace(/ى/g, 'ي')
                .replace(/ة/g, 'ه')
                .replace(/ؤ/g, 'و')
                .replace(/ئ/g, 'ي')
                .replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '');
        }

        function similarity(a, b) {
            a = normalize(a);
            b = normalize(b);
            let matches = 0;
            const len = Math.max(a.length, b.length);
            if (len === 0) return 1; 

            for (let i = 0; i < len; i++) {
                if (a[i] === b[i]) matches++;
            }
            return matches / len;
        }

        function isCorrectAnswer(playerAnswer, acceptedAnswers) {
            const normalizedPlayerAnswer = normalize(playerAnswer);
            // For multiple choice, acceptedAnswers will typically be very precise.
            // For open-ended, similarity is used.
            // We rely on the `correctAnswers` array in the quiz object to contain normalized forms suitable for comparison.
            return acceptedAnswers.some(ans => normalizedPlayerAnswer === ans || similarity(normalizedPlayerAnswer, ans) >= 0.8);
        }

        let selectedQuizIndices = [];
        const quizCategoryInput = document.getElementById('quiz-category-input');
        const quizCategoryDropdown = document.getElementById('quiz-category-dropdown');
        const selectedCategoriesTags = document.getElementById('selected-categories-tags');
        const hostNicknameInput = document.getElementById('host-nickname-input');
        const totalQuestionsPerGameSelect = document.getElementById('total-questions-per-game-select');

        function setupQuizCategorySelection() {
            if (!quizCategoryDropdown) {
                console.error("Error: quizCategoryDropdown element not found.");
                return;
            }
            quizCategoryDropdown.innerHTML = '';
            quizzes.forEach((quiz, index) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = index;
                checkbox.className = 'ml-2';
                checkbox.checked = selectedQuizIndices.includes(index);
                label.appendChild(checkbox);
                const displayText = quiz.category;  
                label.appendChild(document.createTextNode(displayText));
                quizCategoryDropdown.appendChild(label);

                checkbox.addEventListener('change', (event) => {
                    const categoryIndex = parseInt(event.target.value);
                    if (event.target.checked) {
                        if (!selectedQuizIndices.includes(categoryIndex)) {
                            selectedQuizIndices.push(categoryIndex);
                        }
                    } else {
                        selectedQuizIndices = selectedQuizIndices.filter(i => i !== categoryIndex);
                    }
                    updateSelectedCategoriesTags();
                });
            });
            updateSelectedCategoriesTags();
        }

        function updateSelectedCategoriesTags() {
            if (!selectedCategoriesTags) {
                console.error("Error: selectedCategoriesTags element not found.");
                return;
            }
            selectedCategoriesTags.innerHTML = '';
            selectedQuizIndices.forEach(index => {
                const quiz = quizzes[index];
                if (quiz) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = quiz.category;
                    
                    const removeBtn = document.createElement('span');
                    removeBtn.className = 'tag-remove';
                    removeBtn.textContent = 'x';
                    removeBtn.onclick = () => {
                        selectedQuizIndices = selectedQuizIndices.filter(i => i !== index);
                        setupQuizCategorySelection();
                    };
                    tag.appendChild(removeBtn);
                    selectedCategoriesTags.appendChild(tag);
                }
            });
            if (quizCategoryInput) {
                if (selectedQuizIndices.length === 0) {
                    quizCategoryInput.placeholder = "انقر هنا لاختيار الفئات...";
                } else {
                    quizCategoryInput.placeholder = `تم اختيار ${selectedQuizIndices.length} فئة`;
                }
            }
        }
        
        if (quizCategoryInput) {
            quizCategoryInput.addEventListener('click', () => {
                if (quizCategoryDropdown) {
                    quizCategoryDropdown.classList.toggle('hidden');
                }
            });
        }

        document.addEventListener('click', (event) => {
            const clickedInsideInput = quizCategoryInput && quizCategoryInput.contains(event.target);
            const clickedInsideDropdown = quizCategoryDropdown && quizCategoryDropdown.contains(event.target);
            const clickedInsideTags = selectedCategoriesTags && selectedCategoriesTags.contains(event.target);

            if (quizCategoryDropdown && !clickedInsideInput && !clickedInsideDropdown && !clickedInsideTags) {
                quizCategoryDropdown.classList.add('hidden');
            }
        });

        const loadingOverlay = document.getElementById('loading-overlay');
        const roleSelectionScreen = document.getElementById('role-selection-screen');
        const hostSetupScreen = document.getElementById('host-setup-screen');
        const waitingRoomScreen = document.getElementById('waiting-room-screen');
        const joinGameScreen = document.getElementById('join-game-screen');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const questionResultsScreen = document.getElementById('question-results-screen');  
        const gameEndScreen = document.getElementById('game-end-screen');
        const createHostButton = document.getElementById('create-host-button');
        const joinPlayerButton = document.getElementById('join-player-button');
        const timeLimitSelect = document.getElementById('time-limit-select');
        const createGameButton = document.getElementById('create-game-button');
        const gameLinkDisplay = document.getElementById('game-link-display');  
        const qrcodeDiv = document.getElementById('qrcode');  
        const qrcodeFallbackMessage = document.getElementById('qrcode-fallback-message');  
        const copyLinkButton = document.getElementById('copy-link-button');
        const joinedPlayersList = document.getElementById('joined-players-list');
        const startGameButton = document.getElementById('start-game-button');  
        const gameCodeInput = document.getElementById('game-code-input');
        const playerNicknameInput = document.getElementById('player-nickname-input');
        const joinRoomButton = document.getElementById('join-room-button');
        const gameTimerDisplay = document.getElementById('game-timer');
        const playerScoreDisplay = document.getElementById('player-score');
        const gameCategoryDisplay = document.getElementById('game-category');
        const gameQuestionDisplay = document.getElementById('game-question');  
        const pointsButtonGroup = document.getElementById('points-button-group');  
        const gameGuessInput = document.getElementById('game-guess-input');
        const submitAnswerButton = document.getElementById('submit-answer-button');  
        const playerCorrectGuessesList = document.getElementById('player-correct-guesses-list');
        const sharedRoundGuessesList = document.getElementById('shared-round-guesses-list');  
        const endQuestionEarlyButton = document.getElementById('end-question-early-button');  
        const resultsCategory = document.getElementById('results-category');
        const resultsQuestion = document.getElementById('results-question');  
        const roundCorrectAnswersList = document.getElementById('round-correct-answers-list');  
        const questionPlayerScoresList = document.getElementById('question-player-scores-list');  
        const questionResultsHostControls = document.getElementById('question-results-host-controls');  
        const nextQuestionButton = document.getElementById('next-question-button');  
        const endGameFinalButton = document.getElementById('end-game-final-button');
        const gameCountdownScreen = document.getElementById('game-countdown-screen');  
        const countdownTimerDisplay = document.getElementById('countdown-timer-display');  
        const questionCounterDisplay = document.getElementById('question-counter');  
        const hostSubmissionStatusList = document.getElementById('host-submission-status-list');  
        const hostGameplayControls = document.getElementById('host-gameplay-controls');  
        const endTitle = document.getElementById('end-title');
        const endMessage = document.getElementById('end-message');
        const finalScoresList = document.getElementById('final-scores-list');
        const playAgainButton = document.getElementById('play-again-button');
        const startNewRoundSameRoomButton = document.getElementById('start-new-round-same-room-button');
        const playerExitButtonGameplay = document.getElementById('player-exit-button-gameplay');
        const playerExitButtonResults = document.getElementById('player-exit-button-results');
        const customMessageButtonsContainer = document.getElementById('custom-message-buttons');  
        const customMessageBox = document.getElementById('custom-message-box');
        const customMessageTitle = document.getElementById('custom-message-title');
        const customMessageContent = document.getElementById('custom-message-content');
        const powerUpDoublePointsBtn = document.getElementById('power-up-double-points');
        const powerUpExtraTimeBtn = document.getElementById('power-up-extra-time');
        const powerUpHintBtn = document.getElementById('power-up-hint');

        const timerSynth = new Tone.Synth({ type: "sine" , envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 }}).toDestination();
        const correctAnswerSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
        
        function playTimerSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            timerSynth.triggerAttackRelease("C4", "16n");
        }
        function playCorrectAnswerSound() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            correctAnswerSynth.triggerAttackRelease("C5", "8n", Tone.now());
            correctAnswerSynth.triggerAttackRelease("G5", "8n", Tone.now() + 0.1);
        }

        function setupLobbyMusic() {
            const synth = new Tone.Synth({ oscillator: { type: "pwm", modulationFrequency: 0.2 }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.2, release: 0.9 } }).toDestination();
            const pattern = new Tone.Sequence((time, note) => {
                synth.triggerAttackRelease(note, 0.1, time);
            }, ["C4", "E4", "G4", "B4"], "4n");
            pattern.loop = true;
            pattern.humanize = true;
            Tone.Transport.bpm.value = 100;
            return pattern;
        }

        document.addEventListener('DOMContentLoaded', () => {
            populatePointsButtons();
            initializeFirebase();
        });

        function populatePointsButtons() {
            if (!pointsButtonGroup) return;
            pointsButtonGroup.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'points-button';
                button.textContent = i;
                button.setAttribute('data-points', i);

                const isDisabled = userUsedPointsBets.includes(i);
                if (isDisabled) {
                    button.disabled = true;
                    button.classList.add('used');
                }

                if (i === selectedPointsBet) {
                    button.classList.add('selected');
                }

                button.addEventListener('click', (event) => {
                    if (event.target.disabled) return;  

                    const currentSelected = pointsButtonGroup.querySelector('.points-button.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                    }
                    event.target.classList.add('selected');
                    selectedPointsBet = parseInt(event.target.getAttribute('data-points'));
                    console.log("Selected points bet:", selectedPointsBet);
                });
                pointsButtonGroup.appendChild(button);
            }
        }

        async function initializeFirebase() {
            showLoading();
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCwdZjTwrnjKZU_AilP5_GZJeEuUZjVcUY",
                    authDomain: "ka3boura-dbcf5.firebaseapp.com",
                    projectId: "ka3boura-dbcf5",
                    storageBucket: "ka3boura-dbcf5.firebasestorage.app",
                    messagingSenderId: "1051115240747",
                    appId: "1:1051115240747:web:694751eef3173327f5596e",
                    measurementId: "G-9413DFK5DF"
                };
                
                appId = firebaseConfig.projectId;
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(app);
                auth = firebase.auth(app);

                await auth.signInAnonymously();

                auth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid;
                        hideLoading();

                        const urlParams = new URLSearchParams(window.location.search);
                        const idFromUrl = urlParams.get('gameId');
                        if (idFromUrl) {
                            gameId = idFromUrl;
                            if (gameCodeInput) gameCodeInput.value = gameId;

                            playerNicknameInput.value = localStorage.getItem('playerNickname') || '';

                            if (!playerNicknameInput.value) {
                                showScreen(joinGameScreen);
                                showCustomMessageBox("الانضمام إلى لعبة", `أدخل اسمك المستعار للانضمام إلى اللعبة برمز ${gameId}.`);
                            } else {
                                showCustomMessageBox("الانضمام إلى لعبة", `هل تريد الانضمام إلى اللعبة برمز ${gameId} باسم ${playerNicknameInput.value}؟`, {
                                    buttons: [
                                        { text: 'حسناً', callback: () => joinGame(gameId, playerNicknameInput.value) },
                                        { text: 'لا', callback: exitGame, className: 'bg-red-600 hover:bg-red-700 text-white text-xl font-semibold py-3 px-8 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out' }
                                    ]
                                });
                            }
                        } else {
                            showScreen(roleSelectionScreen);
                        }
                    } else {
                        hideLoading();
                        showScreen(roleSelectionScreen);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error Details:", error);
                showCustomMessageBox("خطأ", `فشل تهيئة اللعبة. التفاصيل: ${error.message}`);
                hideLoading();
            }
        }

        function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('hidden'); }

        // NEW: Function to show custom message box for Joker hint specifically
        function showJokerHintMessage(displayAnswer) {
            if (!customMessageBox || !customMessageTitle || !customMessageContent || !customMessageButtonsContainer) {
                // Fallback in case critical elements are missing
                alert(`خطأ: الإجابة هي: ${displayAnswer}`);
                return;
            }
            customMessageTitle.textContent = "استعمال جوكر!";
            customMessageContent.innerHTML = `الإجابة هي: <strong class="text-2xl">${displayAnswer}</strong>`;
            
            customMessageButtonsContainer.innerHTML = '';
            const closeButton = document.createElement('button');
            closeButton.textContent = 'حسناً';
            closeButton.className = 'bg-blue-600 hover:bg-blue-700 text-white text-xl font-semibold py-3 px-8 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out';
            closeButton.onclick = hideCustomMessageBox; // Explicitly hide on click
            customMessageButtonsContainer.appendChild(closeButton);

            customMessageBox.classList.remove('hidden', 'opacity-0');
            customMessageBox.classList.add('flex', 'opacity-100');
        }

        // Modified showCustomMessageBox to always hide after button click
        function showCustomMessageBox(title, content, options = {}) {
            if (!customMessageBox || !customMessageTitle || !customMessageContent || !customMessageButtonsContainer) {
                alert(`خطأ: ${title}\n${content}`);
                return;
            }
            customMessageTitle.textContent = title;
            customMessageContent.innerHTML = content;
            
            customMessageButtonsContainer.innerHTML = '';

            const defaultButton = { 
                text: 'حسناً', 
                callback: null, // Callback can be null, as hide will happen implicitly
                className: 'bg-blue-600 hover:bg-blue-700 text-white text-xl font-semibold py-3 px-8 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out' 
            };
            const buttonsToRender = options.buttons || [defaultButton];

            buttonsToRender.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className || defaultButton.className; 
                button.onclick = () => {
                    if (btnConfig.callback) {
                        btnConfig.callback(); // Execute the specific action
                    }
                    hideCustomMessageBox(); // Always hide the box after any button click in a standard message box
                };
                customMessageButtonsContainer.appendChild(button);
            });

            customMessageBox.classList.remove('hidden', 'opacity-0');
            customMessageBox.classList.add('flex', 'opacity-100');
        }

        function hideCustomMessageBox() {
            if (customMessageBox) {
                customMessageBox.classList.remove('flex', 'opacity-100');
                customMessageBox.classList.add('hidden', 'opacity-0');
            }
        }

        function showScreen(screenElement) {
            if (!screenElement || !(screenElement instanceof HTMLElement)) {
                showCustomMessageBox("خطأ في العرض", "عنصر الشاشة غير صالح.");
                return;
            }

            const allScreens = [
                roleSelectionScreen, hostSetupScreen, waitingRoomScreen,
                joinGameScreen, gamePlayScreen, questionResultsScreen, gameEndScreen, gameCountdownScreen
            ];
            allScreens.forEach(screen => {
                if (screen && screen instanceof HTMLElement) {
                    screen.classList.add('hidden');
                }
            });
            
            // Removed the problematic implicit hideCustomMessageBox() call from here.
            // The custom message box's visibility is now solely controlled by explicit calls.

            screenElement.classList.remove('hidden');
        }

        function exitGame() {
            showLoading();
            if (lobbyMusicLoop && lobbyMusicLoop.state === "started") {
                Tone.Transport.stop();
                lobbyMusicLoop.stop(0);
            }
            gameId = null;
            isHost = false;
            clearInterval(timerInterval);
            clearInterval(currentQuestionSoundInterval);
            if (hostTimeUpdater) {
                clearInterval(hostTimeUpdater);
                hostTimeUpdater = null;
            }
            soundStarted = false;
            if (gameSnapshotUnsubscribe) {
                gameSnapshotUnsubscribe();
                gameSnapshotUnsubscribe = null;
            }
            if (playersSnapshotUnsubscribe) {
                playersSnapshotUnsubscribe();
                playersSnapshotUnsubscribe = null;
            }
            selectedQuizIndices = [];
            userUsedPointsBets = [];
            populatePointsButtons();
            window.history.pushState({}, '', window.location.pathname);
            // Reset lastDisplayedQuestionIndex on exit
            lastDisplayedQuestionIndex = -1; 
            selectedMultipleChoiceOption = null; // Reset selected multiple choice option
            hideLoading();
            showScreen(roleSelectionScreen);
        }

        async function generateUniqueGameCode() {
            let newGameId;
            let isUnique = false;
            let attempts = 0;
            const MAX_ATTEMPTS = 10;

            while (!isUnique && attempts < MAX_ATTEMPTS) {
                newGameId = String(Math.floor(100 + Math.random() * 900));
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(newGameId);
                const docSnap = await gameRef.get();
                if (!docSnap.exists) {
                    isUnique = true;
                } else {
                    attempts++;
                }
            }
            if (!isUnique) {
                throw new Error("فشل توليد رمز غرفة فريد.");
            }
            return newGameId;
        }

        async function createGame() {
            showLoading();
            try {
                const hostNickname = hostNicknameInput.value.trim();
                if (!hostNickname) {
                    showCustomMessageBox("خطأ", "الرجاء إدخال اسمك المستعار.");
                    hideLoading();
                    return;
                }
                if (selectedQuizIndices.length === 0) {
                    showCustomMessageBox("خطأ", "الرجاء اختيار فئة واحدة على الأقل للأسئلة.");
                    hideLoading();
                    return;
                }

                gameId = await generateUniqueGameCode();
                isHost = true;
                userNickname = hostNickname;
                localStorage.setItem('hostNickname', hostNickname);
                const timeLimit = parseInt(timeLimitSelect.value);
                const totalQuestions = parseInt(totalQuestionsPerGameSelect.value);

                let allPossibleQuestions = [];
                selectedQuizIndices.forEach(catIndex => {
                    const category = quizzes[catIndex];
                    if (category && category.questions) {
                        category.questions.forEach(q => {
                            allPossibleQuestions.push({
                                category: category.category,
                                question: q.questionText,
                                displayAnswer: q.displayAnswer,
                                correctAnswers: q.correctAnswers.map(normalize),
                                // Include options and correctAnswerIndex if present
                                options: q.options || null,
                                correctAnswerIndex: q.correctAnswerIndex !== undefined ? q.correctAnswerIndex : null
                            });
                        });
                    }
                });

                for (let i = allPossibleQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allPossibleQuestions[i], allPossibleQuestions[j]] = [allPossibleQuestions[j], allPossibleQuestions[i]];
                }
                
                const quizSetForGame = allPossibleQuestions.slice(0, totalQuestions);

                if (quizSetForGame.length === 0) {
                    showCustomMessageBox("خطأ", "الفئات المختارة لا تحتوي على أي أسئلة.");
                    hideLoading();
                    return;
                }

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                
                await gameRef.set({
                    hostId: userId,
                    gamePhase: 'lobby',
                    quizSet: quizSetForGame,
                    selectedCategoryIndices: selectedQuizIndices,
                    currentQuestionIndexInGame: 0,
                    currentCategory: '',
                    currentQuestionText: '',
                    currentCorrectAnswers: [],
                    currentDisplayAnswer: '',
                    currentQuestionGuessedAnswers: [],
                    questionStartTime: null, 
                    timeLimitPerQuestion: timeLimit,
                    countdownStartTime: null,
                    countdownDuration: 5,
                    scoresReconciledForCurrentQuestion: false,
                    currentRemainingTime: 0,
                    // NEW: Store multiple choice options and correct index for the current question
                    currentQuestionOptions: null,
                    currentCorrectAnswerIndex: null
                });
                
                const playerRef = gameRef.collection('players').doc(userId);
                await playerRef.set({
                    nickname: hostNickname,
                    score: 0,
                    joinedAt: Date.now(),
                    playerSubmittedAnswer: '',
                    playerSelectedPoints: 0,
                    playerScoreChange: 0,
                    hasSubmittedAnswer: false,
                    usedPointsBets: [],
                    powerUpsUsed: { doublePoints: false, extraTime: false, hint: false }
                });
                userUsedPointsBets = [];

                const gameRoomLink = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                if (gameLinkDisplay) {
                    gameLinkDisplay.textContent = gameRoomLink;
                    gameLinkDisplay.href = gameRoomLink;
                }
                
                if (qrcodeDiv) qrcodeDiv.innerHTML = '';
                if (qrcodeFallbackMessage) qrcodeFallbackMessage.textContent = '';
                try {
                    if (typeof QRCode !== 'undefined' && QRCode && qrcodeDiv) {  
                        new QRCode(qrcodeDiv, { text: gameRoomLink, width: 128, height: 128, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
                    } else {
                        throw new Error("QRCode library not available.");
                    }
                } catch (qrError) {
                    if (qrcodeFallbackMessage) { qrcodeFallbackMessage.textContent = "فشل توليد رمز QR."; }
                }

                if (copyLinkButton) {
                    copyLinkButton.onclick = () => {
                        const textArea = document.createElement("textarea");
                        textArea.value = gameRoomLink;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try { document.execCommand('copy'); showCustomMessageBox("تم النسخ!", "تم نسخ رابط الغرفة."); }
                        catch (err) { showCustomMessageBox("خطأ", "فشل نسخ الرابط."); }
                        document.body.removeChild(textArea);
                    };
                }

                showScreen(waitingRoomScreen);
                listenToGameChanges();
                listenToPlayers();
                if (startGameButton) startGameButton.classList.remove('hidden');
            } catch (error) {
                console.error("Error creating game:", error);
                showCustomMessageBox("خطأ في إنشاء اللعبة", error.message);
            } finally {
                hideLoading();
            }
        }
        
        async function initiateGameStartCountdown() {  
            showLoading();
            try {
                if (!gameId || !isHost) return;

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists || gameDoc.data().gamePhase !== 'lobby') {
                    hideLoading();
                    return;
                }

                await gameRef.update({
                    gamePhase: 'game_countdown',
                    countdownStartTime: Date.now(),
                    countdownDuration: 5
                });
            } catch (error) {
                showCustomMessageBox("خطأ", "فشل بدء العد التنازلي.");
            } finally {
                hideLoading();
            }
        }

        async function startNextQuestion() {
            showLoading();
            try {
                if (!gameId || !isHost) return;

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) throw new Error("اللعبة غير موجودة.");

                const gameData = gameDoc.data();
                const currentQuestionIndex = gameData.currentQuestionIndexInGame;
                const quizSet = gameData.quizSet;

                if (currentQuestionIndex >= quizSet.length) {
                    await gameRef.update({ gamePhase: 'final_results' });
                    return;
                }

                const currentQuestion = quizSet[currentQuestionIndex];

                await gameRef.update({
                    gamePhase: 'question_active',
                    currentQuestionIndexInGame: currentQuestionIndex + 1,
                    currentCategory: currentQuestion.category,
                    currentQuestionText: currentQuestion.question,
                    currentCorrectAnswers: currentQuestion.correctAnswers,
                    currentDisplayAnswer: currentQuestion.displayAnswer,
                    currentQuestionGuessedAnswers: [],
                    questionStartTime: Date.now(), 
                    timeLimitPerQuestion: gameData.timeLimitPerQuestion,
                    scoresReconciledForCurrentQuestion: false,
                    currentRemainingTime: gameData.timeLimitPerQuestion,
                    // Pass multiple choice options and correct index to Firestore
                    currentQuestionOptions: currentQuestion.options || null,
                    currentCorrectAnswerIndex: currentQuestion.correctAnswerIndex !== undefined ? currentQuestion.correctAnswerIndex : null
                });

                const playersCollectionRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersDocs = await playersCollectionRef.get();
                const batch = db.batch();
                playersDocs.docs.forEach(playerDoc => {
                    batch.update(playerDoc.ref, {  
                        playerSubmittedAnswer: '',
                        playerSelectedPoints: 0,
                        playerScoreChange: 0,
                        hasSubmittedAnswer: false
                    });
                });
                await batch.commit();

                clearInterval(currentQuestionSoundInterval);
                soundStarted = false;

                // Host starts updating remaining time in Firestore
                if (hostTimeUpdater) clearInterval(hostTimeUpdater);
                hostTimeUpdater = setInterval(async () => {
                    const gameDocSnapshot = await gameRef.get();
                    if (gameDocSnapshot.exists && gameDocSnapshot.data().gamePhase === 'question_active') {
                        const remaining = Math.max(0, gameDocSnapshot.data().currentRemainingTime - 1);
                        await gameRef.update({ currentRemainingTime: remaining });
                        if (remaining <= 0) {
                            clearInterval(hostTimeUpdater);
                            hostTimeUpdater = null;
                            await gameRef.update({ gamePhase: 'question_results', scoresReconciledForCurrentQuestion: false });
                        }
                    } else {
                        clearInterval(hostTimeUpdater);
                        hostTimeUpdater = null;
                    }
                }, 1000); 
                
            } catch (error) {
                showCustomMessageBox("خطأ", error.message);
            } finally {
                hideLoading();
            }
        }

        async function endQuestionEarly() {  
            if (!isHost || !gameId) return;  

            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                // Stop host time updater immediately
                if (hostTimeUpdater) {
                    clearInterval(hostTimeUpdater);
                    hostTimeUpdater = null;
                }
                
                // Force remaining time to 0 and change phase
                await gameRef.update({
                    gamePhase: 'question_results',
                    scoresReconciledForCurrentQuestion: false,
                    currentRemainingTime: 0 
                });
            } catch (error) {
                showCustomMessageBox("خطأ", "فشل إنهاء السؤال مبكراً.");
            } finally {
                hideLoading();
            }
        }

        async function endGame() {
            if (!isHost || !gameId) return;
            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                // Stop host time updater
                if (hostTimeUpdater) {
                    clearInterval(hostTimeUpdater);
                    hostTimeUpdater = null;
                }
                await gameRef.update({ gamePhase: 'final_results' });
            } catch (error) {
                showCustomMessageBox("خطأ", "فشل إنهاء اللعبة.");
            } finally {
                hideLoading();
            }
        }

        async function startNewRoundInSameRoom() {
            if (!isHost || !gameId) return;
            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) {
                    showCustomMessageBox("خطأ", "اللعبة غير موجودة.");
                    return;
                }
                const gameData = gameDoc.data();
                const selectedCategories = gameData.selectedCategoryIndices || [];
                const totalQuestions = gameData.quizSet ? gameData.quizSet.length : 10; 

                if (selectedCategories.length === 0) {
                    showCustomMessageBox("خطأ", "لا توجد فئات أسئلة مختارة.");
                    hideLoading();
                    return;
                }

                let allPossibleQuestions = [];
                selectedCategories.forEach(catIndex => {
                    const category = quizzes[catIndex];
                    if (category && category.questions) {
                        category.questions.forEach(q => {
                            allPossibleQuestions.push({
                                category: category.category,
                                question: q.questionText,
                                displayAnswer: q.displayAnswer,
                                correctAnswers: q.correctAnswers.map(normalize),
                                // Include options and correctAnswerIndex if present
                                options: q.options || null,
                                correctAnswerIndex: q.correctAnswerIndex !== undefined ? q.correctAnswerIndex : null
                            });
                        });
                    }
                });
                for (let i = allPossibleQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allPossibleQuestions[i], allPossibleQuestions[j]] = [allPossibleQuestions[j], allPossibleQuestions[i]];
                }
                const newQuizSetForGame = allPossibleQuestions.slice(0, totalQuestions);

                if (newQuizSetForGame.length === 0) {
                    showCustomMessageBox("خطأ", "الفئات المختارة لا تحتوي على أسئلة.");
                    hideLoading();
                    return;
                }

                const batch = db.batch();
                batch.update(gameRef, {
                    gamePhase: 'lobby', 
                    quizSet: newQuizSetForGame,
                    currentQuestionIndexInGame: 0,
                    currentCategory: '',
                    currentQuestionText: '',
                    currentCorrectAnswers: [],
                    currentDisplayAnswer: '',
                    currentQuestionGuessedAnswers: [],
                    questionStartTime: null, 
                    countdownStartTime: null,
                    scoresReconciledForCurrentQuestion: false,
                    currentRemainingTime: 0,
                    // Reset multiple choice data for new round
                    currentQuestionOptions: null,
                    currentCorrectAnswerIndex: null
                });

                const playersCollectionRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersDocs = await playersCollectionRef.get();
                playersDocs.forEach(playerDoc => {
                    batch.update(playerDoc.ref, {
                        score: 0, 
                        playerSubmittedAnswer: '',
                        playerSelectedPoints: 0,
                        playerScoreChange: 0,
                        hasSubmittedAnswer: false,
                        usedPointsBets: [],
                        powerUpsUsed: { doublePoints: false, extraTime: false, hint: false }
                    });
                });
                await batch.commit();
                // Reset lastDisplayedQuestionIndex on new round
                lastDisplayedQuestionIndex = -1;
                selectedMultipleChoiceOption = null; // Reset selected multiple choice option

            } catch (error) {
                showCustomMessageBox("خطأ", error.message);
            } finally {
                hideLoading();
            }
        }

        async function reconcileQuestionScores() {
            if (!isHost || !gameId) return;
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            const gameDoc = await gameRef.get();
            if (!gameDoc.exists || gameDoc.data().scoresReconciledForCurrentQuestion) {
                return;
            }

            showLoading();
            try {
                const playersCollectionRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersDocs = await playersCollectionRef.get();
                
                const batch = db.batch();
                let roundCorrectGuesses = [];
                const gameData = gameDoc.data();
                const currentCorrectAnswers = gameData.currentCorrectAnswers || [];
                const currentQuestionOptions = gameData.currentQuestionOptions;
                const currentCorrectAnswerIndex = gameData.currentCorrectAnswerIndex;

                for (const playerDoc of playersDocs.docs) {
                    const playerRef = playerDoc.ref;
                    const playerData = playerDoc.data();
                    let scoreChange = 0;
                    let submittedAnswer = playerData.playerSubmittedAnswer;

                    if (playerData.hasSubmittedAnswer) {
                        let isAnswerCorrect = false;
                        if (currentQuestionOptions && currentCorrectAnswerIndex !== null) {
                            // Multiple choice question
                            const correctOptionText = currentQuestionOptions[currentCorrectAnswerIndex];
                            isAnswerCorrect = (submittedAnswer === correctOptionText);
                        } else {
                            // Open-ended question
                            isAnswerCorrect = isCorrectAnswer(submittedAnswer, currentCorrectAnswers);
                        }

                        if (isAnswerCorrect) {
                            scoreChange = playerData.playerSelectedPoints;
                            if (!roundCorrectGuesses.some(g => normalize(g) === normalize(submittedAnswer))) {  
                                roundCorrectGuesses.push(submittedAnswer);
                            }
                        } else {
                            scoreChange = -playerData.playerSelectedPoints;
                        }
                    } else {
                        scoreChange = 0;
                    }
                    
                    const newScore = (playerData.score || 0) + scoreChange;
                    batch.update(playerRef, {
                        score: newScore,
                        playerScoreChange: scoreChange
                    });
                }

                batch.update(gameRef, {  
                    currentQuestionGuessedAnswers: roundCorrectGuesses,
                    scoresReconciledForCurrentQuestion: true
                });
                await batch.commit();
            } catch (error) {
                showCustomMessageBox("خطأ في تحديث النقاط", error.message);
            } finally {
                hideLoading();
            }
        }

        async function joinGame(code, nickname) {
             showLoading();
            try {
                if (!code || !nickname) {
                    throw new Error("يرجى إدخال رمز اللعبة واسمك المستعار.");
                }

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(code);
                const gameDoc = await gameRef.get();

                if (!gameDoc.exists) {
                    showCustomMessageBox("اللعبة غير موجودة", "رمز اللعبة غير صحيح.");
                    hideLoading();
                    exitGame();
                    return;
                }

                const gameData = gameDoc.data();
                if (gameData.gamePhase === 'final_results') {
                    showCustomMessageBox("اللعبة انتهت", "هذه اللعبة قد انتهت بالفعل.");
                    hideLoading();
                    exitGame();
                    return;
                }

                gameId = code;
                isHost = (gameData.hostId === userId);
                userNickname = nickname;
                localStorage.setItem('playerNickname', nickname);

                const playerRef = gameRef.collection('players').doc(userId);
                await playerRef.set({
                    nickname: nickname,
                    score: 0,
                    joinedAt: Date.now(),
                    playerSubmittedAnswer: '',
                    playerSelectedPoints: 0,
                    playerScoreChange: 0,
                    hasSubmittedAnswer: false,
                    usedPointsBets: [],
                    powerUpsUsed: { doublePoints: false, extraTime: false, hint: false }
                }, { merge: true });
                userUsedPointsBets = [];

                if (!window.location.search.includes(`gameId=${gameId}`)) {
                    const newUrl = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                }

                showScreen(waitingRoomScreen);
                if (document.getElementById('waiting-room-title')) document.getElementById('waiting-room-title').textContent = `في انتظار بدء اللعبة...`;
                
                if (gameLinkDisplay) gameLinkDisplay.textContent = `رمز الغرفة: ${gameId}`;
                
                if (qrcodeDiv) qrcodeDiv.innerHTML = '';
                if (qrcodeFallbackMessage) qrcodeFallbackMessage.textContent = '';
                if (copyLinkButton) copyLinkButton.classList.add('hidden');
                
                listenToGameChanges();
                listenToPlayers();
            } catch (error) {
                showCustomMessageBox("خطأ في الانضمام", error.message);
            } finally {
                hideLoading();
            }
        }

        // Modified submitGuess to handle both text input and multiple choice
        async function submitGuess(selectedOptionText = null) {
            if (!gameId || (gamePlayScreen && gamePlayScreen.classList.contains('hidden'))) { return; }
            if (!pointsButtonGroup || !submitAnswerButton) { return; }

            let guess;
            if (selectedOptionText !== null) {
                guess = selectedOptionText;
                selectedMultipleChoiceOption = selectedOptionText; // Store for visual feedback
                // Visually mark the selected option and disable others
                Array.from(multipleChoiceOptionsContainer.children).forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === selectedOptionText) {
                        btn.classList.add('selected-option');
                    } else {
                        btn.classList.remove('selected-option'); // Ensure only one is marked
                    }
                });
            } else {
                if (!gameGuessInput || gameGuessInput.disabled) { showCustomMessageBox("تم الإجابة", "لقد أجبت بالفعل."); return; }
                guess = gameGuessInput.value.trim();
                if (guess === '') { showCustomMessageBox("خطأ", "الرجاء كتابة إجابتك."); return; }
            }

            const pointsBet = selectedPointsBet;
            if (isNaN(pointsBet) || pointsBet < 1 || pointsBet > 20) { showCustomMessageBox("خطأ", "الرجاء اختيار عدد نقاط صحيح."); return; }

            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const playerRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId);
                
                let pointsToSubmit = pointsBet;
                if (isDoublePointsActive) {
                    pointsToSubmit *= 2;
                }

                await db.runTransaction(async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    if (!playerDoc.exists) { throw "Player data not found."; }
                    const playerData = playerDoc.data();
                    if (playerData.hasSubmittedAnswer) {
                        throw new Error("لقد أجبت بالفعل.");
                    }
                    if (playerData.usedPointsBets.includes(pointsBet)) {
                            throw new Error(`لقد استخدمت قيمة ${pointsBet} نقطة بالفعل.`);
                    }

                    transaction.update(playerRef, {
                        playerSubmittedAnswer: guess,
                        playerSelectedPoints: pointsToSubmit,
                        hasSubmittedAnswer: true,
                        usedPointsBets: firebase.firestore.FieldValue.arrayUnion(pointsBet)
                    });
                });

                isDoublePointsActive = false;
                powerUpDoublePointsBtn.classList.remove('ring-4', 'ring-yellow-300', 'opacity-50');

                if (gameGuessInput) gameGuessInput.disabled = true;
                if (submitAnswerButton) submitAnswerButton.disabled = true;
                if (pointsButtonGroup) { Array.from(pointsButtonGroup.children).forEach(btn => btn.disabled = true); }

            } catch (error) {
                showCustomMessageBox("خطأ في الإجابة", error.message);
            } finally {
                hideLoading();
            }
        }

        function listenToGameChanges() {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe();

            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);

            gameSnapshotUnsubscribe = gameRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const gameData = docSnap.data();
                    const gamePhase = gameData.gamePhase;

                    if (gamePhase === 'lobby') {
                        if (lobbyMusicLoop && lobbyMusicLoop.state !== "started") {
                             if (Tone.context.state !== 'running') { Tone.start(); }
                             Tone.Transport.start();
                             lobbyMusicLoop.start(0);
                        }
                    } else {
                        if (lobbyMusicLoop && lobbyMusicLoop.state === "started") {
                             Tone.Transport.stop();
                             lobbyMusicLoop.stop(0);
                        }
                    }
                    if (gamePhase === 'question_results') {
                             db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId).get().then(playerDoc => {
                                 if (playerDoc.exists && playerDoc.data().playerScoreChange > 0) {
                                     playCorrectAnswerSound();
                                 }
                             });
                    }

                    if (questionCounterDisplay) {
                        const currentQNum = gameData.currentQuestionIndexInGame;
                        const totalQs = gameData.quizSet ? gameData.quizSet.length : 0;
                        const displayQNum = (gamePhase === 'game_countdown' || gamePhase === 'lobby') ? 0 : currentQNum;
                        if (totalQs > 0) { questionCounterDisplay.textContent = `${displayQNum} / ${totalQs}`; }  
                        else { questionCounterDisplay.textContent = `-- / --`; }
                    }

                    switch(gamePhase) {
                        case 'lobby':
                            if (gameGuessInput) {
                                gameGuessInput.value = ''; // Ensure input is clear for a new round
                                gameGuessInput.disabled = false;
                            }
                            if (submitAnswerButton) submitAnswerButton.disabled = false;
                            // Hide multiple choice options
                            if (multipleChoiceOptionsContainer) multipleChoiceOptionsContainer.classList.add('hidden');
                            if (gameGuessInput) gameGuessInput.classList.remove('hidden');
                            if (submitAnswerButton) submitAnswerButton.classList.remove('hidden');

                            selectedPointsBet = 1;
                            userUsedPointsBets = [];
                            populatePointsButtons();
                            if (playerCorrectGuessesList) playerCorrectGuessesList.innerHTML = '';
                            if (sharedRoundGuessesList) sharedRoundGuessesList.innerHTML = '';
                            showScreen(waitingRoomScreen);
                            if (isHost) {
                                if (startGameButton) {
                                    startGameButton.textContent = "بدء الجولة!";
                                    startGameButton.onclick = initiateGameStartCountdown;
                                }
                            } else {
                                if (startGameButton) startGameButton.classList.add('hidden');
                            }
                            if (playerExitButtonGameplay) playerExitButtonGameplay.classList.add('hidden');
                            if (playerExitButtonResults) playerExitButtonResults.classList.add('hidden');
                            if (hostTimeUpdater) {
                                clearInterval(hostTimeUpdater);
                                hostTimeUpdater = null;
                            }
                            // Reset lastDisplayedQuestionIndex for new round
                            lastDisplayedQuestionIndex = -1;
                            selectedMultipleChoiceOption = null; // Reset selected multiple choice option
                            break;
                        case 'game_countdown':
                            showScreen(gameCountdownScreen);
                            clearInterval(timerInterval);
                            clearInterval(currentQuestionSoundInterval);
                            soundStarted = false;
                            const countdownDuration = gameData.countdownDuration || 5;
                            let currentCountdown = countdownDuration;
                            if (countdownTimerDisplay) countdownTimerDisplay.textContent = currentCountdown;
                            timerInterval = setInterval(() => {
                                currentCountdown--;
                                if (countdownTimerDisplay) countdownTimerDisplay.textContent = currentCountdown > 0 ? currentCountdown : 'انطلق!';
                                if (currentCountdown <= 0) {
                                    clearInterval(timerInterval);
                                    if (isHost) { startNextQuestion(); }
                                }
                            }, 1000);
                            if (playerExitButtonGameplay) playerExitButtonGameplay.classList.add('hidden');
                            if (playerExitButtonResults) playerExitButtonResults.classList.add('hidden');
                            break;
                        case 'question_active':
                            showScreen(gamePlayScreen);
                            if (gameCategoryDisplay) gameCategoryDisplay.textContent = gameData.currentCategory;
                            if (gameQuestionDisplay) gameQuestionDisplay.textContent = gameData.currentQuestionText;
                            
                            // Handle multiple choice vs. text input display
                            const isCurrentQuestionMultipleChoice = gameData.currentQuestionOptions && gameData.currentQuestionOptions.length > 0;

                            if (gameData.currentQuestionIndexInGame !== lastDisplayedQuestionIndex) {
                                // Reset for a new question
                                if (gameGuessInput) {
                                    gameGuessInput.value = '';
                                    gameGuessInput.disabled = false;
                                }
                                if (submitAnswerButton) submitAnswerButton.disabled = false;
                                selectedPointsBet = 1; // Reset selected bet for new question
                                populatePointsButtons(); // Re-render points buttons
                                isDoublePointsActive = false; // Reset double points state
                                if (powerUpDoublePointsBtn) powerUpDoublePointsBtn.classList.remove('ring-4', 'ring-yellow-300', 'opacity-50');
                                lastDisplayedQuestionIndex = gameData.currentQuestionIndexInGame; // Update the tracking index
                                selectedMultipleChoiceOption = null; // Reset selected multiple choice option
                            }

                            if (isCurrentQuestionMultipleChoice) {
                                if (gameGuessInput) gameGuessInput.classList.add('hidden');
                                if (submitAnswerButton) submitAnswerButton.classList.add('hidden');
                                if (multipleChoiceOptionsContainer) {
                                    multipleChoiceOptionsContainer.innerHTML = ''; // Clear previous options
                                    gameData.currentQuestionOptions.forEach(optionText => {
                                        const optionButton = document.createElement('button');
                                        optionButton.type = 'button';
                                        optionButton.className = 'multiple-choice-option-btn';
                                        optionButton.textContent = optionText;
                                        // Pass the option text to submitGuess
                                        optionButton.onclick = () => submitGuess(optionText); 
                                        multipleChoiceOptionsContainer.appendChild(optionButton);
                                    });
                                    multipleChoiceOptionsContainer.classList.remove('hidden');
                                }
                            } else {
                                if (gameGuessInput) gameGuessInput.classList.remove('hidden');
                                if (submitAnswerButton) submitAnswerButton.classList.remove('hidden');
                                if (multipleChoiceOptionsContainer) multipleChoiceOptionsContainer.classList.add('hidden');
                            }

                            db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId).get().then(playerDoc => {
                                if (playerDoc.exists) {
                                    const currentPlayerData = playerDoc.data();
                                    userUsedPointsBets = currentPlayerData.usedPointsBets || [];
                                    populatePointsButtons(); // Re-populating for player's specific used bets
                                    if (currentPlayerData.hasSubmittedAnswer) {
                                        if (gameGuessInput) gameGuessInput.disabled = true;
                                        if (pointsButtonGroup) Array.from(pointsButtonGroup.children).forEach(btn => btn.disabled = true);
                                        if (submitAnswerButton) submitAnswerButton.disabled = true;
                                        // Disable multiple choice buttons if already submitted
                                        if (isCurrentQuestionMultipleChoice && multipleChoiceOptionsContainer) {
                                            Array.from(multipleChoiceOptionsContainer.children).forEach(btn => {
                                                btn.disabled = true;
                                                if (btn.textContent === currentPlayerData.playerSubmittedAnswer) {
                                                    btn.classList.add('selected-option');
                                                }
                                            });
                                        }
                                    }
                                }
                            });
                            
                            if (gameGuessInput && !isCurrentQuestionMultipleChoice) gameGuessInput.focus();

                            if (isHost) {
                                if (hostGameplayControls) hostGameplayControls.classList.remove('hidden');
                                if (playerExitButtonGameplay) playerExitButtonGameplay.classList.add('hidden');
                            } else {
                                if (hostGameplayControls) hostGameplayControls.classList.add('hidden');
                                if (playerExitButtonGameplay) playerExitButtonGameplay.classList.remove('hidden');
                            }

                            clearInterval(timerInterval);
                            clearInterval(currentQuestionSoundInterval);
                            soundStarted = false;

                            timerInterval = setInterval(() => {
                                const remainingTimeFromFirestore = gameData.currentRemainingTime;
                                localTimerRemaining = Math.max(0, remainingTimeFromFirestore); 
                                if (gameTimerDisplay) gameTimerDisplay.textContent = localTimerRemaining;

                                if (localTimerRemaining <= 5 && !soundStarted) {
                                    currentQuestionSoundInterval = setInterval(playTimerSound, 500);
                                    soundStarted = true;
                                }
                                if (localTimerRemaining <= 0) { 
                                     clearInterval(timerInterval);
                                     clearInterval(currentQuestionSoundInterval);
                                     soundStarted = false;
                                }
                            }, 200); 
                            break;
                        case 'question_results':
                            if (isHost && !gameData.scoresReconciledForCurrentQuestion) {
                                reconcileQuestionScores();  
                            }
                            showScreen(questionResultsScreen);
                            clearInterval(timerInterval);
                            clearInterval(currentQuestionSoundInterval);
                            soundStarted = false;
                            if (hostTimeUpdater) {
                                clearInterval(hostTimeUpdater);
                                hostTimeUpdater = null;
                            }
                            // Reset lastDisplayedQuestionIndex as question has ended
                            lastDisplayedQuestionIndex = -1;
                            selectedMultipleChoiceOption = null; // Reset selected multiple choice option

                            if (resultsCategory) resultsCategory.textContent = gameData.currentCategory;
                            if (resultsQuestion) resultsQuestion.textContent = gameData.currentQuestionText;
                            
                            if (roundCorrectAnswersList) {
                                roundCorrectAnswersList.innerHTML = '';
                                const primaryCorrectAnswer = gameData.currentDisplayAnswer;
                                const listItem = document.createElement('li');
                                if (primaryCorrectAnswer) {
                                    listItem.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i> ${primaryCorrectAnswer}`;
                                } else { listItem.textContent = "لا توجد إجابة صحيحة."; }
                                roundCorrectAnswersList.appendChild(listItem);
                            }

                            if (sharedRoundGuessesList) {
                                sharedRoundGuessesList.innerHTML = '';
                                (gameData.currentQuestionGuessedAnswers || []).forEach(answer => {
                                    const listItem = document.createElement('li');
                                    listItem.textContent = answer;
                                    listItem.classList.add('text-purple-700', 'font-semibold', 'opacity-0', 'animate-fade-in-up');
                                    sharedRoundGuessesList.appendChild(listItem);
                                });
                            }

                            showQuestionPlayerScoresDetailed();

                            if (isHost) {
                                if (questionResultsHostControls) questionResultsHostControls.classList.remove('hidden');
                                if (gameData.currentQuestionIndexInGame < gameData.quizSet.length) {
                                    if (nextQuestionButton) nextQuestionButton.classList.remove('hidden');
                                    if (endGameFinalButton) endGameFinalButton.classList.add('hidden');
                                } else {
                                    if (nextQuestionButton) nextQuestionButton.classList.add('hidden');
                                    if (endGameFinalButton) endGameFinalButton.classList.remove('hidden');
                                }
                                if (playerExitButtonResults) playerExitButtonResults.classList.add('hidden');
                            } else {
                                if (questionResultsHostControls) questionResultsHostControls.classList.add('hidden');
                                if (playerExitButtonResults) playerExitButtonResults.classList.remove('hidden');
                            }
                            break;
                        case 'final_results':
                            clearInterval(timerInterval);
                            clearInterval(currentQuestionSoundInterval);
                            soundStarted = false;
                            if (hostTimeUpdater) {
                                clearInterval(hostTimeUpdater);
                                hostTimeUpdater = null;
                            }
                            // Reset lastDisplayedQuestionIndex
                            lastDisplayedQuestionIndex = -1;
                            selectedMultipleChoiceOption = null; // Reset selected multiple choice option
                            showFinalScores();
                            break;
                    }
                } else {
                    showCustomMessageBox("اللعبة غير موجودة", "تم إغلاق الغرفة.");
                    exitGame();
                }
            }, (error) => {
                showCustomMessageBox("خطأ في الاتصال", `فقد الاتصال باللعبة.`);
                exitGame();
            });
        }

        function listenToPlayers() {
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe();

            const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);

            playersSnapshotUnsubscribe = playersRef.onSnapshot((snapshot) => {
                if (joinedPlayersList) joinedPlayersList.innerHTML = '';
                
                let currentPlayerOverallScore = 0;
                
                db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).get().then(gameDoc => {
                    let hostIdFromGame = null;
                    let gamePhase = 'lobby';
                    if (gameDoc.exists) {
                        const gameData = gameDoc.data();
                        hostIdFromGame = gameData.hostId;
                        gamePhase = gameData.gamePhase;
                    }

                    if (hostSubmissionStatusList && isHost) {  
                        hostSubmissionStatusList.innerHTML = '';
                    }

                    snapshot.forEach((doc) => {
                        const playerData = doc.data();
                        const playerId = doc.id;

                        if (joinedPlayersList) {
                            const listItem = document.createElement('li');
                            let playerDisplayName = playerData.nickname || 'لاعب مجهول';
                            if (hostIdFromGame && hostIdFromGame === playerId) {
                                playerDisplayName += ' <i class="fas fa-crown text-yellow-500"></i> (المضيف)';
                            }
                            listItem.innerHTML = `${playerDisplayName} <span class="font-bold">(النقاط: ${playerData.score || 0})</span>`;
                            joinedPlayersList.appendChild(listItem);
                        }

                        if (hostSubmissionStatusList && isHost) {
                            const statusItem = document.createElement('li');
                            const scoreChangeValue = playerData.playerScoreChange || 0;
                            const submittedAnswerActual = playerData.playerSubmittedAnswer;
                            const selectedPointsActual = playerData.playerSelectedPoints || 0;
                            let statusIcon = playerData.hasSubmittedAnswer ? '<i class="fas fa-check-circle text-green-500 ml-2"></i>' : '<i class="fas fa-hourglass-half text-gray-500 ml-2"></i>';
                            let submittedAnswerText = playerData.hasSubmittedAnswer ? `إجابة: ${submittedAnswerActual || 'لا توجد'}` : 'لم يجب';
                            let scoreInfo = (scoreChangeValue !== 0 || selectedPointsActual > 0) ? `(راهن بـ ${selectedPointsActual}، تغيير: ${scoreChangeValue >= 0 ? '+' : ''}${scoreChangeValue})` : '';
                            statusItem.innerHTML = `${playerData.nickname || 'مجهول'}: ${statusIcon} ${submittedAnswerText} ${scoreInfo}`;
                            hostSubmissionStatusList.appendChild(statusItem);
                        }

                        if (playerId === userId) {
                            currentPlayerOverallScore = playerData.score || 0;
                            userUsedPointsBets = playerData.usedPointsBets || [];  
                            populatePointsButtons();
                            const powerUps = playerData.powerUpsUsed || { doublePoints: false, extraTime: false, hint: false };
                            updatePowerUpButtonsUI(powerUps);
                        }
                    });
                    if (playerScoreDisplay) playerScoreDisplay.innerHTML = currentPlayerOverallScore;

                    if (gamePhase === 'lobby' && isHost) {
                        if (snapshot.size >= 1) { 
                           if (startGameButton) startGameButton.classList.remove('hidden');  
                        } else {  
                           if (startGameButton) startGameButton.classList.add('hidden');  
                        }
                    }

                });

            });
        }
        
        function updatePowerUpButtonsUI(powerUpsUsed) {
            if (powerUpDoublePointsBtn) powerUpDoublePointsBtn.disabled = powerUpsUsed.doublePoints;
            if (powerUpExtraTimeBtn) powerUpExtraTimeBtn.disabled = powerUpsUsed.extraTime;
            if (powerUpHintBtn) powerUpHintBtn.disabled = powerUpsUsed.hint;
        }

        function showQuestionPlayerScoresDetailed() {
            if (questionPlayerScoresList) questionPlayerScoresList.innerHTML = '';
            showLoading();
            try {
                const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                playersRef.get().then(playersSnapshot => {
                    db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).get().then(gameDoc => {
                        const gameData = gameDoc.data();
                        const currentCorrectAnswers = gameData.currentCorrectAnswers || [];
                        const currentQuestionOptions = gameData.currentQuestionOptions;
                        const currentCorrectAnswerIndex = gameData.currentCorrectAnswerIndex;

                        let questionScores = [];
                        playersSnapshot.forEach(doc => {
                            const playerData = doc.data();
                            questionScores.push({
                                nickname: playerData.nickname,
                                submittedAnswer: playerData.playerSubmittedAnswer || 'لم يجب',
                                selectedPoints: playerData.playerSelectedPoints || 0,
                                scoreChange: playerData.playerScoreChange || 0,
                                overallScore: playerData.score || 0
                            });
                        });
                        questionScores.sort((a, b) => (b.overallScore || 0) - (a.overallScore || 0));

                        if (questionPlayerScoresList) {
                            questionScores.forEach((player, index) => {
                                const listItem = document.createElement('li');
                                listItem.classList.add('py-2', 'px-4', 'rounded-lg', 'mb-2', 'bg-gray-50', 'flex', 'flex-wrap', 'justify-center', 'items-center', 'gap-x-4');
                                let isPlayerAnswerCorrect = false;
                                if (player.submittedAnswer !== 'لم يجب') {
                                    if (currentQuestionOptions && currentCorrectAnswerIndex !== null) {
                                        // Multiple choice question
                                        const correctOptionText = currentQuestionOptions[currentCorrectAnswerIndex];
                                        isPlayerAnswerCorrect = (player.submittedAnswer === correctOptionText);
                                    } else {
                                        // Open-ended question
                                        isPlayerAnswerCorrect = isCorrectAnswer(player.submittedAnswer, currentCorrectAnswers);
                                    }
                                }
                                const answerStatusIcon = player.submittedAnswer !== 'لم يجب' ? (isPlayerAnswerCorrect ? `<i class="fas fa-check-circle text-green-500 mr-2"></i>` : `<i class="fas fa-times-circle text-red-500 mr-2"></i>`) : `<i class="fas fa-question-circle text-gray-500 mr-2"></i>`;
                                const answerColorClass = player.submittedAnswer !== 'لم يجب' ? (isPlayerAnswerCorrect ? 'text-green-700' : 'text-red-700') : 'text-gray-500';
                                listItem.innerHTML = `<span class="font-bold">المركز ${index + 1}: ${player.nickname}</span> <span class="${answerColorClass}">${answerStatusIcon} ${player.submittedAnswer}</span> <span class="text-xs text-gray-600">(راهن بـ ${player.selectedPoints} | تغيير: ${player.scoreChange >= 0 ? '+' : ''}${player.scoreChange} | إجمالي: ${player.overallScore})</span>`;
                                questionPlayerScoresList.appendChild(listItem);
                            });
                        }
                    });
                });
            } catch (error) {
                showCustomMessageBox("خطأ", "فشل عرض نتائج السؤال.");
            } finally {
                hideLoading();
            }
        }

        async function showFinalScores() {
            showLoading();
            try {
                clearInterval(currentQuestionSoundInterval);
                soundStarted = false;
                clearInterval(timerInterval);
                if (hostTimeUpdater) {
                    clearInterval(hostTimeUpdater);
                    hostTimeUpdater = null;
                }

                const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersSnapshot = await playersRef.get();
                let finalScores = [];
                playersSnapshot.forEach(doc => { finalScores.push(doc.data()); });
                finalScores.sort((a, b) => (b.score || 0) - (a.score || 0));

                if (finalScoresList) {
                    finalScoresList.innerHTML = '';
                    if (finalScores.length > 0) {
                        finalScores.forEach((player, index) => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('py-2', 'px-4', 'rounded-lg', 'mb-2');
                            if (index === 0) {
                                listItem.classList.add('bg-yellow-200', 'font-bold', 'text-yellow-800', 'scale-105', 'shadow-lg');
                                listItem.innerHTML = `<i class="fas fa-trophy text-yellow-600 mr-2"></i> المركز الأول: ${player.nickname} - ${player.score} نقطة`;
                            } else {
                                listItem.classList.add('bg-gray-50');
                                listItem.textContent = `المركز ${index + 1}: ${player.nickname} - ${player.score} نقطة`;
                            }
                            finalScoresList.appendChild(listItem);
                        });
                        if (endTitle) endTitle.textContent = "انتهت اللعبة!";
                        if (endMessage) endMessage.textContent = `تهانينا! فاز ${finalScores[0].nickname} بـ ${finalScores[0].score} نقطة!`;
                    } else {
                        if (endTitle) endTitle.textContent = "انتهت اللعبة!";
                        if (endMessage) endMessage.textContent = "لم يكن هناك لاعبون.";
                    }
                }

                showScreen(gameEndScreen);

                if (isHost && startNewRoundSameRoomButton) {
                    startNewRoundSameRoomButton.classList.remove('hidden');
                } else if (startNewRoundSameRoomButton) {
                    startNewRoundSameRoomButton.classList.add('hidden');
                }

            } catch (error) {
                showCustomMessageBox("خطأ", "فشل عرض النتائج النهائية.");
            } finally {
                hideLoading();
            }
        }

        if (createHostButton) { createHostButton.addEventListener('click', () => { setupQuizCategorySelection(); if (hostNicknameInput) hostNicknameInput.value = localStorage.getItem('hostNickname') || ''; showScreen(hostSetupScreen); }); }
        if (joinPlayerButton) { joinPlayerButton.addEventListener('click', () => { if (playerNicknameInput) playerNicknameInput.value = localStorage.getItem('playerNickname') || ''; showScreen(joinGameScreen); }); }
        if (createGameButton) createGameButton.addEventListener('click', createGame);
        // Modified submitAnswerButton to call submitGuess without arguments (for text input)
        if (submitAnswerButton) submitAnswerButton.addEventListener('click', () => submitGuess());
        if (startGameButton) startGameButton.addEventListener('click', initiateGameStartCountdown);  
        if (endQuestionEarlyButton) endQuestionEarlyButton.addEventListener('click', endQuestionEarly);  
        if (nextQuestionButton) nextQuestionButton.addEventListener('click', startNextQuestion);  
        if (endGameFinalButton) endGameFinalButton.addEventListener('click', endGame);
        if (startNewRoundSameRoomButton) startNewRoundSameRoomButton.addEventListener('click', startNewRoundInSameRoom);
        if (playerExitButtonGameplay) playerExitButtonGameplay.addEventListener('click', exitGame);
        if (playerExitButtonResults) playerExitButtonResults.addEventListener('click', exitGame);

        if (joinRoomButton) {
            joinRoomButton.addEventListener('click', () => {
                const code = gameCodeInput ? gameCodeInput.value.trim().toUpperCase() : '';
                const nickname = playerNicknameInput ? playerNicknameInput.value.trim() : '';
                if (code && nickname) { joinGame(code, nickname); }
                else { showCustomMessageBox("خطأ", "يرجى إدخال رمز الغرفة واسمك المستعار."); }
            });
        }

        if (gameGuessInput) {
            gameGuessInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitGuess();
                }
            });
        }

        if (playAgainButton) { playAgainButton.addEventListener('click', exitGame); }
        
        if (powerUpDoublePointsBtn) {
            powerUpDoublePointsBtn.addEventListener('click', () => {
                if (powerUpDoublePointsBtn.disabled) return;
                isDoublePointsActive = !isDoublePointsActive;
                if (isDoublePointsActive) {
                    powerUpDoublePointsBtn.classList.add('ring-4', 'ring-yellow-300', 'opacity-50');
                    showCustomMessageBox("ضعف النقاط!", "تم تفعيل قوة ضعف النقاط لهذا السؤال.");
                } else {
                    powerUpDoublePointsBtn.classList.remove('ring-4', 'ring-yellow-300', 'opacity-50');
                }
            });
        }

        if (powerUpExtraTimeBtn) {
            powerUpExtraTimeBtn.addEventListener('click', async () => {
                if (powerUpExtraTimeBtn.disabled) return;
                try {
                    const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                    const playerRef = gameRef.collection('players').doc(userId);
                    
                    await db.runTransaction(async (transaction) => {
                         const gameDocSnap = await transaction.get(gameRef);
                         if (!gameDocSnap.exists) {
                             throw new Error("Game not found.");
                         }
                         const gameData = gameDocSnap.data();
                         // Increase currentRemainingTime by 15 seconds
                         const newRemainingTime = (gameData.currentRemainingTime || 0) + 15; 
                         
                         transaction.update(gameRef, { 
                             currentRemainingTime: newRemainingTime 
                         });
                         transaction.update(playerRef, { 'powerUpsUsed.extraTime': true });
                    });
                     showCustomMessageBox("وقت إضافي!", "تمت إضافة 15 ثانية.");
                } catch (e) {
                     showCustomMessageBox("خطأ", "لم نتمكن من استخدام قوة الوقت الإضافي.");
                     console.error("Error using extra time power-up:", e);
                }
            });
        }

        if (powerUpHintBtn) {
            powerUpHintBtn.addEventListener('click', async () => {
                 if (powerUpHintBtn.disabled) return;
                 try {
                     const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                     const playerRef = gameRef.collection('players').doc(userId);
                     const gameDoc = await gameRef.get();
                     if (gameDoc.exists) {
                         const displayAnswer = gameDoc.data().currentDisplayAnswer;
                         await playerRef.update({ 'powerUpsUsed.hint': true });
                         showJokerHintMessage(displayAnswer); // Use the new dedicated function
                     }
                 } catch (e) {
                     showCustomMessageBox("خطأ", "لم نتمكن من استخدام قوة الجوكر.");
                 }
            });
        }

    </script>


    
<!-- مكتبة QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    // This script block seems to duplicate QR code generation and might cause issues.
    // The main script block already handles QR code generation when gameId is set.
    // I will keep the original QR code logic and remove this duplicated one.
    // The existing generateQRCode function is already called in createGame.
    // The window.addEventListener('DOMContentLoaded') here would likely run before
    // the main script's initializeFirebase completes and gameId is set for game link display.
    // Keeping the original logic as it's better integrated.
</script>

    
</body>
</html>
