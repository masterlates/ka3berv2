<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¨ÙˆØ±ÙƒÙ„ Ø¨Ø§Ø±ØªÙŠ (Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for audio effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* Base font and direction for Arabic */
        body {
            font-family: 'Cairo', sans-serif; /* Changed to Cairo font */
            direction: rtl; /* For Arabic text */
            text-align: right; /* For Arabic text */
        }
        /* Custom animation for list items - Tailwind's default doesn't have this exact one */
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInFromBottom 0.5s ease-out forwards;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4a90e2; /* Blue color for spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for the copy button */
        .copy-button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .copy-button:hover {
            background-color: #45a049;
        }
        /* Style for the QR code container */
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            min-height: 128px; /* Ensure space even if QR fails */
        }
        .multiselect-container {
            position: relative;
            width: 100%;
        }
        .multiselect-dropdown {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 10;
            margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .multiselect-dropdown label {
            display: block;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .multiselect-dropdown label:hover {
            background-color: #e2e8f0;
        }
        .multiselect-selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .tag {
            background-color: #a78bfa; /* Purple-300 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Full rounded */
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .tag-remove:hover {
            opacity: 1;
        }
        /* Styles for points buttons */
        .points-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }
        .points-button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #cbd5e0; /* gray-300 */
            background-color: #f8fafc; /* gray-50 */
            color: #4a5568; /* gray-700 */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .points-button.selected {
            background-color: #6366f1; /* indigo-500 */
            color: white;
            border-color: #6366f1;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .points-button.used { /* Style for used/disabled buttons */
            background-color: #e2e8f0; /* gray-200 */
            color: #94a3b8; /* slate-400 */
            border-color: #cbd5e0; /* gray-300 */
            cursor: not-allowed;
            opacity: 0.8;
            text-decoration: line-through;
        }
        .points-button:not(.selected):hover {
            background-color: #e2e8f0; /* gray-200 */
            border-color: #a0aec0; /* gray-400 */
        }
        .points-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 min-h-screen flex flex-col items-center justify-center p-4 text-gray-800">

    <!-- Loading Overlay - Shown during Firebase initialization or data fetching -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center text-white text-xl">
            <div class="loading-spinner mb-4"></div>
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... <!-- Loading text in Arabic -->
        </div>
    </div>

    <!-- Game Start Countdown Screen -->
    <div id="game-countdown-screen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center text-yellow-400 text-9xl font-extrabold z-50 hidden">
        <span id="countdown-timer-display">5</span>
    </div>

    <!-- Main Game Container -->
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full flex flex-col items-center relative overflow-hidden transform transition-all duration-500 ease-in-out">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 text-center leading-tight">Ù„Ø¹Ø¨Ø© Ø³Ø¨ÙˆØ±ÙƒÙ„ Ø¨Ø§Ø±ØªÙŠ <i class="fas fa-users text-blue-500"></i></h1>
        <p class="text-lg text-gray-600 mb-8 text-center" id="game-description">
            Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ: Ø¥Ù…Ø§ Ù…Ø¶ÙŠÙ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©ØŒ Ø£Ùˆ Ù„Ø§Ø¹Ø¨ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©. <!-- Game description in Arabic -->
        </p>

        <!-- Role Selection Screen -->
        <div id="role-selection-screen" class="w-full flex flex-col items-center space-y-6">
            <button id="create-host-button" class="w-full md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-crown"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© (Ù…Ø¶ÙŠÙ) <!-- Create host room button -->
            </button>
            <button id="join-player-button" class="w-full md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-gamepad"></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© (Ù„Ø§Ø¹Ø¨) <!-- Join player room button -->
            </button>
        </div>

        <!-- Host Room Setup Screen -->
        <div id="host-setup-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">Ø¥Ø¹Ø¯Ø§Ø¯ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨</h2> <!-- Host setup title -->

            <div class="w-full mb-6">
                <label for="host-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2">Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± (Ø§Ù„Ù…Ø¶ÙŠÙ):</label>
                <input type="text" id="host-nickname-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¶ÙŠÙ"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
            </div>

            <div class="w-full mb-6">
                <label for="quiz-category-input" class="block text-xl font-semibold text-gray-700 mb-2">Ø§Ø®ØªØ± ÙØ¦Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ§Ø­Ø¯Ø©):</label>
                <div class="multiselect-container">
                    <input type="text" id="quiz-category-input" readonly placeholder="Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø§Øª..."
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 cursor-pointer">
                    <div id="quiz-category-dropdown" class="multiselect-dropdown hidden">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>
                <div id="selected-categories-tags" class="multiselect-selected-tags">
                    <!-- Selected tags will appear here -->
                </div>
            </div>

            <div class="w-full mb-6">
                <label for="total-questions-per-game-select" class="block text-xl font-semibold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙƒÙ„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©:</label>
                <select id="total-questions-per-game-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                    <option value="10">10 Ø£Ø³Ø¦Ù„Ø©</option>
                    <option value="15">15 Ø³Ø¤Ø§Ù„</option>
                    <option value="20">20 Ø³Ø¤Ø§Ù„</option>
                    <option value="30">30 Ø³Ø¤Ø§Ù„</option>
                </select>
            </div>

            <div class="w-full mb-6">
                <label for="time-limit-select" class="block text-xl font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØµØµ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label> <!-- Time limit label -->
                <select id="time-limit-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="15">15 Ø«Ø§Ù†ÙŠØ©</option>
                    <option value="20">20 Ø«Ø§Ù†ÙŠØ©</option>
                    <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
                    <option value="45">45 Ø«Ø§Ù†ÙŠØ©</option>
                    <option value="60">60 Ø«Ø§Ù†ÙŠØ©</option>
                </select>
            </div>

            <button id="create-game-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© <!-- Create game button -->
            </button>
        </div>

        <!-- Waiting Room Screen (Host & Player) -->
        <div id="waiting-room-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4" id="waiting-room-title">Ø§Ù†ØªØ¸Ø± Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</h2> <!-- Waiting room title -->
            <p class="text-xl text-gray-700 mb-6">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</p> <!-- Share link instruction -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 flex flex-col items-center">
                <span id="game-link-display" class="text-md md:text-xl font-medium text-blue-600 break-all text-center"></span>
                <div id="qrcode" class="mb-2 p-2 bg-white rounded-lg shadow-md flex justify-center items-center">
                    <!-- QR code will be rendered here by JavaScript -->
                    <div id="qrcode-fallback-message" class="text-gray-500 text-sm text-center">
                        <!-- Fallback message for QR code -->
                    </div>
                </div>
                <button id="copy-link-button" class="copy-button mt-4">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>
            
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…Ù†Ø¶Ù…ÙˆÙ†:</h3> <!-- Joined players list title -->
            <ul id="joined-players-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 h-40 overflow-y-auto shadow-inner text-lg">
                <!-- Players will be listed here by JavaScript -->
            </ul>

            <button id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out hidden">
                <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨! <!-- Start game button (for host) -->
            </button>
        </div>

        <!-- Join Game Screen (Player) -->
        <div id="join-game-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨</h2> <!-- Join game title -->
            <div class="w-full mb-6">
                <label for="game-code-input" class="block text-xl font-semibold text-gray-700 mb-2">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</label> <!-- Game code input label -->
                <input type="text" id="game-code-input" placeholder="Ù…Ø«Ø§Ù„: ABCDE"
                        class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors duration-300 bg-gray-50 uppercase text-center tracking-widest">
            </div>
             <div class="w-full mb-6">
                <label for="player-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±:</label> <!-- Player nickname input label -->
                <input type="text" id="player-nickname-input" placeholder="Ø§Ø³Ù…Ùƒ"
                        class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors duration-300 bg-gray-50 text-center">
            </div>
            <button id="join-room-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-door-open"></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… <!-- Join button -->
            </button>
        </div>

        <!-- Game Play Screen (Host & Player) -->
        <div id="game-play-screen" class="w-full hidden">
            <div class="flex flex-col md:flex-row justify-between items-center w-full mb-8 space-y-4 md:space-y-0">
                <div class="flex items-center space-x-2 space-x-reverse text-2xl font-bold text-gray-700 bg-gray-100 px-5 py-3 rounded-lg shadow-md">
                    <i class="fas fa-hourglass-half text-blue-500"></i>
                    <span>Ø§Ù„ÙˆÙ‚Øª: <span id="game-timer" class="text-blue-600">--</span> Ø«Ø§Ù†ÙŠØ©</span> <!-- Game timer display -->
                </div>
                <div class="flex items-center space-x-2 space-x-reverse text-2xl font-bold text-gray-700 bg-gray-100 px-5 py-3 rounded-lg shadow-md">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span>Ù†Ù‚Ø§Ø·Ùƒ: <span id="player-score" class="text-yellow-600">0</span></span> <!-- Player's score display -->
                </div>
                <div class="flex items-center space-x-2 space-x-reverse text-2xl font-bold text-gray-700 bg-gray-100 px-5 py-3 rounded-lg shadow-md">
                    <i class="fas fa-question-circle text-purple-500"></i>
                    <span>Ø§Ù„Ø³Ø¤Ø§Ù„: <span id="question-counter" class="text-purple-600">-- / --</span></span> <!-- Question counter -->
                </div>
            </div>

            <p class="text-2xl font-bold text-gray-800 mb-4 text-center">Ø§Ù„ÙØ¦Ø©: <span id="game-category" class="text-indigo-600"></span></p> <!-- Current category display -->
            
            <div class="bg-blue-100 p-4 rounded-lg shadow-md mb-6 w-full text-center">
                <p class="text-3xl font-extrabold text-gray-900" id="game-question"></p> <!-- Current question display -->
            </div>

            <div class="flex items-center flex-wrap gap-2 w-full mb-4">
                <label for="game-guess-input" class="sr-only">Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§</label>
                <input type="text" id="game-guess-input" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."
                    class="flex-grow p-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors duration-300 bg-gray-50">
                <button id="submit-answer-button" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out flex-shrink-0">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                </button>
            </div>
            
            <div class="w-full mb-6">
                <label class="block text-xl font-semibold text-gray-700 mb-2 text-center">Ø±Ø§Ù‡Ù† Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·:</label>
                <div id="points-button-group" class="points-button-group">
                    <!-- Points buttons (1-20) will be generated here by JS -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ­Ø© (Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„):</h3> <!-- Player's correct guesses title -->
                    <ul id="player-correct-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2">
                        <!-- Player's correct guesses will be listed here -->
                    </ul>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„):</h3> <!-- Shared correct guesses title -->
                    <ul id="shared-round-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2">
                        <!-- All correct guesses across players for THIS QUESTION will be listed here -->
                    </ul>
                </div>
            </div>
            
            <!-- Host-only controls during game play -->
            <div id="host-gameplay-controls" class="w-full flex flex-col items-center gap-4 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Ø­Ø§Ù„Ø© Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø§Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø·):</h3>
                <ul id="host-submission-status-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 mb-4 shadow-inner text-base max-h-32 overflow-y-auto">
                    <!-- Player submission status will be listed here -->
                </ul>
                <button id="end-question-early-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out">
                    <i class="fas fa-flag-checkered"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¢Ù† <!-- End question early button -->
                </button>
            </div>
        </div>

        <!-- Question Results Screen (New) -->
        <div id="question-results-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¤Ø§Ù„!</h2>
            <p class="text-xl text-gray-700 mb-6 text-center">Ø§Ù„ÙØ¦Ø©: <span id="results-category" class="font-bold text-indigo-600"></span></p>
            <p class="text-2xl font-semibold text-gray-800 mb-4 text-center">Ø§Ù„Ø³Ø¤Ø§Ù„: <span id="results-question" class="font-bold text-gray-900"></span></p>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</h3>
            <ul id="round-correct-answers-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 max-h-64 overflow-y-auto shadow-inner text-lg list-disc pr-6">
                <!-- All correct answers for the question -->
            </ul>

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„:</h3>
            <ul id="question-player-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto">
                <!-- Player scores for this question -->
            </ul>

            <!-- Host controls for next question or end game -->
            <div id="question-results-host-controls" class="w-full flex flex-col items-center gap-4 hidden">
                <button id="next-question-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                    <i class="fas fa-forward"></i> Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
                <button id="end-game-final-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                    <i class="fas fa-times-circle"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
                </button>
            </div>
        </div>

        <!-- Game End Screen (Final Results) -->
        <div id="game-end-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center" id="end-title">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø¹Ø¨Ø©!</h2> <!-- Game end title -->
            <p class="text-xl text-gray-600 mb-6 text-center" id="end-message"></p> <!-- End message -->

            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</h3> <!-- Final scores title -->
            <ul id="final-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto">
                <!-- Final scores will be listed here by JavaScript -->
            </ul>

            <button id="play-again-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-redo"></i> Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ <!-- Play again button -->
            </button>
        </div>

        <!-- Custom Message Box - For alerts and confirmations -->
        <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-40 hidden transition-opacity duration-300 ease-out opacity-0">
            <div class="bg-white rounded-xl p-8 text-center shadow-xl transform scale-90 transition-transform duration-300 ease-out">
                <h2 id="custom-message-title" class="text-3xl font-bold text-gray-900 mb-4"></h2> <!-- Message title -->
                <p id="custom-message-content" class="text-xl text-gray-700 mb-6"></p> <!-- Message content -->
                <button id="custom-message-close-button" class="bg-blue-600 hover:bg-blue-700 text-white text-xl font-semibold py-3 px-8 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 ease-out">
                    Ø­Ø³Ù†Ø§Ù‹ <!-- Close button -->
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase CDN Scripts - MUST be included BEFORE main game script for global `firebase` object -->
    <!-- These load the Firebase library globally, making `firebase.initializeApp`, etc., available -->
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- QRCode.js for generating QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>

    <!-- Main JavaScript Logic -->
    <script type="text/javascript">
        // Global variables for Firebase and App
        let app, db, auth, userId, userNickname, appId;
        let gameId = null;
        let isHost = false;
        let gameSnapshotUnsubscribe = null; // Listener for game document changes
        let playersSnapshotUnsubscribe = null; // Listener for players collection changes
        let timerInterval = null; // Interval for host's game timer
        let selectedPointsBet = 1; // Default selected points bet
        let userUsedPointsBets = []; // Array to store points already used by the current player in the current GAME
        let currentQuestionSoundPlayed = false; // Flag to ensure sound plays only once per question's end-timer

        // Quiz data - IMPORTANT: Each object in quizzes now represents a CATEGORY with multiple questions.
        // Each question has a questionText and correctAnswers.
        // `displayAnswer` is the primary correct answer shown in results.
        // `correctAnswers` is a list of normalized answers for fuzzy matching.
        const quizzes = [
            {
                category: "Ø¹ÙˆØ§ØµÙ… Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
                questions: [
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ØªÙˆÙ†Ø³ØŸ", displayAnswer: "ØªÙˆÙ†Ø³", correctAnswers: ["ØªÙˆÙ†Ø³", "tunis"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ", displayAnswer: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", correctAnswers: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "cairo"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ", displayAnswer: "Ø§Ù„Ø±ÙŠØ§Ø¶", correctAnswers: ["Ø§Ù„Ø±ÙŠØ§Ø¶", "riyadh"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¹Ø±Ø§Ù‚ØŸ", displayAnswer: "Ø¨ØºØ¯Ø§Ø¯", correctAnswers: ["Ø¨ØºØ¯Ø§Ø¯", "baghdad"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø³ÙˆØ±ÙŠØ§ØŸ", displayAnswer: "Ø¯Ù…Ø´Ù‚", correctAnswers: ["Ø¯Ù…Ø´Ù‚", "damascus"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø£Ø±Ø¯Ù†ØŸ", displayAnswer: "Ø¹Ù…Ø§Ù†", correctAnswers: ["Ø¹Ù…Ø§Ù†", "amman"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù„Ø¨Ù†Ø§Ù†ØŸ", displayAnswer: "Ø¨ÙŠØ±ÙˆØª", correctAnswers: ["Ø¨ÙŠØ±ÙˆØª", "beirut"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…ØºØ±Ø¨ØŸ", displayAnswer: "Ø§Ù„Ø±Ø¨Ø§Ø·", correctAnswers: ["Ø§Ù„Ø±Ø¨Ø§Ø·", "rabat"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ØŸ", displayAnswer: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", correctAnswers: ["Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "algiers"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ØŸ", displayAnswer: "Ø§Ù„Ø®Ø±Ø·ÙˆÙ…", correctAnswers: ["Ø§Ù„Ø®Ø±Ø·ÙˆÙ…", "khartoum"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠÙ…Ù†ØŸ", displayAnswer: "ØµÙ†Ø¹Ø§Ø¡", correctAnswers: ["ØµÙ†Ø¹Ø§Ø¡", "sanaa"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªØŸ", displayAnswer: "Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ", correctAnswers: ["Ø§Ø¨ÙˆØ¸Ø¨ÙŠ", "Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ", "abu dhabi"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù‚Ø·Ø±ØŸ", displayAnswer: "Ø§Ù„Ø¯ÙˆØ­Ø©", correctAnswers: ["Ø§Ù„Ø¯ÙˆØ­Ø©", "doha"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙƒÙˆÙŠØªØŸ", displayAnswer: "Ø§Ù„ÙƒÙˆÙŠØª", correctAnswers: ["Ø§Ù„ÙƒÙˆÙŠØª", "kuwait"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†ØŸ", displayAnswer: "Ø§Ù„Ù…Ù†Ø§Ù…Ø©", correctAnswers: ["Ø§Ù„Ù…Ù†Ø§Ù…Ø©", "manama"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ØµÙˆÙ…Ø§Ù„ØŸ", displayAnswer: "Ù…Ù‚Ø¯ÙŠØ´Ùˆ", correctAnswers: ["Ù…Ù‚Ø¯ÙŠØ´Ùˆ", "mogadishu"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¬ÙŠØ¨ÙˆØªÙŠØŸ", displayAnswer: "Ø¬ÙŠØ¨ÙˆØªÙŠ", correctAnswers: ["Ø¬ÙŠØ¨ÙˆØªÙŠ", "djibouti"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¬Ø²Ø± Ø§Ù„Ù‚Ù…Ø±ØŸ", displayAnswer: "Ù…ÙˆØ±ÙˆÙ†ÙŠ", correctAnswers: ["Ù…ÙˆØ±ÙˆÙ†ÙŠ", "moroni"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù„ÙŠØ¨ÙŠØ§ØŸ", displayAnswer: "Ø·Ø±Ø§Ø¨Ù„Ø³", correctAnswers: ["Ø·Ø±Ø§Ø¨Ù„Ø³", "tripoli"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§ØŸ", displayAnswer: "Ù†ÙˆØ§ÙƒØ´ÙˆØ·", correctAnswers: ["Ù†ÙˆØ§ÙƒØ´ÙˆØ·", "nouakchott"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†ØŸ", displayAnswer: "Ù…Ø³Ù‚Ø·", correctAnswers: ["Ù…Ø³Ù‚Ø·", "muscat"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙÙ„Ø³Ø·ÙŠÙ†ØŸ", displayAnswer: "Ø§Ù„Ù‚Ø¯Ø³", correctAnswers: ["Ø§Ù„Ù‚Ø¯Ø³", "jerusalem"] }
                ]
            },
            {
                category: "Ø§Ù„ÙÙˆØ§ÙƒÙ‡",
                questions: [
                    { questionText: "ÙØ§ÙƒÙ‡Ø© Ø­Ù…Ø±Ø§Ø¡ ÙˆØµØºÙŠØ±Ø© ØºØ§Ù„Ø¨Ø§Ù‹ Ù…Ø§ ØªØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø­Ù„ÙˆÙŠØ§ØªØŸ", displayAnswer: "ÙØ±Ø§ÙˆÙ„Ø©", correctAnswers: ["ÙØ±Ø§ÙˆÙ„Ø©", "ÙƒØ±Ø²", "ØªÙˆØª"] },
                    { questionText: "ÙØ§ÙƒÙ‡Ø© ØµÙØ±Ø§Ø¡ ØªÙ†Ù…Ùˆ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØºÙ†ÙŠØ© Ø¨Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…ØŸ", displayAnswer: "Ù…ÙˆØ²", correctAnswers: ["Ù…ÙˆØ²"] },
                    { questionText: "ÙØ§ÙƒÙ‡Ø© Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠØ© Ø§Ù„Ù„ÙˆÙ†ØŒ ØºÙ†ÙŠØ© Ø¨ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠØŸ", displayAnswer: "Ø¨Ø±ØªÙ‚Ø§Ù„", correctAnswers: ["Ø¨Ø±ØªÙ‚Ø§Ù„", "ÙŠÙˆØ³ÙÙŠ", "Ù…Ø§Ù†Ø¬Ùˆ"] },
                    { questionText: "ÙØ§ÙƒÙ‡Ø© Ø§Ø³ØªÙˆØ§Ø¦ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø°Ø§Øª Ù‚Ø´Ø±Ø© Ø®Ø¶Ø±Ø§Ø¡ Ø´Ø§Ø¦ÙƒØ© ÙˆÙ„Ø­Ù… Ø£ØµÙØ± Ø­Ù„Ùˆ Ø¬Ø¯Ø§Ù‹ØŸ", displayAnswer: "Ø£Ù†Ø§Ù†Ø§Ø³", correctAnswers: ["Ø£Ù†Ø§Ù†Ø§Ø³"] },
                    { questionText: "ÙØ§ÙƒÙ‡Ø© ØµÙŠÙÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø§Ù„Ø­Ø¬Ù…ØŒ Ø®Ø¶Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬ ÙˆØ­Ù…Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ Ù…Ø¹ Ø¨Ø°ÙˆØ± Ø³ÙˆØ¯Ø§Ø¡ØŸ", displayAnswer: "Ø¯Ù„Ø§Ø¹", correctAnswers: ["Ø¯Ù„Ø§Ø¹"] }
                ]
            },
            {
                category: "Ø¹ÙˆØ§ØµÙ… Ø¯ÙˆÙ„ Ø£ÙˆØ±ÙˆØ¨ÙŠØ©",
                questions: [
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø£Ù„Ù…Ø§Ù†ÙŠØ§ØŸ", displayAnswer: "Ø¨Ø±Ù„ÙŠÙ†", correctAnswers: ["Ø¨Ø±Ù„ÙŠÙ†", "berlin"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙØ±Ù†Ø³Ø§ØŸ", displayAnswer: "Ø¨Ø§Ø±ÙŠØ³", correctAnswers: ["Ø¨Ø§Ø±ÙŠØ³", "paris"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¥ÙŠØ·Ø§Ù„ÙŠØ§ØŸ", displayAnswer: "Ø±ÙˆÙ…Ø§", correctAnswers: ["Ø±ÙˆÙ…Ø§", "rome"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§ØŸ", displayAnswer: "Ù…Ø¯Ø±ÙŠØ¯", correctAnswers: ["Ù…Ø¯Ø±ÙŠØ¯", "madrid"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©ØŸ", displayAnswer: "Ù„Ù†Ø¯Ù†", correctAnswers: ["Ù„Ù†Ø¯Ù†", "london"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¨ÙˆÙ„Ù†Ø¯Ø§ØŸ", displayAnswer: "ÙˆØ§Ø±Ø³Ùˆ", correctAnswers: ["ÙˆØ§Ø±Ø³Ùˆ", "warsaw"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø£ÙˆÙƒØ±Ø§Ù†ÙŠØ§ØŸ", displayAnswer: "ÙƒÙŠÙŠÙ", correctAnswers: ["ÙƒÙŠÙŠÙ", "kiev"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø±ÙˆÙ…Ø§Ù†ÙŠØ§ØŸ", displayAnswer: "Ø¨ÙˆØ®Ø§Ø±Ø³Øª", correctAnswers: ["Ø¨ÙˆØ®Ø§Ø±Ø³Øª", "bucharest"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù‡ÙˆÙ„Ù†Ø¯Ø§ØŸ", displayAnswer: "Ø£Ù…Ø³ØªØ±Ø¯Ø§Ù…", correctAnswers: ["Ø£Ù…Ø³ØªØ±Ø¯Ø§Ù…", "amsterdam"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¨Ù„Ø¬ÙŠÙƒØ§ØŸ", displayAnswer: "Ø¨Ø±ÙˆÙƒØ³Ù„", correctAnswers: ["Ø¨Ø±ÙˆÙƒØ³Ù„", "brussels"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠÙˆÙ†Ø§Ù†ØŸ", displayAnswer: "Ø£Ø«ÙŠÙ†Ø§", correctAnswers: ["Ø£Ø«ÙŠÙ†Ø§", "athens"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¨Ø±ØªØºØ§Ù„ØŸ", displayAnswer: "Ù„Ø´Ø¨ÙˆÙ†Ø©", correctAnswers: ["Ù„Ø´Ø¨ÙˆÙ†Ø©", "lisbon"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø³ÙˆÙŠØ¯ØŸ", displayAnswer: "Ø³ØªÙˆÙƒÙ‡ÙˆÙ„Ù…", correctAnswers: ["Ø³ØªÙˆÙƒÙ‡ÙˆÙ„Ù…", "stockholm"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù†Ù…Ø³Ø§ØŸ", displayAnswer: "ÙÙŠÙŠÙ†Ø§", correctAnswers: ["ÙÙŠÙŠÙ†Ø§", "vienna"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø³ÙˆÙŠØ³Ø±Ø§ØŸ", displayAnswer: "Ø¨Ø±Ù†", correctAnswers: ["Ø¨Ø±Ù†", "bern"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¯Ù†Ù…Ø§Ø±ÙƒØŸ", displayAnswer: "ÙƒÙˆØ¨Ù†Ù‡Ø§ØºÙ†", correctAnswers: ["ÙƒÙˆØ¨Ù†Ù‡Ø§ØºÙ†", "copenhagen"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙÙ†Ù„Ù†Ø¯Ø§ØŸ", displayAnswer: "Ù‡Ù„Ø³Ù†ÙƒÙŠ", correctAnswers: ["Ù‡Ù„Ø³Ù†ÙƒÙŠ", "helsinki"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù†Ø±ÙˆÙŠØ¬ØŸ", displayAnswer: "Ø£ÙˆØ³Ù„Ùˆ", correctAnswers: ["Ø£ÙˆØ³Ù„Ùˆ", "oslo"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¥ÙŠØ±Ù„Ù†Ø¯Ø§ØŸ", displayAnswer: "Ø¯Ø¨Ù„Ù†", correctAnswers: ["Ø¯Ø¨Ù„Ù†", "dublin"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙƒØ±ÙˆØ§ØªÙŠØ§ØŸ", displayAnswer: "Ø²ØºØ±Ø¨", correctAnswers: ["Ø²ØºØ±Ø¨", "zagreb"] }
                ]
            },
            {
                category: "Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„ØºØ§Ø¨Ø©",
                questions: [
                    { questionText: "Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©ØŸ", displayAnswer: "Ø£Ø³Ø¯", correctAnswers: ["Ø£Ø³Ø¯", "Ø§Ø³Ø¯"] },
                    { questionText: "Ø­ÙŠÙˆØ§Ù† Ù…Ø®Ø·Ø· Ø¨Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙˆØ§Ù„Ø£Ø³ÙˆØ¯ ÙŠØ´Ø¨Ù‡ Ø§Ù„Ø­ØµØ§Ù†ØŸ", displayAnswer: "Ø­Ù…Ø§Ø± ÙˆØ­Ø´ÙŠ", correctAnswers: ["Ø­Ù…Ø§Ø± ÙˆØ­Ø´ÙŠ", "Ø­Ù…Ø§Ø±ÙˆØ­Ø´ÙŠ"] },
                    { questionText: "Ø£ÙƒØ¨Ø± Ø­ÙŠÙˆØ§Ù† Ø¨Ø±ÙŠ Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„Ø£Ø±Ø¶ØŒ Ø¨Ø®Ø±Ø·ÙˆÙ… Ø·ÙˆÙŠÙ„ ÙˆØ£Ø°Ù†ÙŠÙ† ÙƒØ¨ÙŠØ±ØªÙŠÙ†ØŸ", displayAnswer: "ÙÙŠÙ„", correctAnswers: ["ÙÙŠÙ„", "Ø§Ù„ÙÙŠÙ„"] },
                    { questionText: "Ø­ÙŠÙˆØ§Ù† Ø·ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù†Ù‚ Ø°Ùˆ Ø¨Ù‚Ø¹ Ø¨Ù†ÙŠØ©ØŒ ÙŠØªØºØ°Ù‰ Ø¹Ù„Ù‰ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø£Ø´Ø¬Ø§Ø± Ø§Ù„Ø¹Ø§Ù„ÙŠØ©ØŸ", displayAnswer: "Ø²Ø±Ø§ÙØ©", correctAnswers: ["Ø²Ø±Ø§ÙØ©", "Ø§Ù„Ø²Ø±Ø§ÙØ©"] },
                    { questionText: "Ø­ÙŠÙˆØ§Ù† Ø°ÙƒÙŠ ÙŠØ¹ÙŠØ´ ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø§Øª ÙŠØ£ÙƒÙ„ Ø§Ù„Ù…ÙˆØ² ÙˆÙŠØªØ£Ø±Ø¬Ø­ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø´Ø¬Ø§Ø±ØŸ", displayAnswer: "Ù‚Ø±Ø¯", correctAnswers: ["Ù‚Ø±Ø¯", "Ø§Ù„Ù‚Ø±Ø¯"] }
                ]
            },
            {
                category: "Ø¹ÙˆØ§ØµÙ… Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù… (ØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)",
                questions: [
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ØŸ", displayAnswer: "Ø·ÙˆÙƒÙŠÙˆ", correctAnswers: ["Ø·ÙˆÙƒÙŠÙˆ", "tokyo"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø© Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ©ØŸ", displayAnswer: "ÙˆØ§Ø´Ù†Ø·Ù†", correctAnswers: ["ÙˆØ§Ø´Ù†Ø·Ù†", "washington"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø±ÙˆØ³ÙŠØ§ØŸ", displayAnswer: "Ù…ÙˆØ³ÙƒÙˆ", correctAnswers: ["Ù…ÙˆØ³ÙƒÙˆ", "moscow"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ØµÙŠÙ†ØŸ", displayAnswer: "Ø¨ÙƒÙŠÙ†", correctAnswers: ["Ø¨ÙƒÙŠÙ†", "beijing"] },
                    { questionText: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù‡Ù†Ø¯ØŸ", displayAnswer: "Ù†ÙŠÙˆØ¯Ù„Ù‡ÙŠ", correctAnswers: ["Ù†ÙŠÙˆØ¯Ù„Ù‡ÙŠ", "new delhi"] }
                ]
            },
            {
                category: "Ø£Ø³Ø¦Ù„Ø© ØªÙˆÙ†Ø³ÙŠØ©",
                questions: [
                    { questionText: "Ø´Ù†ÙˆØ© Ø¹Ø§ØµÙ…Ø© ØªÙˆÙ†Ø³ØŸ", displayAnswer: "ØªÙˆÙ†Ø³", correctAnswers: ["ØªÙˆÙ†Ø³", "tunis", "tounes"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ©ØŸ", displayAnswer: "Ø¯ÙŠÙ†Ø§Ø±", correctAnswers: ["Ø¯ÙŠÙ†Ø§Ø±", "dinar", "Ø¯Ù†ÙŠØ§Ø±"] },
                    { questionText: "Ø´ÙƒÙˆÙ† Ø±Ø¨Ø­ ÙƒØ§Ø³ Ø§ÙØ±ÙŠÙ‚ÙŠØ§ 2004ØŸ", displayAnswer: "ØªÙˆÙ†Ø³", correctAnswers: ["ØªÙˆÙ†Ø³", "Ø§Ù„Ù…Ù†ØªØ®Ø¨ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ", "tounes", "Ù…Ù†ØªØ®Ø¨ ØªÙˆÙ†Ø³"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ø³Ù… Ø£Ø·ÙˆÙ„ ÙˆØ§Ø¯ ÙÙŠ ØªÙˆÙ†Ø³ØŸ", displayAnswer: "ÙˆØ§Ø¯ Ù…Ø¬Ø±Ø¯Ø©", correctAnswers: ["ÙˆØ§Ø¯ Ù…Ø¬Ø±Ø¯Ø©", "Ù…Ø¬Ø±Ø¯Ø©", "ÙˆØ§Ø¯ÙŠ Ù…Ø¬Ø±Ø¯Ø©", "oued mejerdah"] },
                    { questionText: "Ø´ÙƒÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ø£ÙˆÙ„ Ù„ØªÙˆÙ†Ø³ØŸ", displayAnswer: "Ø§Ù„Ø­Ø¨ÙŠØ¨ Ø¨ÙˆØ±Ù‚ÙŠØ¨Ø©", correctAnswers: ["Ø§Ù„Ø­Ø¨ÙŠØ¨ Ø¨ÙˆØ±Ù‚ÙŠØ¨Ø©", "Ø¨ÙˆØ±Ù‚ÙŠØ¨Ø©", "Ø­Ø¨ÙŠØ¨ Ø¨ÙˆØ±Ù‚ÙŠØ¨Ø©", "bourguiba"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ø³Ù… Ù…Ø¯ÙŠÙ†Ø© ØªÙˆÙ†Ø³ÙŠØ© Ù…Ø´Ù‡ÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©ØŸ", displayAnswer: "Ø­Ù…Ø§Ù… Ø§Ù„Ø£Ù†Ù", correctAnswers: ["Ø­Ù…Ø§Ù… Ø§Ù„Ø£Ù†Ù", "Ø­Ù…Ø§Ù… Ø§Ù„Ø§Ù†Ù", "hammam linf", "hamam lanf"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ù„Ø£ÙƒÙ„Ø© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ© Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø© Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ ÙƒØ³ÙƒØ³ÙŠ ÙˆØ®Ø¶Ø±Ø© ÙˆÙ„Ø­Ù…ØŸ", displayAnswer: "ÙƒØ³ÙƒØ³ÙŠ", correctAnswers: ["ÙƒØ³ÙƒØ³ÙŠ", "ÙƒØ³ÙƒØ³", "couscous"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ù„Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø«Ù‚Ø§ÙÙŠØ© Ù„ØªÙˆÙ†Ø³ØŸ", displayAnswer: "Ø§Ù„Ù‚ÙŠØ±ÙˆØ§Ù†", correctAnswers: ["Ø§Ù„Ù‚ÙŠØ±ÙˆØ§Ù†", "kairouan", "kayrawan"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ø³Ù… Ø£Ø´Ù‡Ø± Ø·Ø¨Ù‚ Ø­Ù„ÙˆÙŠØ§Øª ØªÙˆÙ†Ø³ÙŠ ÙÙŠ Ø§Ù„Ø£Ø¹ÙŠØ§Ø¯ØŸ", displayAnswer: "Ø§Ù„Ù…Ù‚Ø±ÙˆØ¶", correctAnswers: ["Ø§Ù„Ù…Ù‚Ø±ÙˆØ¶", "Ù…Ù‚Ø±ÙˆØ¶", "makroudh"] },
                    { questionText: "Ø£ÙƒØ¨Ø± Ø¬Ø²ÙŠØ±Ø© ØªÙˆÙ†Ø³ÙŠØ©ØŸ", displayAnswer: "Ø¬Ø±Ø¨Ø©", correctAnswers: ["Ø¬Ø±Ø¨Ø©", "djerba", "jareba"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ø³Ù… Ø§Ù„Ø¬Ø¨Ù„ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙÙŠ ØªÙˆÙ†Ø³ØŸ", displayAnswer: "Ø¬Ø¨Ù„ Ø§Ù„Ø´Ø¹Ø§Ù†Ø¨ÙŠ", correctAnswers: ["Ø¬Ø¨Ù„ Ø§Ù„Ø´Ø¹Ø§Ù†Ø¨ÙŠ", "Ø§Ù„Ø´Ø¹Ø§Ù†Ø¨ÙŠ", "chambi"] },
                    { questionText: "ÙÙ†Ø§Ù† ØªÙˆÙ†Ø³ÙŠ Ù…Ø´Ù‡ÙˆØ± Ø¨Ø£ØºÙ†ÙŠØ© 'ÙŠØ§ Ù„ÙŠÙ„Ù‰ ÙŠØ§ Ù„ÙŠÙ„Ø©'ØŸ", displayAnswer: "ØµØ§Ø¨Ø± Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ", correctAnswers: ["ØµØ§Ø¨Ø± Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ", "Ø±Ø¨Ø§Ø¹ÙŠ", "saber rebai"] },
                    { questionText: "Ø´Ù†ÙˆØ© Ø§Ø³Ù… Ø¨Ø­ÙŠØ±Ø© ØªÙˆÙ†Ø³ÙŠØ© Ù…Ø´Ù‡ÙˆØ±Ø© Ø¨Ø§Ù„Ø·ÙŠÙˆØ± Ø§Ù„Ù…Ù‡Ø§Ø¬Ø±Ø©ØŸ", displayAnswer: "Ø¨Ø­ÙŠØ±Ø© Ø¥Ø´ÙƒÙ„", correctAnswers: ["Ø¨Ø­ÙŠØ±Ø© Ø¥Ø´ÙƒÙ„", "Ø¥Ø´ÙƒÙ„", "ichkeul"] },
                    { questionText: "Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„ÙˆØ·Ù†ÙŠ ÙÙŠ ØªÙˆÙ†Ø³ Ø§Ù„Ø¹Ø§ØµÙ…Ø©ØŸ", displayAnswer: "Ù…Ù„Ø¹Ø¨ Ø­Ù…Ø§Ø¯ÙŠ Ø§Ù„Ø¹Ù‚Ø±Ø¨ÙŠ", correctAnswers: ["Ù…Ù„Ø¹Ø¨ Ø­Ù…Ø§Ø¯ÙŠ Ø§Ù„Ø¹Ù‚Ø±Ø¨ÙŠ", "Ù…Ù„Ø¹Ø¨ Ø±Ø§Ø¯Ø³", "Ø±Ø§Ø¯Ø³", "hamadi agerbi"] },
                    { questionText: "ÙÙŠ Ø£ÙŠ ÙˆÙ„Ø§ÙŠØ© ØªÙˆÙ†Ø³ÙŠØ© ØªÙˆØ¬Ø¯ Ù…Ø¯ÙŠÙ†Ø© Ø¯Ù‚Ø© Ø§Ù„Ø£Ø«Ø±ÙŠØ©ØŸ", displayAnswer: "Ø¨Ø§Ø¬Ø©", correctAnswers: ["Ø¨Ø§Ø¬Ø©", "beja"] }
                ]
            }
        ];
        
        // ğŸ” Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ (New normalization function from user)
        function normalize(text) {
            return text
                .toLowerCase()
                .replace(/\s+/g, '')
                .replace(/Ø£|Ø¥|Ø¢/g, 'Ø§')
                .replace(/Ù‰/g, 'ÙŠ')
                .replace(/Ø©/g, 'Ù‡')
                .replace(/Ø¤/g, 'Ùˆ')
                .replace(/Ø¦/g, 'ÙŠ')
                .replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, ''); // Keep Arabic and English alphanumeric
        }

        // ğŸ” Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø¨ÙŠÙ† ÙƒÙ„Ù…ØªÙŠÙ† (New similarity function from user)
        function similarity(a, b) {
            a = normalize(a);
            b = normalize(b);
            let matches = 0;
            const len = Math.max(a.length, b.length);
            // Handle case where one string is empty after normalization
            if (len === 0) return 1; 

            for (let i = 0; i < len; i++) {
                if (a[i] === b[i]) matches++;
            }
            return matches / len;
        }

        // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (New correctness check function from user)
        function isCorrectAnswer(playerAnswer, acceptedAnswers) {
            // Ensure playerAnswer is normalized before passing to similarity
            const normalizedPlayerAnswer = normalize(playerAnswer);
            return acceptedAnswers.some(ans => similarity(normalizedPlayerAnswer, ans) >= 0.8);
        }

        // Multi-select quiz categories logic
        let selectedQuizIndices = []; // Stores indices of selected CATEGORIES
        // Defensive check for elements - getElementById returns null if not found
        const quizCategoryInput = document.getElementById('quiz-category-input');
        const quizCategoryDropdown = document.getElementById('quiz-category-dropdown');
        const selectedCategoriesTags = document.getElementById('selected-categories-tags');
        const hostNicknameInput = document.getElementById('host-nickname-input'); // Host nickname input
        const totalQuestionsPerGameSelect = document.getElementById('total-questions-per-game-select'); // Total questions select

        // Function to populate and manage the multi-select dropdown
        // This now lists the category and an example question from it for clarity
        function setupQuizCategorySelection() {
            if (!quizCategoryDropdown) {
                console.error("Error: quizCategoryDropdown element not found.");
                return;
            }
            quizCategoryDropdown.innerHTML = ''; // Clear previous options
            quizzes.forEach((quiz, index) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = index; // The value is the index of the category
                checkbox.className = 'ml-2'; // Tailwind spacing

                // Check if this category is already selected
                checkbox.checked = selectedQuizIndices.includes(index);

                label.appendChild(checkbox);
                // Display category name only
                const displayText = quiz.category;  
                label.appendChild(document.createTextNode(displayText));
                quizCategoryDropdown.appendChild(label);

                checkbox.addEventListener('change', (event) => {
                    const categoryIndex = parseInt(event.target.value);
                    if (event.target.checked) {
                        if (!selectedQuizIndices.includes(categoryIndex)) {
                            selectedQuizIndices.push(categoryIndex);
                        }
                    } else {
                        selectedQuizIndices = selectedQuizIndices.filter(i => i !== categoryIndex);
                    }
                    updateSelectedCategoriesTags();
                });
            });
            updateSelectedCategoriesTags(); // Initial render of tags
        }

        // Function to update the displayed tags for selected categories
        function updateSelectedCategoriesTags() {
            if (!selectedCategoriesTags) {
                console.error("Error: selectedCategoriesTags element not found.");
                return;
            }
            selectedCategoriesTags.innerHTML = '';
            selectedQuizIndices.forEach(index => {
                const quiz = quizzes[index]; // This is a category object
                if (quiz) {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = quiz.category; // Display just the category name in the tag
                    
                    const removeBtn = document.createElement('span');
                    removeBtn.className = 'tag-remove';
                    removeBtn.textContent = 'x';
                    removeBtn.onclick = () => {
                        selectedQuizIndices = selectedQuizIndices.filter(i => i !== index);
                        setupQuizCategorySelection(); // Re-render dropdown and tags
                    };
                    tag.appendChild(removeBtn);
                    selectedCategoriesTags.appendChild(tag);
                }
            });
            // Update input placeholder based on selection
            if (quizCategoryInput) {
                if (selectedQuizIndices.length === 0) {
                    quizCategoryInput.placeholder = "Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø§Øª...";
                } else {
                    quizCategoryInput.placeholder = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selectedQuizIndices.length} ÙØ¦Ø©`;
                }
            }
        }
        
        // Add event listeners only if elements exist
        if (quizCategoryInput) {
            // Toggle dropdown visibility
            quizCategoryInput.addEventListener('click', () => {
                if (quizCategoryDropdown) {
                    quizCategoryDropdown.classList.toggle('hidden');
                }
            });
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', (event) => {
            // Ensure elements exist before checking contains
            const clickedInsideInput = quizCategoryInput && quizCategoryInput.contains(event.target);
            const clickedInsideDropdown = quizCategoryDropdown && quizCategoryDropdown.contains(event.target);
            const clickedInsideTags = selectedCategoriesTags && selectedCategoriesTags.contains(event.target); // Also check tags

            if (quizCategoryDropdown && !clickedInsideInput && !clickedInsideDropdown && !clickedInsideTags) {
                quizCategoryDropdown.classList.add('hidden');
            }
        });


        // --- DOM Elements (Get references to HTML elements) ---
        // Defensive checks for all DOM elements to catch missing ones early
        const loadingOverlay = document.getElementById('loading-overlay');
        const roleSelectionScreen = document.getElementById('role-selection-screen');
        const hostSetupScreen = document.getElementById('host-setup-screen');
        const waitingRoomScreen = document.getElementById('waiting-room-screen');
        const joinGameScreen = document.getElementById('join-game-screen');
        const gamePlayScreen = document.getElementById('game-play-screen');
        const questionResultsScreen = document.getElementById('question-results-screen');  
        const gameEndScreen = document.getElementById('game-end-screen');

        const createHostButton = document.getElementById('create-host-button');
        const joinPlayerButton = document.getElementById('join-player-button');
        const timeLimitSelect = document.getElementById('time-limit-select');
        const createGameButton = document.getElementById('create-game-button');
        const gameLinkDisplay = document.getElementById('game-link-display');  
        const qrcodeDiv = document.getElementById('qrcode');  
        const qrcodeFallbackMessage = document.getElementById('qrcode-fallback-message');  
        const copyLinkButton = document.getElementById('copy-link-button');

        const joinedPlayersList = document.getElementById('joined-players-list');
        const startGameButton = document.getElementById('start-game-button');  
        const gameCodeInput = document.getElementById('game-code-input');
        const playerNicknameInput = document.getElementById('player-nickname-input');
        const joinRoomButton = document.getElementById('join-room-button');
        const gameTimerDisplay = document.getElementById('game-timer');
        const playerScoreDisplay = document.getElementById('player-score');
        const gameCategoryDisplay = document.getElementById('game-category');
        const gameQuestionDisplay = document.getElementById('game-question');  
        const pointsButtonGroup = document.getElementById('points-button-group');  
        const gameGuessInput = document.getElementById('game-guess-input');
        const submitAnswerButton = document.getElementById('submit-answer-button');  
        const playerCorrectGuessesList = document.getElementById('player-correct-guesses-list');
        const sharedRoundGuessesList = document.getElementById('shared-round-guesses-list');  
        const endQuestionEarlyButton = document.getElementById('end-question-early-button');  

        const resultsCategory = document.getElementById('results-category');
        const resultsQuestion = document.getElementById('results-question');  
        const roundCorrectAnswersList = document.getElementById('round-correct-answers-list');  
        const questionPlayerScoresList = document.getElementById('question-player-scores-list');  
        const questionResultsHostControls = document.getElementById('question-results-host-controls');  
        const nextQuestionButton = document.getElementById('next-question-button');  
        const endGameFinalButton = document.getElementById('end-game-final-button');

        const gameCountdownScreen = document.getElementById('game-countdown-screen');  
        const countdownTimerDisplay = document.getElementById('countdown-timer-display');  
        const questionCounterDisplay = document.getElementById('question-counter');  

        const hostSubmissionStatusList = document.getElementById('host-submission-status-list');  
        const hostGameplayControls = document.getElementById('host-gameplay-controls');  


        const endTitle = document.getElementById('end-title');
        const endMessage = document.getElementById('end-message');
        const finalScoresList = document.getElementById('final-scores-list');
        const playAgainButton = document.getElementById('play-again-button');
        const customMessageBox = document.getElementById('custom-message-box');
        const customMessageTitle = document.getElementById('custom-message-title');
        const customMessageContent = document.getElementById('custom-message-content');
        const customMessageCloseButton = document.getElementById('custom-message-close-button');

        // Initialize Tone.js synth for sound effects
        const synth = new Tone.Synth().toDestination();
        
        // Function to play a simple sound effect
        function playSoundEffect() {
            // Only play if Tone.js is ready (user interaction has occurred)
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            synth.triggerAttackRelease("C5", "8n"); // Play a C5 note for an 8th note duration
        }

        // Initial check for all important DOM elements
        document.addEventListener('DOMContentLoaded', () => {
            const requiredElements = {
                'loadingOverlay': loadingOverlay,
                'roleSelectionScreen': roleSelectionScreen,
                'createHostButton': createHostButton,
                'joinPlayerButton': joinPlayerButton,
                'gameLinkDisplay': gameLinkDisplay,
                'qrcodeDiv': qrcodeDiv,
                'copyLinkButton': copyLinkButton,
                'customMessageBox': customMessageBox,
                'quizCategoryInput': quizCategoryInput,
                'quizCategoryDropdown': quizCategoryDropdown,
                'selectedCategoriesTags': selectedCategoriesTags,
                'hostNicknameInput': hostNicknameInput,
                'pointsButtonGroup': pointsButtonGroup, // Check the new group
                'gameGuessInput': gameGuessInput,
                'submitAnswerButton': submitAnswerButton,
                'endQuestionEarlyButton': endQuestionEarlyButton,
                'questionResultsScreen': questionResultsScreen,
                'questionPlayerScoresList': questionPlayerScoresList,
                'nextQuestionButton': nextQuestionButton,
                'endGameFinalButton': endGameFinalButton,
                'gameCountdownScreen': gameCountdownScreen,  
                'countdownTimerDisplay': countdownTimerDisplay,
                'totalQuestionsPerGameSelect': totalQuestionsPerGameSelect,
                'questionCounterDisplay': questionCounterDisplay,
                'hostSubmissionStatusList': hostSubmissionStatusList,  
                'hostGameplayControls': hostGameplayControls  
            };

            for (const id in requiredElements) {
                if (!requiredElements[id]) {
                    console.error(`CRITICAL ERROR: Element with ID '${id}' not found in the DOM. Please check your HTML.`);
                    // Display a persistent error message to the user if a critical element is missing
                    document.body.innerHTML = `
                        <div style="text-align: center; color: red; font-size: 1.5em; margin-top: 50px;">
                            Ø®Ø·Ø£ ÙØ§Ø¯Ø­: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒÙˆÙ†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¨Ù„Ø§Øº Ù…Ø·ÙˆØ± Ø§Ù„Ù„Ø¹Ø¨Ø©.
                            <br>Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ù…ÙÙ‚ÙˆØ¯: ${id}
                        </div>
                    `;
                    // Prevent further script execution if a critical element is missing
                    throw new Error(`Element ${id} not found.`);
                }
            }
            // Populate points buttons (1-20)
            populatePointsButtons();
            // If all critical elements are found, proceed with Firebase init
            initializeFirebase();
        });

        // Function to populate and manage the points buttons (1-20)
        function populatePointsButtons() {
            if (!pointsButtonGroup) {
                console.error("Error: pointsButtonGroup element not found for population.");
                return;
            }
            pointsButtonGroup.innerHTML = ''; // Clear existing buttons
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.type = 'button'; // Prevent form submission
                button.className = 'points-button';
                button.textContent = i;
                button.setAttribute('data-points', i); // Store points value in data attribute

                // Check if this point value has been used by the current user
                const isDisabled = userUsedPointsBets.includes(i);
                if (isDisabled) {
                    button.disabled = true;
                    button.classList.add('used'); // Add a specific class for used buttons
                }

                if (i === selectedPointsBet) {
                    button.classList.add('selected'); // Select default 1
                }

                button.addEventListener('click', (event) => {
                    // Prevent selection of disabled buttons
                    if (event.target.disabled) return;  

                    // Unselect previous button
                    const currentSelected = pointsButtonGroup.querySelector('.points-button.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                    }
                    // Select new button
                    event.target.classList.add('selected');
                    selectedPointsBet = parseInt(event.target.getAttribute('data-points'));
                    console.log("Selected points bet:", selectedPointsBet);
                });
                pointsButtonGroup.appendChild(button);
            }
        }

        // --- Firebase Initialization ---
        // This function initializes Firebase and handles user authentication.
        async function initializeFirebase() {
            showLoading(); // Show loading overlay
            try {
                // *** FIREBASE CONFIGURATION (YOUR PROJECT'S SETTINGS) ***
                // This is the configuration you provided for your Firebase project 'ka3boura-dbcf5'.
                const firebaseConfig = {
                  apiKey: "AIzaSyCwdZjTwrnjKZU_AilP5_GZJeEuUZjVcUY",
                  authDomain: "ka3boura-dbcf5.firebaseapp.com",
                  projectId: "ka3boura-dbcf5",
                  storageBucket: "ka3boura-dbcf5.firebasestorage.app",
                  messagingSenderId: "1051115240747",
                  appId: "1:1051115240747:web:694751eef3173327f5596e",
                  measurementId: "G-9413DFK5DF"
                };
                // ***********************************************************************************

                // Log the Firebase config to console to help debugging if there's an issue
                console.log("Using Firebase Config:", firebaseConfig);

                // IMPORTANT: Assign to the GLOBAL appId variable declared at the top.
                appId = firebaseConfig.projectId;
                console.log("Derived App ID for Firestore path (Global):", appId);


                app = firebase.initializeApp(firebaseConfig); // Initialize Firebase app
                db = firebase.firestore(app); // Get Firestore instance
                auth = firebase.auth(app); // Get Auth instance

                // Sign in anonymously for game functionality.
                await auth.signInAnonymously();

                // Listen for authentication state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid; // Store the authenticated user ID
                        console.log("Authenticated with userId:", userId);
                        hideLoading(); // Hide loading overlay

                        // Check URL for existing gameId to auto-join if provided (e.g., from QR code link)
                        const urlParams = new URLSearchParams(window.location.search);
                        const idFromUrl = urlParams.get('gameId');
                        if (idFromUrl) {
                            gameId = idFromUrl;
                            // If gameId is in URL, pre-fill the input field
                            if (gameCodeInput) gameCodeInput.value = gameId;

                            playerNicknameInput.value = localStorage.getItem('playerNickname') || ''; // Load saved nickname from local storage

                            // If nickname is available, prompt user to join directly. Otherwise, show join screen for manual input.
                            if (!playerNicknameInput.value) {
                                showScreen(joinGameScreen); // Show join screen for nickname input
                                showCustomMessageBox("Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø©", `Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø±Ù…Ø² ${gameId}.`);
                                customMessageCloseButton.onclick = () => {
                                    hideCustomMessageBox();
                                    // User needs to fill nickname and click join manually
                                };
                            } else {
                                showCustomMessageBox("Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø©", `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø±Ù…Ø² ${gameId} Ø¨Ø§Ø³Ù… ${playerNicknameInput.value}ØŸ`);
                                customMessageCloseButton.onclick = () => {
                                    hideCustomMessageBox();
                                    joinGame(gameId, playerNicknameInput.value); // Auto-join with saved nickname
                                };
                            }
                        } else {
                            showScreen(roleSelectionScreen); // Show role selection if no gameId in URL
                        }
                    } else {
                        console.log("No user signed in.");
                        hideLoading(); // Hide loading even if no user
                        showScreen(roleSelectionScreen); // Always show role selection if not authenticated
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error Details:", error); // Log the full error object for detailed debugging
                showCustomMessageBox("Ø®Ø·Ø£", `ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†. Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${error.message}`);
                hideLoading();
            }
        }

        // --- UI Management Functions ---
        // Shows the loading spinner overlay
        function showLoading() {
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }

        // Hides the loading spinner overlay
        function hideLoading() {
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }

        // Hides all game screens and shows the specified one
        function showScreen(screenElement) {
            console.log("Attempting to show screen:", screenElement ? screenElement.id : "undefined/null screenElement");

            // Ensure screenElement is a valid DOM element
            if (!screenElement || !(screenElement instanceof HTMLElement)) {
                console.error("Invalid screenElement provided to showScreen:", screenElement);
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶", "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¹Ù†ØµØ± Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± ØµØ§Ù„Ø­).");
                return; // Prevent further execution that might blank the screen
            }

            // Hide all potential screens
            // It's safer to ensure these elements exist before trying to modify their classes
            const allScreens = [
                roleSelectionScreen, hostSetupScreen, waitingRoomScreen,
                joinGameScreen, gamePlayScreen, questionResultsScreen, gameEndScreen, gameCountdownScreen // Include countdown screen
            ];
            allScreens.forEach(screen => {
                if (screen && screen instanceof HTMLElement) { // Defensive check
                    screen.classList.add('hidden');
                }
            });
            
            // Hide the custom message box if it's currently showing
            if (customMessageBox) {
                customMessageBox.classList.add('hidden', 'opacity-0');
            }

            // Then show the target screen
            screenElement.classList.remove('hidden');
            // If the screen is supposed to be visible, ensure it's not also hidden by the message box logic
            if (screenElement !== customMessageBox) {
                screenElement.classList.remove('flex', 'opacity-100'); // Ensure it doesn't get message box styles
            }
        }

        // Displays a custom message box (replacement for alert/confirm)
        function showCustomMessageBox(title, content) {
            // Defensive checks for message box elements
            if (!customMessageBox || !customMessageTitle || !customMessageContent) {
                console.error("Error: Custom message box elements not found. Cannot display message.");
                // Fallback to native alert if custom message box is critical and missing
                alert(`Ø®Ø·Ø£: ${title}\n${content}`);
                return;
            }
            customMessageTitle.textContent = title;
            customMessageContent.textContent = content;
            customMessageBox.classList.remove('hidden', 'opacity-0');
            customMessageBox.classList.add('flex', 'opacity-100'); // Add flex and opacity for fade-in
        }

        // Hides the custom message box
        function hideCustomMessageBox() {
            if (customMessageBox) {
                customMessageBox.classList.remove('flex', 'opacity-100');
                customMessageBox.classList.add('hidden', 'opacity-0'); // Remove flex and opacity for fade-out
            }
        }

        // --- Game Helper Functions ---
        // Generates a random 3-digit numeric game code and ensures its uniqueness
        async function generateUniqueGameCode() {
            let newGameId;
            let isUnique = false;
            let attempts = 0;
            const MAX_ATTEMPTS = 10; // Limit attempts to find a unique ID

            while (!isUnique && attempts < MAX_ATTEMPTS) {
                // Generate a random 3-digit number (100-999)
                newGameId = String(Math.floor(100 + Math.random() * 900));
                
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(newGameId);
                const docSnap = await gameRef.get();
                if (!docSnap.exists) {
                    isUnique = true;
                } else {
                    console.warn(`Generated ID ${newGameId} is already in use. Retrying...`);
                    attempts++;
                }
            }

            if (!isUnique) {
                throw new Error("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² ØºØ±ÙØ© ÙØ±ÙŠØ¯ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            }
            return newGameId;
        }

        // Normalizes a string (lowercase, trims whitespace) for consistent comparison
        // This function is no longer used for answer checking directly but might be useful elsewhere
        function normalizeString(str) {
            return str.toLowerCase().trim();
        }

        // --- Host Specific Functions ---
        // Creates a new game instance in Firestore
        async function createGame() {
            showLoading(); // Show loading spinner
            try {
                const hostNickname = hostNicknameInput.value.trim();
                if (!hostNickname) {
                    showCustomMessageBox("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±.");
                    hideLoading();
                    return;
                }
                if (selectedQuizIndices.length === 0) {
                    showCustomMessageBox("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø³Ø¦Ù„Ø©.");
                    hideLoading();
                    return;
                }

                gameId = await generateUniqueGameCode(); // Await the unique ID generation

                isHost = true; // Set current user as host
                userNickname = hostNickname; // Set host's nickname
                localStorage.setItem('hostNickname', hostNickname); // Save host nickname locally
                const timeLimit = parseInt(timeLimitSelect.value); // Get selected time limit
                const totalQuestions = parseInt(totalQuestionsPerGameSelect.value); // Get total questions for game

                // Prepare the quiz order for the game
                // Flatten all questions from selected categories into a single array
                let allPossibleQuestions = [];
                selectedQuizIndices.forEach(catIndex => {
                    const category = quizzes[catIndex];
                    if (category && category.questions) {
                        category.questions.forEach(q => {
                            allPossibleQuestions.push({
                                category: category.category,
                                question: q.questionText,
                                displayAnswer: q.displayAnswer, // Include displayAnswer
                                correctAnswers: q.correctAnswers.map(normalize) // *** Using the NEW normalize function here ***
                            });
                        });
                    }
                });

                // Shuffle the *flattened* array of all possible questions
                for (let i = allPossibleQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allPossibleQuestions[i], allPossibleQuestions[j]] = [allPossibleQuestions[j], allPossibleQuestions[i]];
                }
                
                // Select only the required number of questions for this game
                const quizSetForGame = allPossibleQuestions.slice(0, totalQuestions);

                if (quizSetForGame.length === 0) {
                    showCustomMessageBox("Ø®Ø·Ø£", "Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ©.");
                    hideLoading();
                    return;
                }


                // Reference to the new game document in Firestore
                // Path: artifacts/{appId}/public/data/games/{gameId}
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                console.log("Attempting to create game at path:", gameRef.path); // Log path
                await gameRef.set({ // Create the game document
                    hostId: userId, // Store host's userId
                    gamePhase: 'lobby', // Initial phase
                    quizSet: quizSetForGame, // Array of ALL questions for this game
                    currentQuestionIndexInGame: 0, // Index of the current question in the quizSet (0-indexed)
                    currentCategory: '', // Will be set when question starts
                    currentQuestionText: '', // Will be set when question starts
                    currentCorrectAnswers: [], // Will be set when question starts (for fuzzy matching)
                    currentDisplayAnswer: '', // The primary correct answer for display
                    currentQuestionGuessedAnswers: [], // Guesses for the current question (from all players)
                    questionStartTime: null, // Timestamp when current question started
                    timeLimitPerQuestion: timeLimit, // Renamed for clarity
                    currentTime: timeLimit, // Initialize current time with full time limit
                    countdownStartTime: null, // For countdown before question
                    countdownDuration: 5, // Duration of countdown
                    lastUpdate: Date.now() // Timestamp for host's last update (for real-time timer sync)
                });

                // Add host as a player in the game's subcollection (Host can also play)
                // Path: artifacts/{appId}/public/data/games/{gameId}/players/{userId}
                const playerRef = gameRef.collection('players').doc(userId);
                console.log("Attempting to add host player at path:", playerRef.path); // Log path
                await playerRef.set({
                    nickname: hostNickname, // Use host's provided nickname
                    score: 0, // Overall score
                    joinedAt: Date.now(),
                    playerSubmittedAnswer: '', // Answer submitted for current question
                    playerSelectedPoints: 0, // Points selected for current question
                    playerScoreChange: 0, // Points change for current question
                    hasSubmittedAnswer: false, // Flag if player submitted for current question
                    usedPointsBets: [] // Initialize used points for this player
                });
                // Ensure userUsedPointsBets for host is also initialized locally
                userUsedPointsBets = [];

                console.log("Game created with ID:", gameId);
                // Display the direct link to the game room
                const gameRoomLink = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                if (gameLinkDisplay) {
                    gameLinkDisplay.textContent = gameRoomLink; // Display the full link
                    gameLinkDisplay.href = gameRoomLink; // Make it clickable (if needed, though copy is main)
                }
                
                // Try to generate QR code, with fallback if QRCode library is not defined
                if (qrcodeDiv) qrcodeDiv.innerHTML = ''; // Clear previous content
                if (qrcodeFallbackMessage) qrcodeFallbackMessage.textContent = ''; // Clear fallback message
                try {
                    // Only attempt to use QRCode if it's confirmed to be loaded
                    if (typeof QRCode !== 'undefined' && QRCode && qrcodeDiv) {  
                        new QRCode(qrcodeDiv, {
                            text: gameRoomLink,
                            width: 128,
                            height: 128,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        console.log("QR Code generated successfully.");
                    } else {
                        throw new Error("QRCode library not available or qrcodeDiv missing (fallback).");
                    }
                } catch (qrError) {
                    console.warn("Failed to generate QR Code:", qrError);
                    if (qrcodeFallbackMessage) {
                        qrcodeFallbackMessage.textContent = "ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² QR. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù….";
                    }
                    if (qrcodeDiv) { // Optionally style qrcodeDiv to show the message better
                        qrcodeDiv.style.minHeight = 'auto';
                        qrcodeDiv.style.border = '1px dashed #ddd';
                        qrcodeDiv.style.padding = '10px';
                    }
                }

                // Add an event listener to copy the link to clipboard
                if (copyLinkButton) {
                    copyLinkButton.onclick = () => {
                        // Use document.execCommand('copy') for better compatibility in iframes
                        const textArea = document.createElement("textarea");
                        textArea.value = gameRoomLink;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showCustomMessageBox("ØªÙ… Ø§Ù„Ù†Ø³Ø®!", "ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.");
                        } catch (err) {
                            console.error('Failed to copy text: ', err);
                            showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®", "ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.");
                        }
                        document.body.removeChild(textArea);
                    };
                }

                showScreen(waitingRoomScreen); // Show waiting room screen
                listenToGameChanges(); // Start listening to the game document for real-time updates
                listenToPlayers(); // Start listening to players joining the room
                if (startGameButton) startGameButton.classList.remove('hidden'); // Show start game button for host
            } catch (error) {
                console.error("Error creating game:", error);
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©", error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // Initiates the game start countdown (only once at the very beginning)
        async function initiateGameStartCountdown() {  
            showLoading();
            try {
                if (!gameId) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ø¹Ø¨Ø©.");
                if (!isHost) throw new Error("ÙÙ‚Ø· Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) throw new Error("Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

                const gameData = gameDoc.data();
                // Check if it's already past lobby (game has started or is in countdown)
                if (gameData.gamePhase !== 'lobby') {
                    console.log("Game already started or in countdown phase.");
                    hideLoading();
                    return;
                }

                // Update game phase to game_countdown and set countdown start time
                await gameRef.update({
                    gamePhase: 'game_countdown', // Phase for initial game countdown
                    countdownStartTime: Date.now(),
                    countdownDuration: 5 // 5 seconds countdown for game start
                });
                console.log("Initiated game start countdown.");

            } catch (error) {
                console.error("Error initiating game start countdown:", error);
                showCustomMessageBox("Ø®Ø·Ø£", error.message || "ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¹Ø¨Ø©.");
            } finally {
                hideLoading();
            }
        }


        // Actually starts the next question (after initial countdown or from results screen)
        async function startNextQuestion() {
            showLoading();
            try {
                if (!gameId) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ø¹Ø¨Ø©.");
                if (!isHost) throw new Error("ÙÙ‚Ø· Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠÙ…ÙƒÙ†Ù‡ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ."); // Clarified host role

                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const gameDoc = await gameRef.get();
                if (!gameDoc.exists) throw new Error("Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

                const gameData = gameDoc.data();
                const currentQuestionIndex = gameData.currentQuestionIndexInGame; // This is the index for the question we are starting NOW
                const quizSet = gameData.quizSet;

                if (currentQuestionIndex >= quizSet.length) {
                    // All questions played, end the game
                    await gameRef.update({ gamePhase: 'final_results' });
                    return;
                }

                const currentQuestion = quizSet[currentQuestionIndex]; // Get the question for THIS round

                await gameRef.update({
                    gamePhase: 'question_active',
                    currentQuestionIndexInGame: currentQuestionIndex + 1, // Advance for *next* potential question (for display X/Y)
                    currentCategory: currentQuestion.category,
                    currentQuestionText: currentQuestion.question,
                    currentCorrectAnswers: currentQuestion.correctAnswers, // Already normalized
                    currentDisplayAnswer: currentQuestion.displayAnswer, // Set display answer
                    currentQuestionGuessedAnswers: [], // Reset guessed answers for new question
                    questionStartTime: Date.now(), // New timestamp for question start
                    timeLimitPerQuestion: gameData.timeLimitPerQuestion, // Use stored time limit
                    currentTime: gameData.timeLimitPerQuestion, // Reset timer
                });

                // Crucially, reset players' per-question flags/data in their sub-documents
                const playersCollectionRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersDocs = await playersCollectionRef.get();
                const batch = db.batch();
                playersDocs.docs.forEach(playerDoc => {
                    const playerRef = playerDoc.ref;
                    batch.update(playerRef, {  
                        playerSubmittedAnswer: '',
                        playerSelectedPoints: 0,
                        playerScoreChange: 0,
                        hasSubmittedAnswer: false
                    });
                });
                await batch.commit();
                console.log("Reset player-specific question data for new question.");

                // Reset player's local UI for the new question
                if (gameGuessInput) {
                    gameGuessInput.value = ''; // Clear input field for ALL players
                }
                // Reset points button selection to default (1) and re-enable them
                selectedPointsBet = 1;
                populatePointsButtons(); // Re-render buttons to reset selection visually and enable
                currentQuestionSoundPlayed = false; // Reset sound flag for new question

                console.log(`Starting question ${currentQuestionIndex + 1}: ${currentQuestion.category} - Question: ${currentQuestion.question}`);

            } catch (error) {
                console.error("Error starting next question:", error);
                showCustomMessageBox("Ø®Ø·Ø£", error.message || "ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.");
            } finally {
                hideLoading();
            }
        }

        // --- Host Specific Functions ---
        // Allows host to end the current question early
        async function endQuestionEarly() {  
            if (!isHost || !gameId) return;  

            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                await gameRef.update({
                    gamePhase: 'question_results', // Move to showing question results
                    currentTime: 0 // Ensure timer is at zero
                });
                console.log("Host ended question early.");
            } catch (error) {
                console.error("Error ending question early:", error);
                showCustomMessageBox("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¨ÙƒØ±Ø§Ù‹.");
            } finally {
                hideLoading();
            }
        }

        // Ends the entire game
        async function endGame() {
            if (!isHost || !gameId) return;
            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                await gameRef.update({
                    gamePhase: 'final_results' // Move to final results
                });
                console.log("Host ended the entire game.");
            } catch (error) {
                console.error("Error ending game:", error);
                showCustomMessageBox("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");
            } finally {
                hideLoading();
            }
        }

        // Function to reconcile scores for all players after a question ends (called by host)
        async function reconcileQuestionScores() {
            if (!isHost || !gameId) return; // Only host performs this
            console.log("Reconciling scores for the ended question...");
            // Ensure this runs only once per question results phase
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            const gameDoc = await gameRef.get();
            if (!gameDoc.exists || gameDoc.data().scoresReconciledForCurrentQuestion) {
                console.log("Scores already reconciled for this question, or game data missing.");
                return; // Prevent double reconciliation if listener triggers again
            }

            showLoading();
            try {
                const playersCollectionRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersDocs = await playersCollectionRef.get();
                
                const batch = db.batch();
                playersDocs.docs.forEach(playerDoc => {
                    const playerRef = playerDoc.ref;
                    const playerData = playerDoc.data();
                    
                    if (playerData.hasSubmittedAnswer && playerData.playerScoreChange !== undefined) {
                        const newScore = (playerData.score || 0) + (playerData.playerScoreChange);
                        batch.update(playerRef, {
                            score: newScore,
                            playerSubmittedAnswer: '', // Clear previous answer
                            playerSelectedPoints: 0,
                            playerScoreChange: 0,
                            hasSubmittedAnswer: false
                        });
                    } else {
                        // If player didn't submit an answer, just reset their flags
                        batch.update(playerRef, {
                            playerSubmittedAnswer: '',
                            playerSelectedPoints: 0,
                            playerScoreChange: 0,
                            hasSubmittedAnswer: false
                        });
                    }
                });
                // Mark scores as reconciled for this question in the main game document
                batch.update(gameRef, { scoresReconciledForCurrentQuestion: true });
                await batch.commit();
                console.log("Scores reconciled and player flags reset for the question.");
            } catch (error) {
                console.error("Error reconciling scores:", error);
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·", error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.");
            } finally {
                hideLoading();
            }
        }


        // --- Player Specific Functions ---
        // Allows a player to join an existing game
        async function joinGame(code, nickname) {
            showLoading(); // Show loading spinner
            try {
                if (!code || !nickname) {
                    throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±."); // Input validation
                }

                // Reference to the game document
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(code);
                console.log("Attempting to join game at path:", gameRef.path); // Log path
                const gameDoc = await gameRef.get(); // Get game document

                if (!gameDoc.exists) {
                    showCustomMessageBox("Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "Ø±Ù…Ø² Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
                    hideLoading();
                    showScreen(roleSelectionScreen); // Redirect to role selection
                    return;
                }

                const gameData = gameDoc.data();
                if (gameData.gamePhase === 'final_results') {
                    showCustomMessageBox("Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª", "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª Ø¨Ø§Ù„ÙØ¹Ù„.");
                    hideLoading();
                    showScreen(roleSelectionScreen); // Redirect to role selection
                    return;
                }

                gameId = code; // Set current game ID
                isHost = (gameData.hostId === userId); // Determine if current user is the host
                userNickname = nickname; // Set current user's nickname
                localStorage.setItem('playerNickname', nickname); // Save nickname locally for future use

                // Add player to the game's subcollection
                const playerRef = gameRef.collection('players').doc(userId);
                console.log("Attempting to add player at path:", playerRef.path); // Log path
                await playerRef.set({ // Use set with merge to avoid overwriting if player rejoins
                    nickname: nickname,
                    score: 0, // Overall score
                    joinedAt: Date.now(),
                    playerSubmittedAnswer: '',
                    playerSelectedPoints: 0,
                    playerScoreChange: 0,
                    hasSubmittedAnswer: false,
                    usedPointsBets: [] // Initialize used points for this player
                }, { merge: true });
                // If player is joining, reset their local used points
                userUsedPointsBets = [];


                console.log("Joined game:", gameId);
                // Update URL to include gameId for easy sharing/rejoining
                if (!window.location.search.includes(`gameId=${gameId}`)) {
                    const newUrl = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                    window.history.pushState({ path: newUrl }, '', newUrl); // Change URL without reloading
                }

                showScreen(waitingRoomScreen); // Show waiting room screen
                if (document.getElementById('waiting-room-title')) document.getElementById('waiting-room-title').textContent = `ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...`; // Player-specific waiting message
                
                // For players, the game link display will just show the game ID (no QR)
                if (gameLinkDisplay) gameLinkDisplay.textContent = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${gameId}`;
                
                // Hide QR code and copy button for players
                if (qrcodeDiv) qrcodeDiv.innerHTML = ''; // Clear QR code
                if (qrcodeFallbackMessage) qrcodeFallbackMessage.textContent = ''; // Clear fallback message
                if (copyLinkButton) copyLinkButton.classList.add('hidden'); // Hide copy button
                
                listenToGameChanges(); // Start listening to game document
                listenToPlayers(); // Start listening to players in the room
            } catch (error) {
                console.error("Error joining game:", error);
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…", error.message || "ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // Submits a player's guess to Firestore
        async function submitGuess() {
            // Only allow submission if gameId is set and we are on the game play screen.
            if (!gameId || (gamePlayScreen && gamePlayScreen.classList.contains('hidden'))) {
                 return; // Do nothing if not in active game play
            }
            if (!gameGuessInput || !pointsButtonGroup || !submitAnswerButton) { // Check point buttons group
                console.error("Error: Game input elements not found.");
                return;
            }
            // If already submitted, prevent re-submission (client-side check for immediate feedback)
            if (gameGuessInput.disabled) {  
                showCustomMessageBox("ØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", "Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„.");
                return;
            }

            // Get player's guess without normalizing it here, pass it as is to isCorrectAnswer
            const guess = gameGuessInput.value; 
            const pointsBet = selectedPointsBet; // Get selected points from global variable

            if (guess.trim() === '') {
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
                return;
            }
            if (isNaN(pointsBet) || pointsBet < 1 || pointsBet > 20) {
                 showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 20.");
                 return;
            }

            showLoading(); // Show loading spinner
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const playerRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId);

                // Use a Firestore transaction to ensure atomic updates
                await db.runTransaction(async (transaction) => {
                    const gameDoc = await transaction.get(gameRef); // Get current game data
                    const playerDoc = await transaction.get(playerRef); // Get current player data

                    if (!gameDoc.exists || !playerDoc.exists) {
                        throw "Game or player data not found.";
                    }

                    const gameData = gameDoc.data();
                    const playerData = playerDoc.data();

                    const currentCorrectAnswers = gameData.currentCorrectAnswers || []; // All correct answers for the current question (normalized)
                    const hasSubmittedAnswer = playerData.hasSubmittedAnswer || false;
                    const playerUsedPointsBets = playerData.usedPointsBets || [];

                    if (hasSubmittedAnswer) {
                        console.log("Player already submitted answer for this question (transaction check).");
                        throw new Error("Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„."); // Throw specific error to be caught below
                    }
                    if (playerUsedPointsBets.includes(pointsBet)) {
                         console.log("Player already used this point value in this game (transaction check).");
                         throw new Error(`Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‚ÙŠÙ…Ø© ${pointsBet} Ù†Ù‚Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙŠÙ…Ø© Ø£Ø®Ø±Ù‰.`); // Throw specific error
                    }


                    let scoreChange = 0; // Points change for this question

                    // Check if guess is correct using the new fuzzy matching function
                    let isCorrect = isCorrectAnswer(guess, currentCorrectAnswers);
                    
                    if (isCorrect) {
                        scoreChange = pointsBet;
                        // Add this correct guess to the game's shared list of guesses for this question
                        transaction.update(gameRef, {
                            currentQuestionGuessedAnswers: firebase.firestore.FieldValue.arrayUnion(guess) // Use player's original guess for display in shared list
                        });
                        console.log("Correct guess:", guess, "Points:", pointsBet);
                    } else {
                        scoreChange = -pointsBet;
                        console.log("Incorrect guess:", guess, "Points lost:", pointsBet);
                    }

                    // Update player's per-question data (score itself is updated later by reconcile)
                    transaction.update(playerRef, {
                        playerSubmittedAnswer: guess, // Store the actual guess for display in results
                        playerSelectedPoints: pointsBet,
                        playerScoreChange: scoreChange, // Store the calculated change
                        hasSubmittedAnswer: true, // Mark as submitted
                        usedPointsBets: firebase.firestore.FieldValue.arrayUnion(pointsBet) // Add used points to player's array
                    });
                });

                // Disable input elements for the player after successful submission
                // This is now handled by listenToPlayers when playerDoc updates, making it reactive.
                // But keeping direct disable here for immediate feedback is fine.
                if (gameGuessInput) gameGuessInput.disabled = true;
                if (pointsButtonGroup) { // Disable all point buttons
                    Array.from(pointsButtonGroup.children).forEach(btn => btn.disabled = true);
                }
                if (submitAnswerButton) submitAnswerButton.disabled = true;

            } catch (error) {
                console.error("Error submitting guess:", error);
                // Catch specific errors thrown from transaction
                if (error.message.includes("Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„")) {
                     showCustomMessageBox("ØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", error.message);
                } else if (error.message.includes("Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª Ù‚ÙŠÙ…Ø©")) {  
                     showCustomMessageBox("Ù†Ù‚Ø§Ø· Ù…Ø³ØªØ®Ø¯Ù…Ø©", error.message); // Show the specific message
                }
                else {
                    showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.");
                }
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // --- Real-time Listeners ---
        // Listens for changes to the main game document in Firestore
        function listenToGameChanges() {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe(); // Unsubscribe from previous listener if exists

            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            console.log("Listening to game changes at path:", gameRef.path); // Log path

            gameSnapshotUnsubscribe = gameRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const gameData = docSnap.data();
                    const gamePhase = gameData.gamePhase;

                    // Update Question Counter (e.g., "Ø§Ù„Ø³Ø¤Ø§Ù„ 1 / 15")
                    if (questionCounterDisplay) {
                        // currentQuestionIndexInGame is already incremented for the NEXT question to be displayed,
                        // so to show current question, we use currentQuestionIndexInGame.
                        const currentQNum = gameData.currentQuestionIndexInGame;  
                        const totalQs = gameData.quizSet ? gameData.quizSet.length : 0;
                        // Display (current number - 1) if not in countdown/lobby, otherwise 0
                        const displayQNum = gamePhase === 'game_countdown' || gamePhase === 'lobby' ? 0 : currentQNum;

                        if (totalQs > 0) {
                               questionCounterDisplay.textContent = `${displayQNum} / ${totalQs}`;
                        } else {
                               questionCounterDisplay.textContent = `-- / --`;
                        }
                    }

                    // Phase: Lobby (Waiting room)
                    if (gamePhase === 'lobby') {
                        showScreen(waitingRoomScreen);
                        // Host sees 'Start Game' (which initiates countdown for first question)
                        if (isHost) {
                            if (startGameButton) {
                                startGameButton.textContent = "Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰!";
                                startGameButton.onclick = initiateGameStartCountdown; // Correctly starts initial countdown
                                if (joinedPlayersList && joinedPlayersList.children.length >= 1) { // Host + 0 or more players (host counts as 1)
                                    startGameButton.classList.remove('hidden');
                                } else {
                                    startGameButton.classList.add('hidden');
                                }
                            }
                        } else {
                            if (startGameButton) startGameButton.classList.add('hidden'); // Players don't see this button
                        }
                    }
                    // Phase: Initial Game Countdown (only once at start of game)
                    else if (gamePhase === 'game_countdown') {  
                        showScreen(gameCountdownScreen); // Show the dedicated countdown screen
                        clearInterval(timerInterval); // Clear any existing timer
                        const countdownDuration = gameData.countdownDuration || 5;
                        const countdownStartTime = gameData.countdownStartTime;

                        timerInterval = setInterval(() => {
                            const elapsed = Math.floor((Date.now() - countdownStartTime) / 1000);
                            const remaining = countdownDuration - elapsed;
                            if (countdownTimerDisplay) countdownTimerDisplay.textContent = remaining > 0 ? remaining : 'Ø§Ù†Ø·Ù„Ù‚!';

                            if (remaining <= 0) {
                                clearInterval(timerInterval);
                                if (isHost) {
                                    // Host initiates the actual first question after countdown
                                    startNextQuestion();  
                                }
                            }
                        }, 1000);
                    }
                    // Phase: Question is active (Game Play)
                    else if (gamePhase === 'question_active') {
                        showScreen(gamePlayScreen);
                        if (gameCategoryDisplay) gameCategoryDisplay.textContent = gameData.currentCategory;
                        if (gameQuestionDisplay) gameQuestionDisplay.textContent = gameData.currentQuestionText; // Display current question text
                        
                        // Handle input state for current player (including host) based on their submission status
                        db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId).get().then(playerDoc => {
                            if (playerDoc.exists) { // Ensure player doc exists
                                const currentPlayerData = playerDoc.data();
                                if (!currentPlayerData.hasSubmittedAnswer) {
                                    // Player has not submitted, enable inputs
                                    if (gameGuessInput) gameGuessInput.disabled = false;
                                    populatePointsButtons(); // Re-populate buttons to enable/disable based on usedPointsBets
                                    if (submitAnswerButton) submitAnswerButton.disabled = false;
                                } else {  
                                    // Player has submitted, disable inputs
                                    if (gameGuessInput) gameGuessInput.disabled = true;
                                    if (pointsButtonGroup) Array.from(pointsButtonGroup.children).forEach(btn => btn.disabled = true);
                                    if (submitAnswerButton) submitAnswerButton.disabled = true;
                                }
                            } else { // If player doc somehow doesn't exist, disable all to prevent errors
                                if (gameGuessInput) gameGuessInput.disabled = true;
                                if (pointsButtonGroup) Array.from(pointsButtonGroup.children).forEach(btn => btn.disabled = true);
                                if (submitAnswerButton) submitAnswerButton.disabled = true;
                            }
                        }).catch(e => console.error("Error checking player submission status on game changes:", e));
                        
                        if (gameGuessInput) gameGuessInput.focus(); // Keep focus

                        // Show/hide "End Question Early" button and host status for host only during game play
                        if (isHost) {
                            if (hostGameplayControls) hostGameplayControls.classList.remove('hidden'); // Show host controls
                        } else {
                            if (hostGameplayControls) hostGameplayControls.classList.add('hidden'); // Hide host controls
                        }

                        // Host-specific timer logic: Host updates time in Firestore
                        if (isHost) {
                            clearInterval(timerInterval); // Clear any old timer
                            timerInterval = setInterval(async () => {
                                const now = Date.now();
                                // Calculate elapsed time since question started
                                const elapsed = Math.floor((now - gameData.questionStartTime) / 1000); // Use questionStartTime
                                const remainingTime = gameData.timeLimitPerQuestion - elapsed; // Use timeLimitPerQuestion
                                
                                if (remainingTime >= 0) {
                                    // Trigger sound effect when time is running out (e.g., last 5 seconds)
                                    if (remainingTime <= 5 && !currentQuestionSoundPlayed) {
                                        playSoundEffect();
                                        currentQuestionSoundPlayed = true; // Set flag to prevent repeated sounds
                                    }
                                    // Update Firestore with current time and last update timestamp
                                    await gameRef.update({ currentTime: remainingTime, lastUpdate: now });
                                    if (gameTimerDisplay) gameTimerDisplay.textContent = remainingTime; // Update timer display
                                } else {
                                    clearInterval(timerInterval); // Stop timer
                                    // If time runs out, move to question results phase and reconcile scores
                                    await gameRef.update({ gamePhase: 'question_results', currentTime: 0, scoresReconciledForCurrentQuestion: false }); // Reset reconciliation flag
                                    // Host also triggers score reconciliation here
                                    reconcileQuestionScores();  
                                }
                            }, 1000); // Update every second
                        } else {
                            // Player-specific timer logic: Players display time from host's update
                            const timeFromHost = gameData.currentTime;
                            if (gameTimerDisplay) gameTimerDisplay.textContent = timeFromHost;
                             // Trigger sound effect for players when time is running out (sync with host)
                            if (timeFromHost <= 5 && !currentQuestionSoundPlayed) {
                                playSoundEffect();
                                currentQuestionSoundPlayed = true; // Set flag
                            }
                            // Game status change to 'question_results' or 'final_results' will trigger screen change for players
                        }

                        // Update shared correct guesses list for the CURRENT QUESTION for all players
                        if (sharedRoundGuessesList) {
                            sharedRoundGuessesList.innerHTML = ''; // Clear existing list
                            // Populate with answers from gameData.currentQuestionGuessedAnswers
                            (gameData.currentQuestionGuessedAnswers || []).forEach(answer => {
                                const listItem = document.createElement('li');
                                listItem.textContent = answer;
                                listItem.classList.add('text-purple-700', 'font-semibold', 'opacity-0', 'animate-fade-in-up');
                                sharedRoundGuessesList.appendChild(listItem);
                            });
                        }
                        // IMPORTANT: Removed auto-advance logic if all correct answers are guessed.
                        // Now, it strictly waits for time or host to explicitly end the question.
                    }  
                    // Phase: Showing Question Results
                    else if (gamePhase === 'question_results') {
                        // If host, ensure scores were reconciled before displaying results
                        if (isHost && !gameData.scoresReconciledForCurrentQuestion) { // Only reconcile if not already done
                            reconcileQuestionScores();  
                        }
                        showScreen(questionResultsScreen); // Reusing questionResultsScreen
                        clearInterval(timerInterval); // Stop any timer
                        currentQuestionSoundPlayed = false; // Reset sound flag for the next question

                        if (resultsCategory) resultsCategory.textContent = gameData.currentCategory;
                        if (resultsQuestion) resultsQuestion.textContent = gameData.currentQuestionText; // Display current question in results
                        
                        // Display all correct answers for this specific question
                        if (roundCorrectAnswersList) {
                            roundCorrectAnswersList.innerHTML = '';
                            // Display ONLY the displayAnswer (the primary correct one)
                            const primaryCorrectAnswer = gameData.currentDisplayAnswer;
                            const listItem = document.createElement('li');
                            if (primaryCorrectAnswer) {
                                // Check if the primary correct answer was guessed by anyone using the new isCorrectAnswer
                                const wasPrimaryGuessed = isCorrectAnswer(primaryCorrectAnswer, gameData.currentQuestionGuessedAnswers || []);
                                if (wasPrimaryGuessed) {
                                    listItem.innerHTML = `<i class="fas fa-check text-green-500 mr-2"></i> ${primaryCorrectAnswer}`;
                                } else {
                                    // If not guessed, check if any of the fuzzy answers were guessed (these are normalized answers)
                                    // This logic is mostly for comprehensive check, but for display, we show displayAnswer
                                    const anyFuzzyGuessed = (gameData.currentCorrectAnswers || []).some(ans => (gameData.currentQuestionGuessedAnswers || []).some(guessed => isCorrectAnswer(guessed, [ans]))); // Check if any submitted guess (even if not primary) is fuzzy correct
                                    if (anyFuzzyGuessed) {
                                        listItem.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i> ${primaryCorrectAnswer} (Ø¨Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø´Ø§Ø¨Ù‡Ø©)`;
                                    } else {
                                        listItem.innerHTML = `<i class="fas fa-times text-red-500 mr-2"></i> ${primaryCorrectAnswer}`;
                                    }
                                }
                            } else {
                                listItem.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„.";
                            }
                            roundCorrectAnswersList.appendChild(listItem);
                        }

                        // Display player scores for this question (fetching live data from players subcollection)
                        showQuestionPlayerScoresDetailed(); // Detailed scores for this question

                        // Host controls for next question or end game
                        if (isHost && questionResultsHostControls) {
                            questionResultsHostControls.classList.remove('hidden');
                            // Check if there are more questions in the quizSet
                            // gameData.currentQuestionIndexInGame holds the index of the *next* question to be played
                            if (gameData.currentQuestionIndexInGame < gameData.quizSet.length) {  
                                if (nextQuestionButton) nextQuestionButton.classList.remove('hidden');
                                if (endGameFinalButton) endGameFinalButton.classList.add('hidden'); // Hide end game button if more questions
                            } else { // No more questions, show end game button
                                if (nextQuestionButton) nextQuestionButton.classList.add('hidden'); // Hide next question button
                                if (endGameFinalButton) endGameFinalButton.classList.remove('hidden'); // Show end game button
                            }
                        } else {
                            if (questionResultsHostControls) questionResultsHostControls.classList.add('hidden'); // Hide host controls for players
                        }
                    }
                    // Phase: Final Game Results
                    else if (gamePhase === 'final_results') {
                        clearInterval(timerInterval); // Stop any active timers
                        currentQuestionSoundPlayed = false; // Reset sound flag
                        showFinalScores(); // Display final overall scores
                    }
                } else {
                    console.log("Game document deleted or does not exist.");
                    showCustomMessageBox("Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", "ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ Ù‡Ø°Ù‡ Ù„Ù… ØªØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø©. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø¶ÙŠÙ Ù‚Ø¯ Ø£ØºÙ„Ù‚Ù‡Ø§.");
                    showScreen(roleSelectionScreen); // Go back to role selection
                }
            }, (error) => {
                console.error("Error listening to game changes:", error);
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", `ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${error.message}`);
            });
        }

        // Listens for changes to the players subcollection in Firestore
        function listenToPlayers() {
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe(); // Unsubscribe from previous listener

            const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
            console.log("Listening to players at path:", playersRef.path); // Log path
            const q = playersRef;

            playersSnapshotUnsubscribe = q.onSnapshot((snapshot) => {
                if (joinedPlayersList) joinedPlayersList.innerHTML = ''; // Clear current list of joined players
                // Do not clear playerCorrectGuessesList here, it will be updated based on playerSubmittedAnswer in gameData
                
                let currentPlayerOverallScore = 0;
                
                // Get gameData to determine who the host is
                db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).get().then(gameDoc => {
                    let hostIdFromGame = null;
                    let gamePhase = 'lobby'; // Default for safety
                    if (gameDoc.exists) {
                        const gameData = gameDoc.data();
                        hostIdFromGame = gameData.hostId;
                        gamePhase = gameData.gamePhase;
                    }

                    // Update host submission status list (if current user is host)
                    if (hostSubmissionStatusList && isHost) {  
                        hostSubmissionStatusList.innerHTML = ''; // Clear for fresh update
                    }


                    snapshot.forEach((doc) => {
                        const playerData = doc.data();
                        const playerId = doc.id;

                        // Update the list of joined players in the waiting room
                        if (joinedPlayersList) {
                            const listItem = document.createElement('li');
                            let playerDisplayName = playerData.nickname || 'Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„';
                            // Add Host tag if this player is the host
                            if (hostIdFromGame && hostIdFromGame === playerId) {
                                playerDisplayName += ' <i class="fas fa-crown text-yellow-500"></i> (Ø§Ù„Ù…Ø¶ÙŠÙ)';
                            }
                            // Display full user ID for uniqueness and debugging in multiplayer, as per guidelines.
                            listItem.innerHTML = `${playerDisplayName} (ID: ${playerId} - Ø§Ù„Ù†Ù‚Ø§Ø·: ${playerData.score || 0})`;
                            joinedPlayersList.appendChild(listItem);
                        }

                        // Update host's view of player submission status - IMPROVED DETAIL HERE
                        if (hostSubmissionStatusList && isHost) {
                            const statusItem = document.createElement('li');
                            let statusIcon = '';
                            let submittedAnswerText = '';
                            let scoreChangeText = '';

                            if (playerData.hasSubmittedAnswer) {
                                statusIcon = '<i class="fas fa-check-circle text-green-500 ml-2"></i>';
                                submittedAnswerText = `Ø¥Ø¬Ø§Ø¨Ø©: ${playerData.playerSubmittedAnswer || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}`;
                                const scoreChange = playerData.playerScoreChange || 0;
                                scoreChangeText = `(${scoreChange >= 0 ? '+' : ''}${scoreChange} Ù†Ù‚Ø·Ø©ØŒ Ø±Ù‡Ø§Ù†: ${playerData.playerSelectedPoints || 0})`;
                            } else {  
                                statusIcon = '<i class="fas fa-hourglass-half text-gray-500 ml-2"></i>';
                                submittedAnswerText = 'Ù„Ù… ÙŠØ¬Ø¨';
                            }
                            statusItem.innerHTML = `
                                ${playerData.nickname || 'Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„'}: ${statusIcon} ${submittedAnswerText} ${scoreChangeText}
                            `;
                            hostSubmissionStatusList.appendChild(statusItem);
                        }


                        // Update current player's overall score (only for self)
                        if (playerId === userId) {
                            currentPlayerOverallScore = playerData.score || 0;
                            // Update local userUsedPointsBets from player data
                            userUsedPointsBets = playerData.usedPointsBets || [];  
                            populatePointsButtons(); // Re-render buttons with updated used points status

                            // Update player's correct answers for current question on UI if applicable
                            // This list only shows *your* correct guesses for the CURRENT question.
                            if (playerCorrectGuessesList) {
                                // No change to its display logic; it's meant to be cleared and re-populated
                                // when a new question starts, and updated dynamically as *this* player guesses.
                            }
                        }
                    });
                    if (playerScoreDisplay) playerScoreDisplay.textContent = currentPlayerOverallScore; // Update UI with overall score

                    // Host-specific logic: Show/hide start button based on number of players
                    // Only apply if host is in waiting room phase
                    if (gamePhase === 'lobby' && isHost) {
                        // For starting the game, require at least the host and one other player.
                        if (snapshot.size >= 2) { 
                            if (startGameButton) startGameButton.classList.remove('hidden'); // Show start button
                        } else {
                            if (startGameButton) startGameButton.classList.add('hidden'); // Hide if only host or no other players
                        }
                    }

                }).catch(error => console.error("Error checking game phase/hostId for players listener:", error));

            }, (error) => {
                console.error("Error listening to players:", error);
                // Optionally show error message about player list update issues
            });
        }

        // Displays detailed scores of players for the CURRENT QUESTION on the results screen
        async function showQuestionPlayerScoresDetailed() { // Renamed from showRoundPlayerScores
            if (questionPlayerScoresList) questionPlayerScoresList.innerHTML = ''; // Clear previous scores
            try {
                const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersSnapshot = await playersRef.get();
                // Get main game data to retrieve the correct answers for the current question
                const gameData = (await db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).get()).data();
                const currentCorrectAnswers = gameData.currentCorrectAnswers || []; // All valid answers for fuzzy matching


                let questionScores = [];
                playersSnapshot.forEach(doc => {
                    const playerData = doc.data();
                    questionScores.push({
                        nickname: playerData.nickname,
                        submittedAnswer: playerData.playerSubmittedAnswer || 'Ù„Ù… ÙŠØ¬Ø¨',
                        selectedPoints: playerData.playerSelectedPoints || 0,
                        scoreChange: playerData.playerScoreChange || 0,
                        overallScore: playerData.score || 0
                    });
                });

                // Sort by overall score for this question (as requested)
                questionScores.sort((a, b) => b.overallScore - a.overallScore);

                if (questionPlayerScoresList) {
                    questionScores.forEach((player, index) => { // Added index for rank
                        const listItem = document.createElement('li');
                        listItem.classList.add('py-2', 'px-4', 'rounded-lg', 'mb-2', 'bg-gray-50');
                        
                        let answerStatusIcon = '';
                        let answerColorClass = 'text-gray-700';

                        // Check if player's submitted answer is one of the correct answers (using fuzzy logic)
                        let isPlayerAnswerCorrect = false;
                        if (player.submittedAnswer !== 'Ù„Ù… ÙŠØ¬Ø¨') {
                            // Using the new isCorrectAnswer function
                            isPlayerAnswerCorrect = isCorrectAnswer(player.submittedAnswer, currentCorrectAnswers);
                        }

                        if (player.submittedAnswer !== 'Ù„Ù… ÙŠØ¬Ø¨') {
                            if (isPlayerAnswerCorrect) {
                                answerStatusIcon = `<i class="fas fa-check-circle text-green-500 mr-2"></i>`;
                                answerColorClass = 'text-green-700';
                            } else {
                                answerStatusIcon = `<i class="fas fa-times-circle text-red-500 mr-2"></i>`;
                                answerColorClass = 'text-red-700';
                            }
                        } else {
                            answerStatusIcon = `<i class="fas fa-question-circle text-gray-500 mr-2"></i>`; // Icon for no answer
                            answerColorClass = 'text-gray-500';
                        }


                        listItem.innerHTML = `
                            <span class="font-bold">Ø§Ù„Ù…Ø±ÙƒØ² ${index + 1}: ${player.nickname}:</span>  
                            <span class="${answerColorClass}">${answerStatusIcon} ${player.submittedAnswer}</span>  
                            (Ø±Ø§Ù‡Ù† Ø¨Ù€ ${player.selectedPoints} Ù†Ù‚Ø·Ø©ØŒ  
                            ${player.scoreChange >= 0 ? '+' : ''}${player.scoreChange} Ù†Ù‚Ø·Ø©ØŒ  
                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${player.overallScore})
                        `;
                        questionPlayerScoresList.appendChild(listItem);
                    });
                }

            } catch (error) {
                console.error("Error showing question player scores detailed:", error);
                showCustomMessageBox("Ø®Ø·Ø£", "ÙØ´Ù„ Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }


        // Displays the final overall scores screen and results
        async function showFinalScores() {
            showLoading(); // Show loading spinner
            try {
                // Unsubscribe from real-time listeners to prevent further updates
                if (gameSnapshotUnsubscribe) {
                    gameSnapshotUnsubscribe();
                    gameSnapshotUnsubscribe = null;
                }
                if (playersSnapshotUnsubscribe) {
                    playersSnapshotUnsubscribe();
                    playersSnapshotUnsubscribe = null;
                }

                // Fetch all player data one last time to get final scores
                const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`);
                const playersSnapshot = await playersRef.get();

                let finalScores = [];
                playersSnapshot.forEach(doc => {
                    finalScores.push(doc.data());
                });

                // Sort players by overall score in descending order to determine winner
                finalScores.sort((a, b) => (b.score || 0) - (a.score || 0));

                if (finalScoresList) {
                    finalScoresList.innerHTML = ''; // Clear previous final scores list
                    if (finalScores.length > 0) {
                        finalScores.forEach((player, index) => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('py-2', 'px-4', 'rounded-lg', 'mb-2');
                            if (index === 0) { // Highlight the winner
                                listItem.classList.add('bg-yellow-200', 'font-bold', 'text-yellow-800');
                                listItem.innerHTML = `<i class="fas fa-trophy text-yellow-600 mr-2"></i> Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆÙ„: ${player.nickname} - ${player.score} Ù†Ù‚Ø·Ø©`;
                            } else { // Other players
                                listItem.classList.add('bg-gray-50');
                                listItem.textContent = `${player.nickname} - ${player.score} Ù†Ù‚Ø·Ø©`;
                            }
                            finalScoresList.appendChild(listItem);
                        });
                        if (endTitle) endTitle.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!";
                        if (endMessage) endTitle.textContent = `ÙØ§Ø² ${finalScores[0].nickname} Ø¨Ù€ ${finalScores[0].score} Ù†Ù‚Ø·Ø©!`;
                    } else {
                        if (endTitle) endTitle.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!";
                        if (endMessage) endTitle.textContent = "Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©.";
                    }
                }

                showScreen(gameEndScreen); // Show the game end screen

            } catch (error) {
                console.error("Error showing final scores:", error);
                showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬", "ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.");
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        // --- Event Listeners (Handle user interactions) ---
        // When host wants to create a game
        if (createHostButton) {
            createHostButton.addEventListener('click', () => {
                setupQuizCategorySelection(); // Initialize multi-select dropdown
                if (hostNicknameInput) hostNicknameInput.value = localStorage.getItem('hostNickname') || ''; // Load host nickname
                showScreen(hostSetupScreen); // Show host setup screen
            });
        }

        // When a player wants to join a game
        if (joinPlayerButton) {
            joinPlayerButton.addEventListener('click', () => {
                if (playerNicknameInput) playerNicknameInput.value = localStorage.getItem('playerNickname') || ''; // Pre-fill nickname if saved
                showScreen(joinGameScreen); // Show join game screen
            });
        }

        // Host clicks to create the game instance in Firebase
        if (createGameButton) createGameButton.addEventListener('click', createGame);

        // Player clicks to submit their answer and chosen points
        if (submitAnswerButton) submitAnswerButton.addEventListener('click', submitGuess);

        // Host clicks to start the game (initiates countdown for first question) from waiting room
        if (startGameButton) startGameButton.addEventListener('click', initiateGameStartCountdown);  

        // Host clicks to end the current question early
        if (endQuestionEarlyButton) endQuestionEarlyButton.addEventListener('click', endQuestionEarly);  

        // Host clicks to proceed to the next question from question results screen
        if (nextQuestionButton) nextQuestionButton.addEventListener('click', startNextQuestion);  

        // Host clicks to end the entire game from question results screen
        if (endGameFinalButton) endGameFinalButton.addEventListener('click', endGame);


        // Player clicks to join a specific room
        if (joinRoomButton) {
            joinRoomButton.addEventListener('click', () => {
                const code = gameCodeInput ? gameCodeInput.value.trim().toUpperCase() : '';
                const nickname = playerNicknameInput ? playerNicknameInput.value.trim() : '';
                if (code && nickname) { // Validate inputs
                    joinGame(code, nickname);
                } else {
                    showCustomMessageBox("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±.");
                }
            });
        }

        // Handle player's guess submission on Enter key press
        if (gameGuessInput) {
            gameGuessInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent default form submission behavior
                    submitGuess(); // Submit the guess
                }
            });
        }

        // Button to play again after a game ends
        if (playAgainButton) {
            playAgainButton.addEventListener('click', () => {
                // Reset all game-related global variables and listeners
                gameId = null;
                isHost = false;
                clearInterval(timerInterval); // Clear any active timer
                if (gameSnapshotUnsubscribe) { // Unsubscribe from Firestore listeners
                    gameSnapshotUnsubscribe();
                    gameSnapshotUnsubscribe = null;
                }
                if (playersSnapshotUnsubscribe) { // Unsubscribe from Firestore listeners
                    playersSnapshotUnsubscribe();
                    playersSnapshotUnsubscribe = null;
                }
                selectedQuizIndices = []; // Reset selected quizzes for host setup
                userUsedPointsBets = []; // Reset locally used points
                populatePointsButtons(); // Re-render points buttons
                showScreen(roleSelectionScreen); // Return to role selection screen
                window.history.pushState({}, '', window.location.pathname); // Clear gameId from URL
            });
        }

        // Close button for the custom message box
        if (customMessageCloseButton) customMessageCloseButton.addEventListener('click', hideCustomMessageBox);

        // --- Initial Load ---
        // DOMContentLoaded listener is already used at the bottom of the script for initial checks and Firebase init.
    </script>

</body>
</html>
