<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حرقاسة HARGASA GAME</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for audio effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* Base font and direction for Arabic */
        body { font-family: 'Cairo', sans-serif; direction: rtl; text-align: right; }
        /* Custom animation for list items */
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInFromBottom 0.5s ease-out forwards; }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4a90e2;
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styles for the copy button */
        .copy-button {
            background-color: #4CAF50; color: white; padding: 10px 15px; border: none;
            border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .copy-button:hover { background-color: #45a049; }
        /* Style for the QR code container */
        #qrcode { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; min-height: 128px; }
        /* Multiselect styles */
        .multiselect-container { position: relative; width: 100%; }
        .multiselect-dropdown {
            border: 2px solid #e2e8f0; border-radius: 0.5rem; background-color: #f9fafb;
            max-height: 150px; overflow-y: auto; position: absolute;
            width: 100%; z-index: 10; margin-top: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .multiselect-dropdown label { display: block; padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; }
        .multiselect-dropdown label:hover { background-color: #e2e8f0; }
        .multiselect-selected-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .tag {
            background-color: #a78bfa; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px;
            font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;
        }
        .tag-remove { cursor: pointer; font-weight: bold; opacity: 0.7; transition: opacity 0.2s; }
        .tag-remove:hover { opacity: 1; }
        /* Points buttons styles */
        .points-button-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
        .points-button {
            padding: 8px 12px; border-radius: 8px; border: 2px solid #cbd5e0; background-color: #f8fafc;
            color: #4a5568; font-weight: bold; cursor: pointer; transition: all 0.2s ease;
        }
        .points-button.selected {
            background-color: #6366f1; color: white; border-color: #6366f1;
            transform: scale(1.05); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .points-button.used {
            background-color: #e2e8f0; color: #94a3b8; border-color: #cbd5e0;
            cursor: not-allowed; opacity: 0.8; text-decoration: line-through;
        }
        .points-button:not(.selected):not(.used):hover { background-color: #e2e8f0; border-color: #a0aec0; }
        .points-button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 min-h-screen flex flex-col items-center justify-center p-4 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center text-white text-xl">
            <div class="loading-spinner mb-4"></div>
            جاري التحميل...
        </div>
    </div>

    <div id="game-countdown-screen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center text-yellow-400 text-9xl font-extrabold z-50 hidden">
        <span id="countdown-timer-display">5</span>
    </div>

    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full flex flex-col items-center relative overflow-hidden">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 text-center leading-tight">لعبة حرقاسة HARGASA GAME <i class="fas fa-users text-blue-500"></i></h1>
        <p class="text-lg text-gray-600 mb-8 text-center" id="game-description">اختر دورك: إما مضيف لإنشاء غرفة، أو لاعب للانضمام إلى غرفة موجودة.</p>

        <div id="role-selection-screen" class="w-full flex flex-col items-center space-y-6">
            <button id="create-host-button" class="w-full md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-crown"></i> إنشاء غرفة (مضيف)
            </button>
            <button id="join-player-button" class="w-full md:w-2/3 bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-5 rounded-lg shadow-xl transform hover:scale-105 transition-all duration-300 ease-out flex items-center justify-center gap-3">
                <i class="fas fa-gamepad"></i> الانضمام إلى غرفة (لاعب)
            </button>
        </div>

        <div id="host-setup-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">إعداد غرفة اللعب</h2>
            <div class="w-full mb-6">
                <label for="host-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2">اسمك المستعار (المضيف):</label>
                <input type="text" id="host-nickname-input" placeholder="اسم المضيف" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
            </div>
            <div class="w-full mb-6">
                <label for="quiz-category-input" class="block text-xl font-semibold text-gray-700 mb-2">اختر فئات الأسئلة:</label>
                <div class="multiselect-container">
                    <input type="text" id="quiz-category-input" readonly placeholder="انقر هنا لاختيار الفئات..." class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50 cursor-pointer">
                    <div id="quiz-category-dropdown" class="multiselect-dropdown hidden"></div>
                </div>
                <div id="selected-categories-tags" class="multiselect-selected-tags"></div>
            </div>
            <div class="w-full mb-6">
                <label for="total-questions-per-game-select" class="block text-xl font-semibold text-gray-700 mb-2">عدد الأسئلة:</label>
                <select id="total-questions-per-game-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="5">5 أسئلة</option> <option value="10">10 أسئلة</option> <option value="15">15 سؤال</option>
                    <option value="20">20 سؤال</option> <option value="30">30 سؤال</option>
                </select>
            </div>
            <div class="w-full mb-6">
                <label for="time-limit-select" class="block text-xl font-semibold text-gray-700 mb-2">الوقت لكل سؤال (بالثواني):</label>
                <select id="time-limit-select" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:outline-none focus:border-blue-500 bg-gray-50">
                    <option value="15">15 ثانية</option> <option value="20">20 ثانية</option> <option value="30">30 ثانية</option>
                    <option value="45">45 ثانية</option> <option value="60">60 ثانية</option>
                </select>
            </div>
            <button id="create-game-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                <i class="fas fa-plus-circle"></i> إنشاء اللعبة
            </button>
        </div>

        <div id="waiting-room-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4" id="waiting-room-title">انتظر انضمام اللاعبين...</h2>
            <p class="text-xl text-gray-700 mb-6">شارك هذا الرابط مع أصدقائك للانضمام:</p>
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 flex flex-col items-center">
                <span id="game-link-display" class="text-md md:text-xl font-medium text-blue-600 break-all text-center"></span>
                <div id="qrcode" class="mb-2 p-2 bg-white rounded-lg shadow-md flex justify-center items-center">
                    <div id="qrcode-fallback-message" class="text-gray-500 text-sm text-center"></div>
                </div>
                <button id="copy-link-button" class="copy-button mt-4">انسخ الرابط</button>
            </div>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">اللاعبون المنضمون:</h3>
            <ul id="joined-players-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 h-40 overflow-y-auto shadow-inner text-lg"></ul>
            <button id="start-game-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 hidden">
                <i class="fas fa-play"></i> بدء اللعب!
            </button>
        </div>

        <div id="join-game-screen" class="w-full flex flex-col items-center hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6">الانضمام إلى غرفة اللعب</h2>
            <div class="w-full mb-6">
                <label for="game-code-input" class="block text-xl font-semibold text-gray-700 mb-2">أدخل رمز الغرفة:</label>
                <input type="text" id="game-code-input" placeholder="مثال: 123" class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 uppercase text-center tracking-widest">
            </div>
             <div class="w-full mb-6">
                <label for="player-nickname-input" class="block text-xl font-semibold text-gray-700 mb-2">أدخل اسمك المستعار:</label>
                <input type="text" id="player-nickname-input" placeholder="اسمك" class="w-full p-4 mb-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-center">
            </div>
            <button id="join-room-button" class="w-full bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3">
                <i class="fas fa-door-open"></i> الانضمام
            </button>
        </div>

        <div id="game-play-screen" class="w-full hidden">
            <p class="text-2xl font-bold text-gray-800 mb-4 text-center">الفئة: <span id="game-category" class="text-indigo-600"></span></p>
            <div class="bg-blue-100 p-4 rounded-lg shadow-md mb-6 w-full text-center">
                <p class="text-2xl font-extrabold text-gray-900" id="game-question"></p>
            </div>
            <div class="flex flex-col md:flex-row justify-around items-center w-full mb-8 space-y-4 md:space-y-0 md:space-x-4 rtl:md:space-x-reverse">
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-hourglass-half text-blue-500"></i>
                    <span>الوقت: <span id="game-timer" class="text-blue-600">--</span></span>
                </div>
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span>نقاطك: <span id="player-score" class="text-yellow-600">0</span></span>
                </div>
                <div class="flex items-center space-x-2 rtl:space-x-reverse text-xl font-bold text-gray-700 bg-gray-100 px-4 py-2 rounded-lg shadow-md">
                    <i class="fas fa-question-circle text-purple-500"></i>
                    <span>السؤال: <span id="question-counter" class="text-purple-600">-- / --</span></span>
                </div>
            </div>
            <div class="flex items-center flex-wrap gap-2 w-full mb-4">
                <input type="text" id="game-guess-input" placeholder="اكتب إجابتك هنا..." class="flex-grow p-4 text-xl border-4 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                <button id="submit-answer-button" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all duration-300 flex-shrink-0">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
            </div>
            <div class="w-full mb-6">
                <label class="block text-xl font-semibold text-gray-700 mb-2 text-center">راهن بالنقاط:</label>
                <div id="points-button-group" class="points-button-group"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-800 mb-3">إجاباتك الصحيحة (لهذا السؤال):</h3>
                    <ul id="player-correct-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2"></ul>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 h-64 overflow-y-auto shadow-inner">
                    <h3 class="text-xl font-semibold text-purple-800 mb-3">الإجابات المشتركة (لهذا السؤال):</h3>
                    <ul id="shared-round-guesses-list" class="list-disc pr-6 text-gray-700 text-lg space-y-2"></ul>
                </div>
            </div>
            <div id="host-gameplay-controls" class="w-full flex flex-col items-center gap-4 mt-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">حالة إجابة اللاعبين:</h3>
                <ul id="host-submission-status-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-3 mb-4 shadow-inner text-base max-h-32 overflow-y-auto"></ul>
                <button id="end-question-early-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all">
                    <i class="fas fa-flag-checkered"></i> إنهاء السؤال الآن
                </button>
            </div>
            <button id="player-exit-button-gameplay" class="w-full bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all mt-6 hidden">
                <i class="fas fa-sign-out-alt"></i> الخروج من اللعبة
            </button>
        </div>

        <div id="question-results-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">نتائج السؤال!</h2>
            <p class="text-xl text-gray-700 mb-6 text-center">الفئة: <span id="results-category" class="font-bold text-indigo-600"></span></p>
            <p class="text-2xl font-semibold text-gray-800 mb-4 text-center">السؤال: <span id="results-question" class="font-bold text-gray-900"></span></p>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الإجابة الصحيحة:</h3>
            <ul id="round-correct-answers-list" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 max-h-64 overflow-y-auto shadow-inner text-lg list-disc pr-6"></ul>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">أداء اللاعبين:</h3>
            <ul id="question-player-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto"></ul>
            <div id="question-results-host-controls" class="w-full flex flex-col items-center gap-4 hidden">
                <button id="next-question-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-forward"></i> السؤال التالي
                </button>
                <button id="end-game-final-button" class="w-full bg-red-600 hover:bg-red-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-times-circle"></i> إنهاء اللعبة
                </button>
            </div>
            <button id="player-exit-button-results" class="w-full bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition-all mt-6 hidden">
                <i class="fas fa-sign-out-alt"></i> الخروج من اللعبة
            </button>
        </div>

        <div id="game-end-screen" class="w-full hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center" id="end-title">النتائج النهائية!</h2>
            <p class="text-xl text-gray-600 mb-6 text-center" id="end-message"></p>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">الترتيب النهائي:</h3>
            <ul id="final-scores-list" class="w-full bg-gray-100 border border-gray-200 rounded-lg p-4 mb-8 shadow-inner text-lg max-h-64 overflow-y-auto"></ul>
            <button id="start-new-round-same-room-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3 mb-4 hidden">
                <i class="fas fa-sync-alt"></i> بدء جولة جديدة بنفس الغرفة
            </button>
            <button id="play-again-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-4 rounded-lg shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                <i class="fas fa-redo"></i> العب مرة أخرى (غرفة جديدة)
            </button>
        </div>

        <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 ease-out opacity-0">
            <div class="bg-white rounded-xl p-8 text-center shadow-xl transform scale-90 transition-transform duration-300 ease-out">
                <h2 id="custom-message-title" class="text-3xl font-bold text-gray-900 mb-4"></h2>
                <p id="custom-message-content" class="text-xl text-gray-700 mb-6"></p>
                <div id="custom-message-buttons" class="flex justify-center gap-4"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // Global variables for game state and Firebase services
        let app, db, auth, userId, userNickname, appId;
        let gameId = null;
        let isHost = false;
        let gameSnapshotUnsubscribe = null;
        let playersSnapshotUnsubscribe = null;
        let timerInterval = null;
        let selectedPointsBet = 1;
        let userUsedPointsBets = [];
        let currentQuestionSoundInterval = null;
        let soundStarted = false;
        let selectedQuizIndices = [];

        // ALL QUIZ CATEGORIES RESTORED
        const quizzes = [
            { category: "عواصم الدول العربية", questions: [ { questionText: "ما هي عاصمة تونس؟", displayAnswer: "تونس", correctAnswers: ["تونس", "tunis"] }, { questionText: "ما هي عاصمة مصر؟", displayAnswer: "القاهرة", correctAnswers: ["القاهرة", "cairo"] }, { questionText: "ما هي عاصمة السعودية؟", displayAnswer: "الرياض", correctAnswers: ["الرياض", "riyadh"] } ] },
            { category: "الفواكه", questions: [ { questionText: "فاكهة حمراء وصغيرة؟", displayAnswer: "فراولة", correctAnswers: ["فراولة", "كرز", "توت"] }, { questionText: "فاكهة صفراء غنية بالبوتاسيوم؟", displayAnswer: "موز", correctAnswers: ["موز"] } ] },
            { category: "عواصم دول أوروبية", questions: [ { questionText: "ما هي عاصمة ألمانيا؟", displayAnswer: "برلين", correctAnswers: ["برلين", "berlin"] }, { questionText: "ما هي عاصمة فرنسا؟", displayAnswer: "باريس", correctAnswers: ["باريس", "paris"] } ] },
            { category: "أمثال شعبية تونسية", questions: [ { questionText: "كمل المثل: إلّي في كرشه التبن...", displayAnswer: "يخاف من النار", correctAnswers: ["يخاف من النار"] }, { questionText: "كمل المثل: الباب إلّي يجيك منّو الريح...", displayAnswer: "سدّو واستريح", correctAnswers: ["سدو واستريح", "سده واستريح"] } ] },
            { category: "ثقافة عامة", questions: [ { questionText: "ما هو أسرع حيوان بري؟", displayAnswer: "الفهد", correctAnswers: ["الفهد", "الشيتا"] }, { questionText: "كم عدد كواكب المجموعة الشمسية؟", displayAnswer: "ثمانية", correctAnswers: ["8", "ثمانية"] } ] },
            { category: "اسئلة الشلة", questions: [ { questionText: "كي نقولو كنترول شنوة يجي للبالك ؟", displayAnswer: "كعبورة", correctAnswers: ["لمكعبر", "كعبر", "ka3boura", "كعبورة"] }, { questionText: "شكون الي يفلم برشا في الشلة؟", displayAnswer: "ولد الورغي", correctAnswers: ["lou", "لؤي", "louay", "ولد الورغي"] } ] },
            { category: "حيوانات الغابة", questions: [ { questionText: "ملك الغابة؟", displayAnswer: "أسد", correctAnswers: ["أسد", "اسد"] }, { questionText: "حيوان مخطط بالأبيض والأسود؟", displayAnswer: "حمار وحشي", correctAnswers: ["حمار وحشي", "الزيبرا"] } ] },
            { category: "أسئلة تونسية", questions: [ { questionText: "شنوة عاصمة تونس؟", displayAnswer: "تونس", correctAnswers: ["تونس", "tunis", "tounes"] }, { questionText: "شكون الرئيس الأول لتونس؟", displayAnswer: "الحبيب بورقيبة", correctAnswers: ["الحبيب بورقيبة", "بورقيبة", "bourguiba"] } ] }
        ];

        // --- Utility Functions ---
        const $ = (id) => document.getElementById(id);
        const normalize = (text) => typeof text !== 'string' ? '' : text.toLowerCase().replace(/\s+/g, '').replace(/[أإآ]/g, 'ا').replace(/ى/g, 'ي').replace(/ة/g, 'ه').replace(/[ؤء]/g, 'و').replace(/ئ/g, 'ي').replace(/[^a-z0-9\u0600-\u06FF]/g, '');
        const editDistance = (s1, s2) => { let costs = []; for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i === 0) costs[j] = j; else if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(newValue, lastValue, costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length]; };
        const similarity = (s1, s2) => { let longer = s1, shorter = s2; if (s1.length < s2.length) { longer = s2; shorter = s1; } let longerLength = longer.length; if (longerLength === 0) return 1.0; return (longerLength - editDistance(longer, shorter)) / longerLength; };
        const isCorrectAnswer = (playerAnswer, acceptedAnswers) => acceptedAnswers.some(ans => similarity(normalize(playerAnswer), normalize(ans)) >= 0.85);
        const playTimerSound = () => { if (Tone.context.state !== 'running') { Tone.start(); } new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination().triggerAttackRelease("G5", "32n"); };

        // --- UI Management ---
        const showLoading = () => $('loading-overlay').classList.remove('hidden');
        const hideLoading = () => $('loading-overlay').classList.add('hidden');
        const showScreen = (screen) => {
            [ 'role-selection-screen', 'host-setup-screen', 'waiting-room-screen', 'join-game-screen', 'game-play-screen', 'question-results-screen', 'game-end-screen', 'game-countdown-screen' ].forEach(id => $(id).classList.add('hidden'));
            if(screen) screen.classList.remove('hidden');
        };
        const showCustomMessageBox = (title, content, options = {}) => {
            $('custom-message-title').textContent = title;
            $('custom-message-content').innerHTML = content;
            const buttonsContainer = $('custom-message-buttons');
            buttonsContainer.innerHTML = '';
            const buttons = options.buttons || [{ text: 'حسناً', callback: hideCustomMessageBox, className: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded' }];
            buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.className;
                button.onclick = () => { if(btnConfig.callback) btnConfig.callback(); hideCustomMessageBox(); };
                buttonsContainer.appendChild(button);
            });
            const box = $('custom-message-box');
            box.classList.remove('hidden', 'opacity-0');
            box.firstElementChild.classList.remove('scale-90');
        };
        const hideCustomMessageBox = () => {
            const box = $('custom-message-box');
            box.classList.add('opacity-0');
            box.firstElementChild.classList.add('scale-90');
            setTimeout(() => box.classList.add('hidden'), 300);
        };
        
        // --- Game Setup UI ---
        const setupQuizCategorySelection = () => {
            const dropdown = $('quiz-category-dropdown');
            dropdown.innerHTML = '';
            quizzes.forEach((quiz, index) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.value = index; checkbox.className = 'ml-2';
                checkbox.checked = selectedQuizIndices.includes(index);
                label.append(checkbox, ` ${quiz.category}`);
                dropdown.appendChild(label);
                checkbox.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.value);
                    if (e.target.checked) !selectedQuizIndices.includes(idx) && selectedQuizIndices.push(idx);
                    else selectedQuizIndices = selectedQuizIndices.filter(i => i !== idx);
                    updateSelectedCategoriesTags();
                });
            });
            updateSelectedCategoriesTags();
        };
        const updateSelectedCategoriesTags = () => {
            const tagsContainer = $('selected-categories-tags');
            tagsContainer.innerHTML = '';
            selectedQuizIndices.forEach(index => {
                const tag = document.createElement('span'); tag.className = 'tag'; tag.textContent = quizzes[index].category;
                const removeBtn = document.createElement('span'); removeBtn.className = 'tag-remove'; removeBtn.textContent = 'x';
                removeBtn.style.marginRight = '5px';
                removeBtn.onclick = () => { selectedQuizIndices = selectedQuizIndices.filter(i => i !== index); setupQuizCategorySelection(); };
                tag.appendChild(removeBtn); tagsContainer.appendChild(tag);
            });
            $('quiz-category-input').placeholder = selectedQuizIndices.length === 0 ? "انقر لاختيار الفئات..." : `تم اختيار ${selectedQuizIndices.length} فئة`;
        };
        const populatePointsButtons = () => {
            const group = $('points-button-group');
            group.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button'); button.type = 'button'; button.className = 'points-button'; button.textContent = i; button.dataset.points = i;
                if (userUsedPointsBets.includes(i)) { button.disabled = true; button.classList.add('used'); }
                if (i === selectedPointsBet && !button.disabled) button.classList.add('selected');
                button.addEventListener('click', (e) => {
                    if (e.target.disabled) return;
                    const currentSelected = group.querySelector('.points-button.selected');
                    if (currentSelected) currentSelected.classList.remove('selected');
                    e.target.classList.add('selected'); selectedPointsBet = parseInt(e.target.dataset.points);
                });
                group.appendChild(button);
            }
            if (!group.querySelector('.points-button.selected')) {
                const firstAvailable = group.querySelector('.points-button:not(.used)');
                if (firstAvailable) { firstAvailable.classList.add('selected'); selectedPointsBet = parseInt(firstAvailable.dataset.points); }
            }
        };

        // --- Core Game Logic ---
        const exitGame = () => {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe();
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe();
            clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval);
            gameId = null; isHost = false; userUsedPointsBets = [];
            window.history.pushState({}, '', window.location.pathname);
            showScreen($('role-selection-screen'));
        };
        const createGame = async () => {
            showLoading();
            try {
                const nickname = $('host-nickname-input').value.trim();
                if (!nickname) throw new Error("الرجاء إدخال اسمك المستعار.");
                if (selectedQuizIndices.length === 0) throw new Error("الرجاء اختيار فئة واحدة على الأقل.");
                gameId = await (async () => { let id, isUnique = false; while(!isUnique) { id = String(Math.floor(100 + Math.random() * 900)); const doc = await db.collection(`artifacts/${appId}/public/data/games`).doc(id).get(); if(!doc.exists) isUnique = true; } return id; })();
                isHost = true; userNickname = nickname; localStorage.setItem('playerNickname', userNickname);
                let allQuestions = []; selectedQuizIndices.forEach(i => allQuestions.push(...quizzes[i].questions.map(q => ({...q, category: quizzes[i].category}))));
                for (let i = allQuestions.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]]; }
                const quizSet = allQuestions.slice(0, parseInt($('total-questions-per-game-select').value));
                if (quizSet.length === 0) throw new Error("لا توجد أسئلة كافية في الفئات المختارة.");
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                await gameRef.set({ hostId: userId, gamePhase: 'lobby', quizSet, selectedCategoryIndices, timeLimitPerQuestion: parseInt($('time-limit-select').value), currentQuestionIndexInGame: 0 });
                await gameRef.collection('players').doc(userId).set({ nickname, score: 0, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), usedPointsBets: [] });
                const link = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;
                $('game-link-display').textContent = link; $('qrcode').innerHTML = ''; new QRCode($('qrcode'), { text: link, width: 128, height: 128 });
                $('copy-link-button').onclick = () => navigator.clipboard.writeText(link).then(() => showCustomMessageBox("تم النسخ!", "تم نسخ رابط الغرفة."));
                listenToGameChanges(); listenToPlayers(); showScreen($('waiting-room-screen'));
            } catch (e) { showCustomMessageBox("خطأ", e.message); } finally { hideLoading(); }
        };
        const joinGame = async (code, nickname) => {
            showLoading();
            try {
                if (!code || !nickname) throw new Error("يرجى إدخال الرمز والاسم.");
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(code);
                const doc = await gameRef.get();
                if (!doc.exists) throw new Error("رمز اللعبة غير صحيح.");
                if (doc.data().gamePhase === 'final_results') throw new Error("اللعبة قد انتهت.");
                gameId = code; userNickname = nickname; localStorage.setItem('playerNickname', nickname);
                isHost = doc.data().hostId === userId;
                await gameRef.collection('players').doc(userId).set({ nickname, score: 0, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), usedPointsBets: [] }, { merge: true });
                window.history.pushState({}, '', `${window.location.pathname}?gameId=${gameId}`);
                $('game-link-display').textContent = `رمز الغرفة: ${gameId}`; $('qrcode').style.display = 'none'; $('copy-link-button').style.display = 'none';
                listenToGameChanges(); listenToPlayers(); showScreen($('waiting-room-screen'));
            } catch (e) { exitGame(); showCustomMessageBox("خطأ", e.message); } finally { hideLoading(); }
        };
        const submitGuess = async () => {
            const input = $('game-guess-input'); if (input.disabled) return;
            const guess = input.value.trim(); if (guess === '') return showCustomMessageBox("خطأ", "الرجاء كتابة إجابتك.");
            if (userUsedPointsBets.includes(selectedPointsBet)) return showCustomMessageBox("خطأ", `لقد راهنت بهذه القيمة (${selectedPointsBet}) من قبل.`);
            showLoading();
            try {
                const playerRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId);
                await playerRef.update({ playerSubmittedAnswer: guess, playerSelectedPoints: selectedPointsBet, hasSubmittedAnswer: true, usedPointsBets: firebase.firestore.FieldValue.arrayUnion(selectedPointsBet) });
            } catch (e) { showCustomMessageBox("خطأ", "فشل إرسال الإجابة."); } finally { hideLoading(); }
        };

        // --- Firebase Listeners & Game State Machine ---
        const listenToGameChanges = () => {
            if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe();
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            gameSnapshotUnsubscribe = gameRef.onSnapshot((doc) => {
                if (!doc.exists) return exitGame();
                const gameData = doc.data(), phase = gameData.gamePhase;
                $('question-counter').textContent = `${phase === 'lobby' || phase === 'game_countdown' ? 0 : gameData.currentQuestionIndexInGame} / ${gameData.quizSet.length}`;
                clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval); soundStarted = false;
                
                if (phase === 'lobby') { showScreen($('waiting-room-screen')); userUsedPointsBets = []; populatePointsButtons(); }
                else if (phase === 'game_countdown') {
                    showScreen($('game-countdown-screen'));
                    let count = 5; $('countdown-timer-display').textContent = count;
                    timerInterval = setInterval(() => { count--; $('countdown-timer-display').textContent = count > 0 ? count : 'انطلق!'; if (count <= 0) clearInterval(timerInterval); }, 1000);
                }
                else if (phase === 'question_active') {
                    showScreen($('game-play-screen'));
                    $('game-category').textContent = gameData.currentCategory; $('game-question').textContent = gameData.currentQuestionText;
                    $('game-guess-input').disabled = false; $('game-guess-input').value = ''; $('submit-answer-button').disabled = false;
                    $('player-correct-guesses-list').innerHTML = ''; $('shared-round-guesses-list').innerHTML = '';
                    db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).doc(userId).get().then(pDoc => {
                        if(pDoc.exists) { userUsedPointsBets = pDoc.data().usedPointsBets || []; populatePointsButtons(); if (pDoc.data().hasSubmittedAnswer) { $('game-guess-input').disabled = true; $('submit-answer-button').disabled = true; $('points-button-group').querySelectorAll('button').forEach(b => b.disabled = true); } }
                    });
                    if (isHost) { $('host-gameplay-controls').classList.remove('hidden'); $('player-exit-button-gameplay').classList.add('hidden'); }
                    else { $('host-gameplay-controls').classList.add('hidden'); $('player-exit-button-gameplay').classList.remove('hidden'); }
                    timerInterval = setInterval(() => {
                        const remaining = Math.round(gameData.timeLimitPerQuestion - (Date.now() - gameData.questionStartTime.toMillis()) / 1000);
                        $('game-timer').textContent = Math.max(0, remaining);
                        if (remaining <= 5 && !soundStarted) { currentQuestionSoundInterval = setInterval(playTimerSound, 400); soundStarted = true; }
                        if (remaining <= 0) { clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval); if (isHost) gameRef.update({ gamePhase: 'question_results' }); }
                    }, 250);
                }
                else if (phase === 'question_results') {
                    showScreen($('question-results-screen'));
                    if (isHost && !gameData.scoresReconciledForCurrentQuestion) reconcileQuestionScores();
                    $('results-category').textContent = gameData.currentCategory;
                    $('results-question').textContent = gameData.currentQuestionText;
                    $('round-correct-answers-list').innerHTML = `<li><i class="fas fa-key text-yellow-500 mr-2"></i> ${gameData.currentDisplayAnswer}</li>`;
                    showQuestionPlayerScoresDetailed();
                    if (isHost) {
                        $('question-results-host-controls').classList.remove('hidden'); const isLastQ = gameData.currentQuestionIndexInGame >= gameData.quizSet.length;
                        $('next-question-button').classList.toggle('hidden', isLastQ); $('end-game-final-button').classList.toggle('hidden', !isLastQ);
                    } else $('player-exit-button-results').classList.remove('hidden');
                }
                else if (phase === 'final_results') showFinalScores();
            }, e => { console.error(e); exitGame(); });
        };
        const listenToPlayers = () => {
            if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe();
            const playersRef = db.collection(`artifacts/${appId}/public/data/games/${gameId}/players`).orderBy("joinedAt", "asc");
            playersSnapshotUnsubscribe = playersRef.onSnapshot((snapshot) => {
                $('joined-players-list').innerHTML = ''; if(isHost) $('host-submission-status-list').innerHTML = '';
                let allSubmitted = snapshot.size > 0;
                snapshot.forEach(doc => {
                    const pData = doc.data(), pId = doc.id, isCurrentUser = pId === userId;
                    const li = document.createElement('li');
                    li.innerHTML = `${pData.nickname} - النقاط: ${pData.score||0}${pId === userId && isHost ? ' <i class="fas fa-crown text-yellow-500"></i>' : ''}`;
                    $('joined-players-list').appendChild(li);
                    if (isHost) { const sItem = document.createElement('li'); sItem.innerHTML = `${pData.nickname}: ${pData.hasSubmittedAnswer ? '<i class="fas fa-check-circle text-green-500 ml-2"></i>' : '<i class="fas fa-hourglass-half text-gray-500 ml-2"></i>'}`; $('host-submission-status-list').appendChild(sItem); if (!pData.hasSubmittedAnswer) allSubmitted = false; }
                    if (isCurrentUser) { $('player-score').textContent = pData.score || 0; userUsedPointsBets = pData.usedPointsBets || []; }
                });
                if(isHost) { $('end-question-early-button').disabled = !allSubmitted; $('start-game-button').classList.toggle('hidden', snapshot.size < 1); }
            });
        };

        // --- Game Actions ---
        const reconcileQuestionScores = async () => {
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            try {
                await db.runTransaction(async t => {
                    const gameDoc = await t.get(gameRef);
                    if (!gameDoc.exists || gameDoc.data().scoresReconciledForCurrentQuestion) return;
                    const gameData = gameDoc.data(), correctAnswers = gameData.currentCorrectAnswers; let roundGuesses = [];
                    const playersSnap = await t.get(gameRef.collection('players'));
                    for (const pDoc of playersSnap.docs) {
                        const pData = pDoc.data(); let scoreChange = 0;
                        if (pData.hasSubmittedAnswer) { if (isCorrectAnswer(pData.playerSubmittedAnswer, correctAnswers)) { scoreChange = pData.playerSelectedPoints; if (!roundGuesses.some(g => normalize(g) === normalize(pData.playerSubmittedAnswer))) roundGuesses.push(pData.playerSubmittedAnswer); } else scoreChange = -pData.playerSelectedPoints; }
                        t.update(pDoc.ref, { score: (pData.score || 0) + scoreChange, playerScoreChange: scoreChange });
                    }
                    t.update(gameRef, { currentQuestionGuessedAnswers: roundGuesses, scoresReconciledForCurrentQuestion: true });
                });
            } catch (e) { console.error("Reconciliation failed:", e); }
        };
        const initiateGameStartCountdown = async () => {
            if (!isHost) return;
            const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
            await gameRef.update({ gamePhase: 'game_countdown' });
            setTimeout(async () => { const doc = await gameRef.get(); if (doc.exists && doc.data().gamePhase === 'game_countdown') startNextQuestion(); }, 5000);
        };
        const startNextQuestion = async () => {
            if (!isHost) return;
            showLoading();
            try {
                await db.runTransaction(async t => {
                    const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                    const doc = await t.get(gameRef); if (!doc.exists) return;
                    const data = doc.data(), nextIndex = data.currentQuestionIndexInGame;
                    if (nextIndex >= data.quizSet.length) return t.update(gameRef, { gamePhase: 'final_results' });
                    const nextQ = data.quizSet[nextIndex];
                    t.update(gameRef, { gamePhase: 'question_active', currentQuestionIndexInGame: nextIndex + 1, currentCategory: nextQ.category, currentQuestionText: nextQ.question, currentCorrectAnswers: nextQ.correctAnswers, currentDisplayAnswer: nextQ.displayAnswer, questionStartTime: firebase.firestore.FieldValue.serverTimestamp(), scoresReconciledForCurrentQuestion: false });
                    const pSnap = await t.get(gameRef.collection('players'));
                    pSnap.docs.forEach(p => t.update(p.ref, { hasSubmittedAnswer: false, playerScoreChange: 0 }));
                });
            } catch (e) { console.error(e); } finally { hideLoading(); }
        };
        const startNewRoundInSameRoom = async () => {
            if (!isHost) return;
            showLoading();
            try {
                const gameRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId);
                const doc = await gameRef.get(); if (!doc.exists) return; const data = doc.data();
                let allQuestions = []; data.selectedCategoryIndices.forEach(i => allQuestions.push(...quizzes[i].questions.map(q => ({...q, category: quizzes[i].category}))));
                for (let i = allQuestions.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]]; }
                const newQuizSet = allQuestions.slice(0, data.quizSet.length);
                const batch = db.batch();
                batch.update(gameRef, { gamePhase: 'lobby', quizSet: newQuizSet, currentQuestionIndexInGame: 0 });
                const pSnap = await gameRef.collection('players').get();
                pSnap.docs.forEach(p => batch.update(p.ref, { score: 0, usedPointsBets: [], hasSubmittedAnswer: false }));
                await batch.commit();
            } catch (e) { console.error(e); } finally { hideLoading(); }
        };
        const endGame = () => { if (isHost) db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).update({ gamePhase: 'final_results' }); };

        // --- Display Functions ---
        const showQuestionPlayerScoresDetailed = async () => {
            const list = $('question-player-scores-list'); list.innerHTML = '';
            const pRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).collection('players').orderBy("score", "desc");
            const pSnap = await pRef.get();
            pSnap.forEach((doc, i) => {
                const p = doc.data(), li = document.createElement('li'), scoreChange = p.playerScoreChange || 0;
                li.className = 'py-2 px-4 rounded-lg mb-2 bg-gray-50 flex justify-between items-center flex-wrap';
                li.innerHTML = `<div class="font-bold">${i+1}. ${p.nickname}</div> <div class="text-sm ${scoreChange > 0 ? 'text-green-600' : 'text-red-600'}">(${scoreChange >= 0 ? '+' : ''}${scoreChange})</div> <div class="w-full text-xs text-gray-500">إجابة: ${p.playerSubmittedAnswer || 'لم يجب'}</div> <div class="font-semibold">الإجمالي: ${p.score}</div>`;
                list.appendChild(li);
            });
        };
        const showFinalScores = async () => {
            showScreen($('game-end-screen')); exitGameListeners();
            $('final-scores-list').innerHTML = '';
            const pRef = db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).collection('players').orderBy("score", "desc");
            const pSnap = await pRef.get();
            let scores = []; pSnap.forEach(doc => scores.push(doc.data()));
            if(scores.length > 0) {
                $('end-message').textContent = `تهانينا للفائز ${scores[0].nickname}!`;
                scores.forEach((p, i) => { const li = document.createElement('li'); li.className = `py-2 px-4 rounded-lg mb-2 ${i === 0 ? 'bg-yellow-200 font-bold text-yellow-800' : 'bg-gray-50'}`; li.innerHTML = `${i===0 ? '<i class="fas fa-trophy text-yellow-600"></i> ': ''}المركز ${i + 1}: ${p.nickname} - ${p.score} نقطة`; $('final-scores-list').appendChild(li); });
            } else $('end-message').textContent = "انتهت اللعبة.";
            if(isHost) $('start-new-round-same-room-button').classList.remove('hidden');
        };
        const exitGameListeners = () => { if (gameSnapshotUnsubscribe) gameSnapshotUnsubscribe(); if (playersSnapshotUnsubscribe) playersSnapshotUnsubscribe(); clearInterval(timerInterval); clearInterval(currentQuestionSoundInterval); };
        
        // --- Initial Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { apiKey: "AIzaSyCwdZjTwrnjKZU_AilP5_GZJeEuUZjVcUY", authDomain: "ka3boura-dbcf5.firebaseapp.com", projectId: "ka3boura-dbcf5", storageBucket: "ka3boura-dbcf5.appspot.com", messagingSenderId: "1051115240747", appId: "1:1051115240747:web:694751eef3173327f5596e" };
            appId = firebaseConfig.projectId;
            try {
                app = firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth();
                auth.signInAnonymously().then(() => {
                    auth.onAuthStateChanged(user => {
                        if (user) { userId = user.uid; hideLoading(); const urlGameId = new URLSearchParams(window.location.search).get('gameId'); if (urlGameId) { $('game-code-input').value = urlGameId.toUpperCase(); const savedNick = localStorage.getItem('playerNickname') || ''; $('player-nickname-input').value = savedNick; if (savedNick) joinGame(urlGameId, savedNick); else showScreen($('join-game-screen')); } else showScreen($('role-selection-screen')); }
                    });
                }).catch(e => showCustomMessageBox("خطأ", `فشل تسجيل الدخول: ${e.message}`));
            } catch (e) { showCustomMessageBox("خطأ فادح", `فشل تهيئة Firebase: ${e.message}`); }

            // Attach all event listeners here
            $('create-host-button').addEventListener('click', () => { setupQuizCategorySelection(); $('host-nickname-input').value = localStorage.getItem('playerNickname') || ''; showScreen($('host-setup-screen')); });
            $('join-player-button').addEventListener('click', () => { $('player-nickname-input').value = localStorage.getItem('playerNickname') || ''; showScreen($('join-game-screen')); });
            $('create-game-button').addEventListener('click', createGame);
            $('submit-answer-button').addEventListener('click', submitGuess);
            $('start-game-button').addEventListener('click', initiateGameStartCountdown);
            $('end-question-early-button').addEventListener('click', () => { if(isHost) db.collection(`artifacts/${appId}/public/data/games`).doc(gameId).update({gamePhase: 'question_results'}); });
            $('next-question-button').addEventListener('click', startNextQuestion);
            $('end-game-final-button').addEventListener('click', endGame);
            $('start-new-round-same-room-button').addEventListener('click', startNewRoundInSameRoom);
            $('player-exit-button-gameplay').addEventListener('click', exitGame);
            $('player-exit-button-results').addEventListener('click', exitGame);
            $('join-room-button').addEventListener('click', () => joinGame($('game-code-input').value.trim().toUpperCase(), $('player-nickname-input').value.trim()));
            $('game-guess-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitGuess(); } });
            $('play-again-button').addEventListener('click', exitGame);
            $('quiz-category-input').addEventListener('click', () => $('quiz-category-dropdown').classList.toggle('hidden'));
            document.addEventListener('click', (e) => { const dropdown = $('quiz-category-dropdown'); if (!$('quiz-category-input').contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.add('hidden'); });
        });
    </script>
</body>
</html>
